<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfoTV Slideshow</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        .slideshow-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .slide {
            display: none;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        .slide.active {
            display: block;
        }
        iframe, img {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
        }
        /* Overlay stílusok */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Átlátszó fekete háttér */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Minden tartalom felett */
        }
        .overlay-image {
            max-width: 90%;
            max-height: 90%;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Overlay HTML -->
    <div id="overlay" class="overlay hidden">
        <img id="alertImage" src="" alt="Alert Image" class="overlay-image">
    </div>

    <!-- Diavetítés tartalma -->
    <div class="slideshow-container" id="slideshow-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, orderBy, doc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Firebase konfiguráció
        const firebaseConfig = {
            apiKey: "AIzaSyAmlb3HFiXq18IlV--o1GOC5yofXSZjV48",
            authDomain: "infotv-50232.firebaseapp.com",
            projectId: "infotv-50232",
            storageBucket: "infotv-50232.firebasestorage.app",
            messagingSenderId: "890415866941",
            appId: "1:890415866941:web:10606b06957eca86d43654",
            measurementId: "G-2V1HZ0RPJK"
        };

        // Firebase inicializálása
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Diavetítés változók
        let slides = [];
        let currentSlideIndex = 0;

        // Dátum formázása
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Diák betöltése
        function fetchSlides() {
            const slidesRef = collection(db, 'slides');
            const today = formatDate(new Date());
            const q = query(slidesRef, where('active', '==', true), where('startDate', '<=', today), where('endDate', '>=', today), orderBy("order", "asc"));

            onSnapshot(q, (querySnapshot) => {
                slides = [];
                querySnapshot.forEach((doc) => {
                    slides.push({ id: doc.id, ...doc.data() });
                });
                if (slides.length > 0) renderSlides();
            }, (error) => console.error('Hiba a diák betöltésekor:', error));
        }

        // Diák megjelenítése
        function renderSlides() {
            const container = document.getElementById('slideshow-container');
            container.innerHTML = '';
            slides.forEach((slide, index) => {
                const slideElement = document.createElement('div');
                slideElement.className = `slide ${index === currentSlideIndex ? 'active' : ''}`;
                slideElement.innerHTML = slide.type === 'image' ? `<img src="${slide.content}" alt="Slide">` : `<iframe src="${slide.content}"></iframe>`;
                container.appendChild(slideElement);
            });
        }

        // Következő dia
        function nextSlide() {
            if (slides.length > 0) {
                currentSlideIndex = (currentSlideIndex + 1) % slides.length;
                renderSlides();
            }
        }

        // Overlay tartalom betöltése
        function setupOverlay() {
            const overlay = document.getElementById('overlay');
            const alertImage = document.getElementById('alertImage');

            onSnapshot(doc(db, 'overlay', 'current'), (doc) => {
                const data = doc.data();
                if (data && data.active) {
                    if (data.type === 'image') {
                        alertImage.src = data.content;
                        overlay.classList.remove('hidden');
                    } else {
                        overlay.classList.add('hidden');
                    }
                } else {
                    overlay.classList.add('hidden');
                }
            });
        }

        // Indítás
        setInterval(nextSlide, 30000); // 30 másodpercenként vált
        setInterval(fetchSlides, 60000); // 1 percenként frissít
        fetchSlides();
        setupOverlay();
    </script>
</body>
</html>