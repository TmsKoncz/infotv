<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfoTV Admin </title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6;
            padding: 1rem;
        }
        
        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        
        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background-color: #3b82f6;
            color: white;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        
        .login-btn:hover {
            background-color: #2563eb;
        }
        
        .slide-item {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        
        @media (min-width: 640px) {
            .slide-item {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .drag-handle {
            cursor: grab;
            opacity: 0.5;
            padding: 0.5rem;
        }
        
        .drag-handle:hover {
            opacity: 1;
        }
        
        .preview-image {
            max-height: 100px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            border-radius: 0.25rem;
        }
        
        .date-range {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        @media (min-width: 640px) {
            .date-range {
                flex-direction: row;
            }
        }
        
        .sortable-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .notification {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            max-width: 400px;
            margin: 0 auto;
            background: #4CAF50;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .notification.hide {
            animation: slideOut 0.3s ease-in;
        }
        
        @keyframes slideOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Rich text editor styles */
        .rich-text-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .rich-text-toolbar button {
            padding: 0.25rem 0.5rem;
            background: #e2e8f0;
            border: 1px solid #cbd5e0;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .rich-text-toolbar button:hover {
            background: #cbd5e0;
        }
        
        .rich-text-content {
            min-height: 100px;
            border: 1px solid #cbd5e0;
            padding: 0.5rem;
            font-family: 'Jost', sans-serif;
            border-radius: 0.25rem;
            outline: none;
        }
        
        /* Character counter */
        .char-counter {
            text-align: right;
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .char-counter.warning {
            color: orange;
        }
        
        .char-counter.error {
            color: red;
        }
        
        /* Aktuális slide preview */
        .aktualis-preview {
            position: relative;
            width: 100%;
            height: 120px;
            background-size: cover;
            background-position: center;
            margin-bottom: 0.5rem;
        }
        
        .aktualis-text-preview {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 1.5rem;
            text-align: left;
            overflow: hidden;
        }
        
        /* Edit button styles */
        .edit-btn {
            background-color: #f6ad55;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        .edit-btn:hover {
            background-color: #ed8936;
        }
        
        /* Emergency slide form - removed date range */
        #emergency-slide-form .date-range {
            display: none;
        }
        
        /* Slide actions */
        .slide-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        @media (min-width: 640px) {
            .slide-actions {
                flex-direction: row;
                margin-top: 0;
                margin-left: auto;
            }
        }
        
        /* Form groups */
        .edit-form-group {
            margin-bottom: 1rem;
        }
        
        .edit-form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .edit-form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
        }
        
        /* Device status */
        .device-card {
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        /* Log entries */
        .log-entry {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Responsive grid */
        .responsive-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .responsive-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Full width buttons on mobile */
        .mobile-full-width {
            width: 100%;
        }
        
        @media (min-width: 640px) {
            .mobile-full-width {
                width: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Form -->
    <div id="login-form" class="login-container">
        <div class="login-form">
            <h2 class="text-2xl font-bold mb-4 text-center">InfoTV Admin Bejelentkezés</h2>
            <input type="email" id="email" placeholder="E-mail cím" class="login-input">
            <input type="password" id="password" placeholder="Jelszó" class="login-input">
            <button onclick="login()" class="login-btn">Bejelentkezés</button>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification hidden"></div>

    <!-- Confirmation Popup -->
    <div id="confirm-popup" class="popup hidden">
        <p id="confirm-message" class="mb-4"></p>
        <div class="flex flex-col sm:flex-row justify-end gap-3">
            <button onclick="confirmAction(false)" class="mobile-full-width px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Mégse</button>
            <button onclick="confirmAction(true)" class="mobile-full-width px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Igen</button>
        </div>
    </div>
    <div id="confirm-overlay" class="popup-overlay hidden"></div>

    <!-- Edit Slide Popup -->
<!-- Edit Slide Popup -->
<div id="edit-popup" class="popup hidden">
    <h3 class="text-xl font-bold mb-4">Dia szerkesztése</h3>
    <div class="edit-form-group">
        <label class="edit-form-label">Típus</label>
        <select id="edit-slide-type" class="edit-form-input" onchange="toggleEditSlideTypeFields()">
            <option value="image">Kép</option>
            <option value="embed">Beágyazott link</option>
            <option value="aktuális">Aktuális</option>
        </select>
    </div>
    <div class="edit-form-group" id="edit-url-group">
        <label class="edit-form-label">Kép URL</label>
        <input type="text" id="edit-slide-content" class="edit-form-input" placeholder="Kép URL">
    </div>
    <div class="edit-form-group">
        <label class="edit-form-label">Kezdő dátum</label>
        <input type="date" id="edit-start-date" class="edit-form-input">
    </div>
    <div class="edit-form-group">
        <label class="edit-form-label">Végdátum</label>
        <input type="date" id="edit-end-date" class="edit-form-input">
    </div>
        <div id="edit-text-content-group" class="edit-form-group hidden">
            <label class="edit-form-label">Első sor (max 20 karakter):</label>
            <div id="edit-first-line" contenteditable="true" class="edit-form-input" oninput="editUpdateFirstLineCounter()"></div>
            <div id="edit-first-line-counter" class="char-counter">0/20 karakter</div>
            
            <label class="edit-form-label mt-4">Szöveg (max 100 karakter):</label>
            <div class="rich-text-toolbar">
                <button type="button" onclick="editFormatText('bold')"><b>B</b></button>
                <button type="button" onclick="editFormatText('italic')"><i>I</i></button>
                <button type="button" onclick="editFormatText('underline')"><u>U</u></button>
                <button type="button" onclick="editFormatText('insertLineBreak')">↵</button>
            </div>
            <div id="edit-text-content" contenteditable="true" class="rich-text-content" oninput="editUpdateCharCounter()"></div>
            <div id="edit-char-counter" class="char-counter">0/100 karakter</div>
        </div>
        <div class="edit-form-group">
            <label class="edit-form-label">Megjegyzés</label>
            <textarea id="edit-comment" class="edit-form-input"></textarea>
        </div>
        <div class="flex flex-col sm:flex-row justify-end gap-3 mt-4">
            <button onclick="closeEditPopup()" class="mobile-full-width px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Mégse</button>
            <button onclick="saveEditedSlide()" class="mobile-full-width px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Mentés</button>
        </div>
    </div>

    <!-- Admin Content -->
    <div id="admin-content" class="hidden max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">InfoTV Admin</h1>
            <div class="flex flex-wrap gap-2 sm:gap-4">
                <a href="https://www.canva.com/design/DAGI4OevAdo/QiptmBWJUsqrn3_MJbQLww/edit" target="_blank" class="mobile-full-width sm:w-auto px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Sablonok</a>
                <a href="https://infotv.tmskoncz.hu" target="_blank" class="mobile-full-width sm:w-auto px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Élő oldal</a>
                <button onclick="logout()" class="mobile-full-width sm:w-auto px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Kijelentkezés</button>
            </div>
        </div>

        <!-- Device Status -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Eszközök állapota</h1>
            <div class="responsive-grid">
                <div class="device-card bg-white">
                    <h2 class="text-xl font-semibold mb-4">Online eszközök</h2>
                    <p class="text-4xl font-bold text-green-600" id="online-count">0</p>
                </div>
                <div class="device-card bg-white">
                    <h2 class="text-xl font-semibold mb-4">Eszközök listája</h2>
                    <div id="devices-list" class="overflow-y-auto max-h-48"></div>
                </div>
            </div>
        </div>

        <!-- Slide Management -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Hirdetéskezelés</h1>
            
            <!-- Add New Slide -->
            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleSlideForm()">
                    <h2 class="text-xl font-semibold">Új hirdetés hozzáadása</h2>
                    <span id="slide-form-toggle">▼</span>
                </div>
                <div id="slide-form" class="mt-4 hidden">
                    <select id="slide-type" class="w-full p-2 border rounded mb-4" onchange="toggleSlideTypeFields()">
                        <option value="image">Kép</option>
                        <option value="embed">Beágyazott link</option>
                        <option value="aktuális">Aktuális</option>
                    </select>
                    
                    <!-- Regular image/embed fields -->
                    <div id="regular-slide-fields">
                        <input type="text" id="slide-content" placeholder="Kép URL vagy beágyazott link" class="w-full p-2 border rounded mb-4">
                        <div class="date-range">
                            <input type="date" id="slide-start-date" class="w-full p-2 border rounded mb-4">
                            <input type="date" id="slide-end-date" class="w-full p-2 border rounded mb-4">
                        </div>
                        <textarea id="slide-comment" placeholder="Megjegyzés" class="w-full p-2 border rounded mb-4"></textarea>
                    </div>
                    
                    <!-- Aktuális slide fields -->
                    <div id="aktualis-slide-fields" class="hidden">
                        <input type="hidden" id="aktualis-preset-link" value="https://i.ibb.co/Hfkcjrct/aktu-lis-sablon-1.png">
                        
                        <div class="mb-4">
                            <label class="block mb-2">Első sor (max 20 karakter):</label>
                            <div id="first-line" contenteditable="true" class="w-full p-2 border rounded mb-1" oninput="updateFirstLineCounter()"></div>
                            <div id="first-line-counter" class="char-counter">0/20 karakter</div>
                            
                            <label class="block mb-2 mt-4">Szöveg (max 100 karakter):</label>
                            <div class="rich-text-toolbar">
                                <button type="button" onclick="formatText('bold')"><b>B</b></button>
                                <button type="button" onclick="formatText('italic')"><i>I</i></button>
                                <button type="button" onclick="formatText('underline')"><u>U</u></button>
                                <button type="button" onclick="formatText('insertLineBreak')">↵</button>
                            </div>
                            <div id="slide-text-content" contenteditable="true" class="rich-text-content" 
                                 oninput="updateCharCounter()"></div>
                            <div id="char-counter" class="char-counter">0/100 karakter</div>
                        </div>
                        <div class="date-range">
                            <input type="date" id="aktualis-start-date" class="w-full p-2 border rounded mb-4">
                            <input type="date" id="aktualis-end-date" class="w-full p-2 border rounded mb-4">
                        </div>
                        <textarea id="aktualis-comment" placeholder="Megjegyzés" class="w-full p-2 border rounded mb-4"></textarea>
                    </div>
                    
                    <button onclick="addSlide()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Hirdetés hozzáadása</button>
                </div>
            </div>

<!-- In the Slides List section -->
<div class="bg-white p-6 rounded-lg shadow">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Hirdetések listája</h2>
        <button id="reorder-btn" onclick="toggleReorderMode()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
            Átrendezés mód
        </button>
    </div>
    <div id="slides-container" class="sortable-list"></div>
    <div id="reorder-controls" class="hidden mt-4 flex justify-end gap-2">
        <button onclick="cancelReorder()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Mégse</button>
        <button onclick="saveReorder()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Mentés</button>
    </div>
</div>

        <!-- Pinned Slides -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Rögzített diák</h1>
            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <h2 class="text-xl font-semibold mb-4">Rögzített dia beállítása</h2>
                <div class="space-y-4">
                    <select id="device-select" class="w-full p-2 border rounded">
                        <option value="">Válassz eszközt</option>
                    </select>
                    <select id="pinned-slide-select" class="w-full p-2 border rounded">
                        <option value="">Válassz diát</option>
                    </select>
                    <button onclick="pinSlideToDevice()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Rögzítés</button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <h2 class="text-xl font-semibold mb-4">Rögzített diák listája</h2>
                <div id="pinned-slides-list" class="sortable-list"></div>
            </div>
        </div>

        <!-- Emergency Mode -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Havária</h1>
            
            <!-- Add Emergency Slide -->
            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleEmergencyForm()">
                    <h2 class="text-xl font-semibold">Új havária hozzáadása</h2>
                    <span id="emergency-form-toggle">▼</span>
                </div>
                <div id="emergency-slide-form" class="mt-4 hidden">
                    <select id="emergency-slide-type" class="w-full p-2 border rounded mb-4">
                        <option value="image">Kép</option>
                        <option value="embed">Beágyazott link</option>
                    </select>
                    <input type="text" id="emergency-slide-content" placeholder="Kép URL vagy beágyazott link" class="w-full p-2 border rounded mb-4">
                    <textarea id="emergency-slide-comment" placeholder="Megjegyzés" class="w-full p-2 border rounded mb-4"></textarea>
                    <button onclick="addEmergencySlide()" class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600">Havária hozzáadása</button>
                </div>
            </div>

            <!-- Emergency Slides List -->
            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <h2 class="text-xl font-semibold mb-4">Haváriák listája</h2>
                <div id="emergency-slides-container" class="sortable-list"></div>
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Hibaelhárítás</h1>
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Hibaelhárítási eszközök</h2>
                <div class="space-y-4">
                    <button onclick="refreshAllDevices()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                        Összes eszköz oldalának frissítése
                    </button>
                    <button onclick="toggleLogCard()" class="w-full bg-gray-500 text-white p-2 rounded hover:bg-gray-600">
                        Naplók megtekintése
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs Card -->
        <div id="log-card" class="bg-white p-6 rounded-lg shadow mt-8 hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                <h2 class="text-xl font-semibold">Naplóbejegyzések</h2>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="refreshLogs()" class="mobile-full-width bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                        Frissítés
                    </button>
                    <button onclick="toggleLogCard()" class="mobile-full-width bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
                        Bezárás
                    </button>
                </div>
            </div>
            <div id="log-entries" class="overflow-y-auto max-h-96 border rounded p-2 bg-gray-50"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, getDoc, setDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAmlb3HFiXq18IlV--o1GOC5yofXSZjV48",
            authDomain: "infotv-50232.firebaseapp.com",
            projectId: "infotv-50232",
            storageBucket: "infotv-50232.appspot.com",
            messagingSenderId: "890415866941",
            appId: "1:890415866941:web:10606b06957eca86d43654",
            measurementId: "G-2V1HZ0RPJK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // UI elements
        const loginForm = document.getElementById('login-form');
        const adminContent = document.getElementById('admin-content');
        let currentEditingSlideId = null;
        let currentEditingSlideType = null;

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginForm.style.display = 'none';
                adminContent.style.display = 'block';
                renderSlides();
                renderEmergencySlides();
                monitorDevices();
                fetchLogs();
                loadDevices();
                loadSlides();
                renderPinnedSlides();
            } else {
                loginForm.style.display = 'flex';
                adminContent.style.display = 'none';
            }
        });

        // Login function
        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await addDoc(collection(db, 'logs'), {
                    eventType: "Bejelentkezés",
                    details: "Sikeres bejelentkezés",
                    user: userCredential.user.email,
                    timestamp: serverTimestamp()
                });
                showNotification('Sikeres bejelentkezés!');
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Hibás e-mail vagy jelszó!');
            }
        };

        // Logout function
        window.logout = async function() {
            try {
                if (auth.currentUser) {
                    await addDoc(collection(db, 'logs'), {
                        eventType: "Kijelentkezés",
                        details: "Felhasználó kijelentkezett",
                        user: auth.currentUser.email,
                        timestamp: serverTimestamp()
                    });
                }
                await signOut(auth);
                showNotification('Sikeres kijelentkezés!');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Hiba történt a kijelentkezés során!');
            }
        };

        // Toggle log card visibility
        window.toggleLogCard = function() {
            const logCard = document.getElementById('log-card');
            if (logCard.classList.contains('hidden')) {
                logCard.classList.remove('hidden');
                fetchLogs();
            } else {
                logCard.classList.add('hidden');
            }
        };

        // Fetch and display logs (sorted by timestamp)
        async function fetchLogs() {
            try {
                showLogLoading(true);
                const logsRef = collection(db, 'logs');
                const q = query(logsRef, orderBy("timestamp", "desc")); // Sort by timestamp descending
                const querySnapshot = await getDocs(q);
                
                const logEntries = [];
                querySnapshot.forEach((doc) => {
                    const logData = doc.data();
                    const timestamp = logData.timestamp?.toDate() || new Date();
                    
                    logEntries.push(`
                        <div class="log-entry">
                            <div class="flex flex-col sm:flex-row justify-between items-start gap-1">
                                <div class="flex-1">
                                    <p class="font-semibold">${timestamp.toLocaleString('hu-HU')}</p>
                                    <p class="text-gray-700">${logData.eventType || 'Ismeretlen esemény'}</p>
                                    <p class="text-sm text-gray-600">${logData.details || 'Nincs részlet'}</p>
                                </div>
                                <span class="text-xs text-gray-500">${logData.user || 'Ismeretlen felhasználó'}</span>
                            </div>
                        </div>
                    `);
                });
                
                document.getElementById('log-entries').innerHTML = logEntries.join('');
                showLogLoading(false);
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('log-entries').innerHTML = `
                    <div class="p-3 text-red-500">
                        Hiba történt a naplók betöltésekor. Próbáld újra később.
                    </div>
                `;
                showLogLoading(false);
            }
        }

        // Show loading indicator for logs
        function showLogLoading(show) {
            const logEntries = document.getElementById('log-entries');
            if (show) {
                logEntries.innerHTML = `
                    <div class="p-3 text-center text-gray-500">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-2"></div>
                        <p>Naplóbejegyzések betöltése...</p>
                    </div>
                `;
            }
        }

        // Refresh logs
        window.refreshLogs = async function() {
            await fetchLogs();
            showNotification('Naplók frissítve!');
        };

        // Toggle between slide type fields
        window.toggleSlideTypeFields = function() {
            const slideType = document.getElementById('slide-type').value;
            const regularFields = document.getElementById('regular-slide-fields');
            const aktualisFields = document.getElementById('aktualis-slide-fields');
            
            if (slideType === 'aktuális') {
                regularFields.classList.add('hidden');
                aktualisFields.classList.remove('hidden');
            } else {
                regularFields.classList.remove('hidden');
                aktualisFields.classList.add('hidden');
            }
        };

        // Rich text formatting for Aktuális slides
        window.formatText = function(command) {
            const textField = document.getElementById('slide-text-content');
            document.execCommand(command, false, null);
            textField.focus();
            updateCharCounter();
        };

        // Rich text formatting for Edit popup
        window.editFormatText = function(command) {
            const textField = document.getElementById('edit-text-content');
            document.execCommand(command, false, null);
            textField.focus();
            editUpdateCharCounter();
        };

        // Character counter for first line
        window.updateFirstLineCounter = function() {
            const firstLine = document.getElementById('first-line');
            const counter = document.getElementById('first-line-counter');
            const text = firstLine.innerText;
            const charCount = text.length;
            
            counter.textContent = `${charCount}/20 karakter`;
            counter.className = 'char-counter';
            
            if (charCount > 15 && charCount <= 20) {
                counter.classList.add('warning');
            } else if (charCount > 20) {
                counter.classList.add('error');
            }
        };

        // Character counter for first line in edit popup
        window.editUpdateFirstLineCounter = function() {
            const firstLine = document.getElementById('edit-first-line');
            const counter = document.getElementById('edit-first-line-counter');
            const text = firstLine.innerText;
            const charCount = text.length;
            
            counter.textContent = `${charCount}/20 karakter`;
            counter.className = 'char-counter';
            
            if (charCount > 15 && charCount <= 20) {
                counter.classList.add('warning');
            } else if (charCount > 20) {
                counter.classList.add('error');
            }
        };

        // Character counter for Aktuális slides
        window.updateCharCounter = function() {
            const textContent = document.getElementById('slide-text-content');
            const counter = document.getElementById('char-counter');
            const text = textContent.innerText;
            const charCount = text.length;
            
            counter.textContent = `${charCount}/100 karakter`;
            counter.className = 'char-counter';
            
            if (charCount > 80 && charCount <= 100) {
                counter.classList.add('warning');
            } else if (charCount > 100) {
                counter.classList.add('error');
            }
        };

        // Character counter for Edit popup
        window.editUpdateCharCounter = function() {
            const textContent = document.getElementById('edit-text-content');
            const counter = document.getElementById('edit-char-counter');
            const text = textContent.innerText;
            const charCount = text.length;
            
            counter.textContent = `${charCount}/100 karakter`;
            counter.className = 'char-counter';
            
            if (charCount > 80 && charCount <= 100) {
                counter.classList.add('warning');
            } else if (charCount > 100) {
                counter.classList.add('error');
            }
        };

        // Add new slide
        window.addSlide = async function() {
            if (!auth.currentUser) {
                showNotification('Kérlek, jelentkezz be!');
                return;
            }

            const type = document.getElementById('slide-type').value;
            let content, startDate, endDate, comment;

            if (type === 'aktuális') {
                const firstLine = document.getElementById('first-line').innerText;
                const textContent = document.getElementById('slide-text-content').innerText;
                
                if (firstLine.length > 20) {
                    showNotification('Az aktuális dia első sora maximum 20 karakter lehet!');
                    return;
                }
                
                if (textContent.length > 100) {
                    showNotification('Az aktuális dia szövege maximum 100 karakter lehet!');
                    return;
                }
                
                content = {
                    presetLink: document.getElementById('aktualis-preset-link').value,
                    firstLine: document.getElementById('first-line').innerHTML,
                    text: document.getElementById('slide-text-content').innerHTML,
                    style: {
                        fontFamily: "'Jost', sans-serif",
                        fontSize: "3rem",
                        textAlign: "left",
                        display: "flex",
                        flexDirection: "column",
                        justifyContent: "center",
                        alignItems: "center",
                        height: "100%",
                        padding: "2rem",
                        color: "#ffffff",
                        textShadow: "2px 2px 4px rgba(0, 0, 0, 0.5)"
                    }
                };
                startDate = document.getElementById('aktualis-start-date').value;
                endDate = document.getElementById('aktualis-end-date').value;
                comment = document.getElementById('aktualis-comment').value;
            } else {
                content = document.getElementById('slide-content').value;
                startDate = document.getElementById('slide-start-date').value;
                endDate = document.getElementById('slide-end-date').value;
                comment = document.getElementById('slide-comment').value;
            }

            if (!startDate || !endDate) {
                showNotification('Kezdő és végdátum megadása kötelező!');
                return;
            }

            try {
                await addDoc(collection(db, 'logs'), {
                    eventType: "Dia létrehozás",
                    details: `Új dia hozzáadva (típus: ${type})`,
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                const slideData = {
                    type,
                    content: type === 'aktuális' ? JSON.stringify(content) : content,
                    startDate,
                    endDate,
                    comment,
                    active: true,
                    order: (await getDocs(collection(db, 'slides'))).size,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'slides'), slideData);
                showNotification('Hirdetés hozzáadva!');
                
                // Reset form fields
                if (type === 'aktuális') {
                    document.getElementById('first-line').innerHTML = '';
                    document.getElementById('slide-text-content').innerHTML = '';
                    document.getElementById('aktualis-comment').value = '';
                    document.getElementById('aktualis-start-date').value = '';
                    document.getElementById('aktualis-end-date').value = '';
                    updateFirstLineCounter();
                    updateCharCounter();
                } else {
                    document.getElementById('slide-content').value = '';
                    document.getElementById('slide-comment').value = '';
                    document.getElementById('slide-start-date').value = '';
                    document.getElementById('slide-end-date').value = '';
                }
                
                renderSlides();
            } catch (error) {
                console.error('Error adding slide:', error);
                showNotification('Hiba történt a hirdetés hozzáadásakor!');
            }
        };

        // Add emergency slide (without date range)
        window.addEmergencySlide = async function() {
            if (!auth.currentUser) {
                showNotification('Kérlek, jelentkezz be!');
                return;
            }

            const type = document.getElementById('emergency-slide-type').value;
            const content = document.getElementById('emergency-slide-content').value;
            const comment = document.getElementById('emergency-slide-comment').value;

            if (!type || !content) {
                showNotification('Minden mezőt ki kell tölteni!');
                return;
            }

            try {
                // Log the emergency slide creation
                await addDoc(collection(db, 'logs'), {
                    eventType: "Havária dia létrehozás",
                    details: `Új havária dia hozzáadva (típus: ${type})`,
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                // Deactivate all other emergencies
                const emergencies = await getDocs(collection(db, 'emergency_slides'));
                const deactivationPromises = [];
                emergencies.forEach(doc => {
                    deactivationPromises.push(updateDoc(doc.ref, { active: false }));
                });
                await Promise.all(deactivationPromises);

                // Add new emergency (without date range)
                await addDoc(collection(db, 'emergency_slides'), {
                    type,
                    content,
                    comment,
                    active: true,
                    order: 0,
                    emergency: true,
                    createdAt: serverTimestamp()
                });

                showNotification('Havária hozzáadva!');
                renderEmergencySlides();
            } catch (error) {
                console.error('Error adding emergency slide:', error);
                showNotification('Hiba történt a havária hozzáadásakor!');
            }
        };
        // Reorder slides
        let originalSlideOrder = [];
let sortableInstance = null;

window.toggleReorderMode = function() {
    const reorderBtn = document.getElementById('reorder-btn');
    const reorderControls = document.getElementById('reorder-controls');
    const container = document.getElementById('slides-container');
    
    if (reorderBtn.textContent.includes('Átrendezés mód')) {
        // Enter reorder mode
        reorderBtn.textContent = 'Kilépés az átrendezésből';
        reorderBtn.classList.remove('bg-purple-500');
        reorderBtn.classList.add('bg-yellow-500');
        reorderControls.classList.remove('hidden');
        
        // Store original order
        originalSlideOrder = Array.from(container.children).map(el => el.getAttribute('data-id'));
        
        // Initialize Sortable if not already done
        if (!sortableInstance) {
            sortableInstance = Sortable.create(container, {
                handle: '.drag-handle',
                animation: 150,
                onStart: () => {
                    // Disable all buttons during drag
                    document.querySelectorAll('.slide-actions button').forEach(btn => {
                        btn.disabled = true;
                    });
                },
                onEnd: () => {
                    // Re-enable buttons after drag
                    document.querySelectorAll('.slide-actions button').forEach(btn => {
                        btn.disabled = false;
                    });
                }
            });
        }
        
        // Show all drag handles
        document.querySelectorAll('.drag-handle').forEach(handle => {
            handle.style.opacity = '1';
            handle.style.cursor = 'grab';
        });
        
        // Hide action buttons during reorder
        document.querySelectorAll('.slide-actions').forEach(actions => {
            actions.style.display = 'none';
        });
    } else {
        // Exit reorder mode without saving
        cancelReorder();
    }
};

window.cancelReorder = function() {
    const reorderBtn = document.getElementById('reorder-btn');
    const reorderControls = document.getElementById('reorder-controls');
    const container = document.getElementById('slides-container');
    
    // Reset button and controls
    reorderBtn.textContent = 'Átrendezés mód';
    reorderBtn.classList.remove('bg-yellow-500');
    reorderBtn.classList.add('bg-purple-500');
    reorderControls.classList.add('hidden');
    
    // Restore original order
    if (originalSlideOrder.length > 0) {
        const slides = Array.from(container.children);
        originalSlideOrder.forEach((id, index) => {
            const slide = slides.find(el => el.getAttribute('data-id') === id);
            if (slide) {
                container.appendChild(slide);
            }
        });
    }
    
    // Hide drag handles
    document.querySelectorAll('.drag-handle').forEach(handle => {
        handle.style.opacity = '0.5';
    });
    
    // Show action buttons
    document.querySelectorAll('.slide-actions').forEach(actions => {
        actions.style.display = 'flex';
    });
};

window.saveReorder = async function() {
    const container = document.getElementById('slides-container');
    const slides = Array.from(container.children);
    
    try {
        const updates = slides.map((slide, index) => {
            const slideId = slide.getAttribute('data-id');
            return updateDoc(doc(db, 'slides', slideId), { order: index });
        });
        
        await Promise.all(updates);
        
        // Exit reorder mode
        const reorderBtn = document.getElementById('reorder-btn');
        const reorderControls = document.getElementById('reorder-controls');
        
        reorderBtn.textContent = 'Átrendezés mód';
        reorderBtn.classList.remove('bg-yellow-500');
        reorderBtn.classList.add('bg-purple-500');
        reorderControls.classList.add('hidden');
        
        // Hide drag handles
        document.querySelectorAll('.drag-handle').forEach(handle => {
            handle.style.opacity = '0.5';
        });
        
        // Show action buttons
        document.querySelectorAll('.slide-actions').forEach(actions => {
            actions.style.display = 'flex';
        });
        
        showNotification('Diák sorrendje frissítve!');
    } catch (error) {
        console.error('Error saving slide order:', error);
        showNotification('Hiba történt a sorrend mentésekor!');
    }
};
        
        // Render slides with modified preview
async function renderSlides() {
    const container = document.getElementById('slides-container');
    container.innerHTML = '';

    try {
        const querySnapshot = await getDocs(collection(db, 'slides'));
        const slidesArray = [];
        querySnapshot.forEach((doc) => {
            slidesArray.push({ id: doc.id, ...doc.data() });
        });
        slidesArray.sort((a, b) => a.order - b.order);

        slidesArray.forEach((slide) => {
            let contentPreview = '';
            if (slide.type === 'image') {
                contentPreview = `<img src="${slide.content}" alt="Slide Image" class="preview-image">`;
            } else if (slide.type === 'aktuális') {
                try {
                    const contentObj = JSON.parse(slide.content);
                    contentPreview = `
                        <div class="slide-preview-container">
                            <div class="text-gray-500">Aktuális dia</div>
                            <div class="font-bold">${contentObj.firstLine ? contentObj.firstLine.substring(0, 20) : ''}</div>
                            <div class="slide-preview-text">
                                ${contentObj.text ? contentObj.text.substring(0, 50) + (contentObj.text.length > 50 ? '...' : '') : 'Nincs szöveg'}
                            </div>
                        </div>
                    `;
                } catch (e) {
                    contentPreview = '<div class="text-gray-500">Aktuális dia</div>';
                }
            } else {
                contentPreview = `<div class="text-gray-500">Beágyazott tartalom</div>`;
            }

            const slideElement = document.createElement('div');
            slideElement.className = `slide-item ${slide.active ? 'border-l-4 border-blue-500' : 'border-l-4 border-gray-300'}`;
            slideElement.setAttribute('data-id', slide.id);
            slideElement.innerHTML = `
                <div class="drag-handle">&#9776;</div>
                <div class="flex-1">
                    <div class="flex flex-col sm:flex-row gap-4">
                        ${contentPreview}
                        <div>
                            <strong>${slide.type === 'image' ? 'Kép' : slide.type === 'aktuális' ? 'Aktuális' : 'Beágyazott link'}</strong>
                            <br>
                            <small>${slide.startDate} - ${slide.endDate}</small>
                            <br>
                            <small>Megjegyzés: ${slide.comment || 'Nincs megjegyzés'}</small>
                        </div>
                    </div>
                </div>
                <div class="slide-actions">
                    <button onclick="editSlide('${slide.id}')" class="edit-btn">Szerkesztés</button>
                    <button onclick="toggleSlide('${slide.id}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">${slide.active ? 'Elrejtés' : 'Megjelenítés'}</button>
                    <button onclick="deleteSlide('${slide.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Törlés</button>
                </div>
            `;
            container.appendChild(slideElement);
        });

        // Hide drag handles by default
        document.querySelectorAll('.drag-handle').forEach(handle => {
            handle.style.opacity = '0.5';
        });
    } catch (error) {
        console.error('Error loading slides:', error);
        showNotification('Hiba történt a diák betöltésekor!');
    }
}

        // Render emergency slides
        async function renderEmergencySlides() {
            const container = document.getElementById('emergency-slides-container');
            container.innerHTML = '';

            try {
                const querySnapshot = await getDocs(collection(db, 'emergency_slides'));
                const slidesArray = [];
                querySnapshot.forEach((doc) => {
                    slidesArray.push({ id: doc.id, ...doc.data() });
                });

                slidesArray.forEach((slide) => {
                    const slideElement = document.createElement('div');
                    slideElement.className = `slide-item ${slide.active ? 'border-l-4 border-red-500' : 'border-l-4 border-gray-300'}`;
                    slideElement.setAttribute('data-id', slide.id);
                    slideElement.innerHTML = `
                        <div class="flex-1">
                            <div class="flex flex-col sm:flex-row gap-4">
                                ${slide.type === 'image' ? `<img src="${slide.content}" alt="Havária kép" class="preview-image">` : ''}
                                <div>
                                    <strong>HAVÁRIA - ${slide.type === 'image' ? 'Kép' : 'Beágyazott link'}</strong>
                                    <br>
                                    <small>Megjegyzés: ${slide.comment || 'Nincs megjegyzés'}</small>
                                </div>
                            </div>
                        </div>
                        <div class="slide-actions">
                            <button onclick="editEmergencySlide('${slide.id}')" class="edit-btn">Szerkesztés</button>
                            <button onclick="toggleEmergency('${slide.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">${slide.active ? 'Deaktiválás' : 'Aktiválás'}</button>
                            <button onclick="deleteEmergency('${slide.id}')" class="bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">Törlés</button>
                        </div>
                    `;
                    container.appendChild(slideElement);
                });
            } catch (error) {
                console.error('Error loading emergency slides:', error);
            }
        }

        // Edit slide function
window.editSlide = async function(id) {
    try {
        const slideRef = doc(db, 'slides', id);
        const slideDoc = await getDoc(slideRef);
        
        if (slideDoc.exists()) {
            const slideData = slideDoc.data();
            currentEditingSlideId = id;
            currentEditingSlideType = slideData.type;
            
            // Set slide type
            document.getElementById('edit-slide-type').value = slideData.type;
            
            // Fill URL field for image/embed slides
            if (slideData.type !== 'aktuális') {
                document.getElementById('edit-slide-content').value = slideData.content;
            }
            
            // Fill other fields
            document.getElementById('edit-start-date').value = slideData.startDate;
            document.getElementById('edit-end-date').value = slideData.endDate;
            document.getElementById('edit-comment').value = slideData.comment || '';
            
            // Handle Aktuális slide text content
            const textContentGroup = document.getElementById('edit-text-content-group');
            const firstLine = document.getElementById('edit-first-line');
            const textContent = document.getElementById('edit-text-content');
            const firstLineCounter = document.getElementById('edit-first-line-counter');
            const charCounter = document.getElementById('edit-char-counter');
            
            if (slideData.type === 'aktuális') {
                try {
                    const contentObj = JSON.parse(slideData.content);
                    firstLine.innerHTML = contentObj.firstLine || '';
                    textContent.innerHTML = contentObj.text || '';
                    const firstLineCount = firstLine.innerText.length;
                    const charCount = textContent.innerText.length;
                    firstLineCounter.textContent = `${firstLineCount}/20 karakter`;
                    charCounter.textContent = `${charCount}/100 karakter`;
                    textContentGroup.classList.remove('hidden');
                } catch (e) {
                    firstLine.innerHTML = '';
                    textContent.innerHTML = '';
                    firstLineCounter.textContent = '0/20 karakter';
                    charCounter.textContent = '0/100 karakter';
                    textContentGroup.classList.remove('hidden');
                }
            } else {
                textContentGroup.classList.add('hidden');
            }
            
            // Show edit popup
            document.getElementById('edit-popup').classList.remove('hidden');
            document.getElementById('confirm-overlay').classList.remove('hidden');
            
            // Toggle fields based on type
            toggleEditSlideTypeFields();
        }
    } catch (error) {
        console.error('Error preparing slide edit:', error);
        showNotification('Hiba történt a dia szerkesztésének előkészítésekor!');
    }
};

        // Edit emergency slide function
        window.editEmergencySlide = async function(id) {
            try {
                const slideRef = doc(db, 'emergency_slides', id);
                const slideDoc = await getDoc(slideRef);
                
                if (slideDoc.exists()) {
                    const slideData = slideDoc.data();
                    currentEditingSlideId = id;
                    currentEditingSlideType = 'emergency';
                    
                    // Fill edit form (emergency slides don't have date range)
                    document.getElementById('edit-comment').value = slideData.comment || '';
                    
                    // Hide date fields and text content for emergency slides
                    document.getElementById('edit-start-date').closest('.edit-form-group').style.display = 'none';
                    document.getElementById('edit-end-date').closest('.edit-form-group').style.display = 'none';
                    document.getElementById('edit-text-content-group').classList.add('hidden');
                    
                    // Show edit popup
                    document.getElementById('edit-popup').classList.remove('hidden');
                    document.getElementById('confirm-overlay').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error preparing emergency slide edit:', error);
                showNotification('Hiba történt a havária szerkesztésének előkészítésekor!');
            }
        };

        // Close edit popup
window.closeEditPopup = function() {
    document.getElementById('edit-popup').classList.add('hidden');
    document.getElementById('confirm-overlay').classList.add('hidden');
    // Reset fields
    document.getElementById('edit-slide-content').value = '';
    document.getElementById('edit-slide-type').value = 'image';
    document.getElementById('edit-start-date').closest('.edit-form-group').style.display = 'block';
    document.getElementById('edit-end-date').closest('.edit-form-group').style.display = 'block';
    document.getElementById('edit-text-content-group').classList.add('hidden');
    currentEditingSlideId = null;
    currentEditingSlideType = null;
};

        // Save edited slide
window.saveEditedSlide = async function() {
    if (!currentEditingSlideId) return;
    
    try {
        const type = document.getElementById('edit-slide-type').value;
        const startDate = document.getElementById('edit-start-date').value;
        const endDate = document.getElementById('edit-end-date').value;
        const comment = document.getElementById('edit-comment').value;
        
        // Determine if it's a regular slide or emergency slide
        const isEmergency = currentEditingSlideType === 'emergency';
        
        if (isEmergency) {
            // Update emergency slide (only comment)
            await updateDoc(doc(db, 'emergency_slides', currentEditingSlideId), {
                comment
            });
        } else {
            // Update regular slide
            if (!startDate || !endDate) {
                showNotification('Kezdő és végdátum megadása kötelező!');
                return;
            }
            
            let updateData = {
                type,
                startDate,
                endDate,
                comment
            };
            
            // Handle content based on type
            if (type === 'aktuális') {
                const firstLine = document.getElementById('edit-first-line').innerText;
                const textContent = document.getElementById('edit-text-content').innerHTML;
                const textContentText = document.getElementById('edit-text-content').innerText;
                
                if (firstLine.length > 20) {
                    showNotification('Az aktuális dia első sora maximum 20 karakter lehet!');
                    return;
                }
                
                if (textContentText.length > 100) {
                    showNotification('Az aktuális dia szövege maximum 100 karakter lehet!');
                    return;
                }
                
                const contentObj = {
                    presetLink: "https://i.ibb.co/Hfkcjrct/aktu-lis-sablon-1.png",
                    firstLine: document.getElementById('edit-first-line').innerHTML,
                    text: textContent,
                    style: {
                        fontFamily: "'Jost', sans-serif",
                        fontSize: "3rem",
                        textAlign: "left",
                        display: "flex",
                        flexDirection: "column",
                        justifyContent: "center",
                        alignItems: "center",
                        height: "100%",
                        padding: "2rem",
                        color: "#ffffff",
                        textShadow: "2px 2px 4px rgba(0, 0, 0, 0.5)"
                    }
                };
                
                updateData.content = JSON.stringify(contentObj);
            } else {
                // For image/embed slides
                const content = document.getElementById('edit-slide-content').value;
                if (!content) {
                    showNotification('Kép URL vagy beágyazott link megadása kötelező!');
                    return;
                }
                updateData.content = content;
            }
            
            await updateDoc(doc(db, 'slides', currentEditingSlideId), updateData);
        }
        
        showNotification('Dia frissítve!');
        closeEditPopup();
        
        // Refresh the appropriate list
        if (isEmergency) {
            renderEmergencySlides();
        } else {
            renderSlides();
        }
    } catch (error) {
        console.error('Error saving edited slide:', error);
        showNotification('Hiba történt a dia mentésekor!');
    }
};

        // Toggle slide active status
        window.toggleSlide = async function(id) {
            if (!auth.currentUser) {
                showNotification('Kérlek, jelentkezz be!');
                return;
            }

            try {
                const slideRef = doc(db, 'slides', id);
                const slideDoc = await getDoc(slideRef);
                const currentActiveStatus = slideDoc.data().active;
                
                await addDoc(collection(db, 'logs'), {
                    eventType: "Dia állapot változás",
                    details: `Dia ${currentActiveStatus ? 'elrejtve' : 'megjelenítve'} (ID: ${id})`,
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                await updateDoc(slideRef, { active: !currentActiveStatus });
                showNotification(`Hirdetés ${currentActiveStatus ? 'elrejtve' : 'megjelenítve'}!`);
                renderSlides();
            } catch (error) {
                console.error('Error toggling slide status:', error);
                showNotification('Hiba történt a dia állapotának váltásakor!');
            }
        };

        // Pin slide to device
        window.pinSlideToDevice = async function() {
            const deviceId = document.getElementById('device-select').value;
            const slideId = document.getElementById('pinned-slide-select').value;

            if (!deviceId || !slideId) {
                showNotification('Válassz eszközt és diát!');
                return;
            }

            try {
                await addDoc(collection(db, 'logs'), {
                    eventType: "Dia rögzítés",
                    details: `Dia rögzítve az eszközhöz (Eszköz: ${deviceId}, Dia: ${slideId})`,
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                const deviceRef = doc(db, 'devices', deviceId);
                await updateDoc(deviceRef, { pinnedSlideId: slideId });
                showNotification('Rögzített dia hozzáadva!');
                renderPinnedSlides();
            } catch (error) {
                console.error('Error pinning slide:', error);
                showNotification('Hiba történt a rögzített dia hozzáadásakor!');
            }
        };
        
        // Render pinned slides
        async function renderPinnedSlides() {
            const container = document.getElementById('pinned-slides-list');
            container.innerHTML = '';

            try {
                const devicesRef = collection(db, 'devices');
                const devicesSnapshot = await getDocs(devicesRef);
                const slidesRef = collection(db, 'slides');
                const slidesSnapshot = await getDocs(slidesRef);

                devicesSnapshot.forEach((deviceDoc) => {
                    const deviceData = deviceDoc.data();
                    const pinnedSlideId = deviceData.pinnedSlideId;

                    if (pinnedSlideId) {
                        const slideDoc = slidesSnapshot.docs.find(doc => doc.id === pinnedSlideId);
                        if (slideDoc) {
                            const slideData = slideDoc.data();
                            const slideElement = document.createElement('div');
                            slideElement.className = 'bg-white p-4 rounded-lg shadow-md mb-4';
                            slideElement.innerHTML = `
                                <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                                    <div class="flex-1">
                                        <strong>Eszköz:</strong> ${deviceDoc.id}
                                        <br>
                                        <strong>Dia:</strong> ${slideData.comment || 'Nincs megjegyzés'}
                                        <br>
                                        <small>Típus: ${slideData.type}</small>
                                    </div>
                                    <button onclick="unpinSlide('${deviceDoc.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 w-full sm:w-auto">Rögzítés törlése</button>
                                </div>
                            `;
                            container.appendChild(slideElement);
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading pinned slides:', error);
            }
        }
        
        // Unpin slide
        window.unpinSlide = async function(deviceId) {
            try {
                await addDoc(collection(db, 'logs'), {
                    eventType: "Dia rögzítés törlése",
                    details: `Dia rögzítés törölve (Eszköz: ${deviceId})`,
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                const deviceRef = doc(db, 'devices', deviceId);
                await updateDoc(deviceRef, { pinnedSlideId: null });
                showNotification('Rögzített dia törölve!');
                renderPinnedSlides();
            } catch (error) {
                console.error('Error unpinning slide:', error);
                showNotification('Hiba történt a rögzített dia törlésekor!');
            }
        };
        
        // Toggle slide form visibility
        window.toggleSlideForm = function() {
            const form = document.getElementById('slide-form');
            const toggleIcon = document.getElementById('slide-form-toggle');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                toggleIcon.textContent = '▲';
            } else {
                form.classList.add('hidden');
                toggleIcon.textContent = '▼';
            }
        };
        
        // Toggle emergency form visibility
        window.toggleEmergencyForm = function() {
            const form = document.getElementById('emergency-slide-form');
            const toggleIcon = document.getElementById('emergency-form-toggle');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                toggleIcon.textContent = '▲';
            } else {
                form.classList.add('hidden');
                toggleIcon.textContent = '▼';
            }
        };
        
        // Load devices for pinning
        async function loadDevices() {
            const deviceSelect = document.getElementById('device-select');
            deviceSelect.innerHTML = '<option value="">Válassz eszközt</option>';

            try {
                const devicesRef = collection(db, 'devices');
                const devicesSnapshot = await getDocs(devicesRef);
                devicesSnapshot.forEach((doc) => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = doc.id;
                    deviceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }
        
        // Load slides for pinning
        async function loadSlides() {
            const slideSelect = document.getElementById('pinned-slide-select');
            slideSelect.innerHTML = '<option value="">Válassz diát</option>';

            try {
                const slidesRef = collection(db, 'slides');
                const slidesSnapshot = await getDocs(slidesRef);
                slidesSnapshot.forEach((doc) => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    const slideData = doc.data();
                    option.textContent = slideData.comment || `Dia (${doc.id}) - ${slideData.type}`;
                    slideSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading slides:', error);
            }
        }
        
        // Toggle emergency slide status
        window.toggleEmergency = async function(id) {
            if (!auth.currentUser) {
                showNotification('Kérlek, jelentkezz be!');
                return;
            }

            try {
                const slideRef = doc(db, 'emergency_slides', id);
                const slideDoc = await getDoc(slideRef);
                const currentActiveStatus = slideDoc.data().active;

                await addDoc(collection(db, 'logs'), {
                    eventType: "Havária állapot változás",
                    details: `Havária ${currentActiveStatus ? 'deaktiválva' : 'aktiválva'} (ID: ${id})`,
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                if (currentActiveStatus) {
                    await updateDoc(slideRef, { active: false });
                } else {
                    const emergencies = await getDocs(collection(db, 'emergency_slides'));
                    const deactivationPromises = [];
                    emergencies.forEach(doc => {
                        deactivationPromises.push(updateDoc(doc.ref, { active: false }));
                    });
                    await Promise.all(deactivationPromises);
                    await updateDoc(slideRef, { active: true });
                }

                showNotification(`Havária ${currentActiveStatus ? 'deaktiválva' : 'aktiválva'}!`);
                renderEmergencySlides();
            } catch (error) {
                console.error('Error toggling emergency status:', error);
                showNotification('Hiba történt a havária állapotának váltásakor!');
            }
        };

        // Delete slide
        window.deleteSlide = async function(id) {
            showConfirmPopup('Biztosan törlöd ezt a hirdetést?', async () => {
                try {
                    await addDoc(collection(db, 'logs'), {
                        eventType: "Dia törlés",
                        details: `Dia törölve (ID: ${id})`,
                        user: auth.currentUser.email,
                        timestamp: serverTimestamp()
                    });

                    await deleteDoc(doc(db, 'slides', id));
                    showNotification('Hirdetés törölve!');
                    renderSlides();
                } catch (error) {
                    console.error('Error deleting slide:', error);
                    showNotification('Hiba történt a dia törlésekor!');
                }
            });
        };

        // Delete emergency slide
        window.deleteEmergency = async function(id) {
            showConfirmPopup('Biztosan törlöd ezt a haváriát?', async () => {
                try {
                    await addDoc(collection(db, 'logs'), {
                        eventType: "Havária törlés",
                        details: `Havária dia törölve (ID: ${id})`,
                        user: auth.currentUser.email,
                        timestamp: serverTimestamp()
                    });

                    await deleteDoc(doc(db, 'emergency_slides', id));
                    showNotification('Havária törölve!');
                    renderEmergencySlides();
                } catch (error) {
                    console.error('Error deleting emergency slide:', error);
                    showNotification('Hiba történt a havária törlésekor!');
                }
            });
        };

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('hidden');

            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => notification.classList.add('hidden'), 500);
            }, 10000);
        }

        // Show confirmation popup
        function showConfirmPopup(message, callback) {
            const confirmPopup = document.getElementById('confirm-popup');
            const confirmOverlay = document.getElementById('confirm-overlay');
            document.getElementById('confirm-message').textContent = message;
            confirmPopup.classList.remove('hidden');
            confirmOverlay.classList.remove('hidden');

            window.confirmAction = function(confirmed) {
                if (confirmed) callback();
                confirmPopup.classList.add('hidden');
                confirmOverlay.classList.add('hidden');
            };
        }

        // Monitor devices
        function monitorDevices() {
            const devicesRef = collection(db, 'devices');
            onSnapshot(devicesRef, (snapshot) => {
                const onlineCountElement = document.getElementById('online-count');
                const devicesListElement = document.getElementById('devices-list');
                let onlineCount = 0;

                devicesListElement.innerHTML = '';

                snapshot.forEach((doc) => {
                    const device = doc.data();
                    const deviceId = doc.id;
                    const lastHeartbeat = device.lastHeartbeat?.toDate();
                    const isOnline = lastHeartbeat && (new Date() - lastHeartbeat) < 120000;

                    if (isOnline) onlineCount++;

                    const deviceElement = document.createElement('div');
                    deviceElement.className = `p-3 mb-2 rounded flex flex-col ${isOnline ? 'bg-green-100' : 'bg-red-100'}`;
                    deviceElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span>${deviceId}</span>
                            <span class="font-semibold ${isOnline ? 'text-green-600' : 'text-red-600'}">${isOnline ? 'Online' : 'Offline'}</span>
                            <button onclick="toggleDetails('${deviceId}')" class="text-blue-500 hover:text-blue-700">Részletek</button>
                        </div>
                        <div id="details-${deviceId}" class="hidden mt-2">
                            <p><strong>Operációs rendszer:</strong> ${device.os || 'Ismeretlen'}</p>
                            <p><strong>Böngésző:</strong> ${device.browser || 'Ismeretlen'}</p>
                            <p><strong>Felbontás:</strong> ${device.resolution || 'Ismeretlen'}</p>
                            <p><strong>Utolsó ping:</strong> <span id="last-ping-${deviceId}">${lastHeartbeat ? lastHeartbeat.toLocaleString() : 'Ismeretlen'}</span></p>
                            <button onclick="refreshDevice('${deviceId}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 mt-2 w-full">Oldal frissítése</button>
                        </div>
                    `;
                    devicesListElement.appendChild(deviceElement);
                });

                onlineCountElement.textContent = onlineCount;
            });
        }

        // Toggle device details
        window.toggleDetails = function(deviceId) {
            const detailsElement = document.getElementById(`details-${deviceId}`);
            detailsElement.classList.toggle('hidden');
        };
        
        // Refresh all devices
        window.refreshAllDevices = async function() {
            try {
                await addDoc(collection(db, 'logs'), {
                    eventType: "Eszközök frissítése",
                    details: "Összes eszköz oldalának frissítése",
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                const devicesRef = collection(db, 'devices');
                const devicesSnapshot = await getDocs(devicesRef);
                const updates = [];
                devicesSnapshot.forEach((doc) => {
                    updates.push(updateDoc(doc.ref, { refresh: true }));
                });
                await Promise.all(updates);
                showNotification('Összes eszköz oldala frissítve!');
            } catch (error) {
                console.error('Error refreshing devices:', error);
                showNotification('Hiba történt az eszközök frissítésekor!');
            }
        };

        // Refresh single device
        window.refreshDevice = async function(deviceId) {
            try {
                await addDoc(collection(db, 'logs'), {
                    eventType: "Eszköz frissítése",
                    details: `Eszköz oldalának frissítése (ID: ${deviceId})`,
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                const deviceRef = doc(db, 'devices', deviceId);
                await updateDoc(deviceRef, { refresh: true });
                showNotification(`Eszköz (${deviceId}) oldala frissítve!`);
            } catch (error) {
                console.error('Error refreshing device:', error);
                showNotification('Hiba történt az eszköz frissítésekor!');
            }
        };
        
        // Restart all devices
        window.restartAllDevices = async function() {
            try {
                await addDoc(collection(db, 'logs'), {
                    eventType: "Eszközök újraindítása",
                    details: "Összes eszköz újraindítása",
                    user: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });

                const devicesRef = collection(db, 'devices');
                const devicesSnapshot = await getDocs(devicesRef);
                const updates = [];
                devicesSnapshot.forEach((doc) => {
                    updates.push(updateDoc(doc.ref, { restart: true }));
                });
                await Promise.all(updates);
                showNotification('Összes eszköz újraindítva!');
            } catch (error) {
                console.error('Error restarting devices:', error);
                showNotification('Hiba történt az eszközök újraindításakor!');
            }
        };
    </script>
    </div>
</body>
</html>