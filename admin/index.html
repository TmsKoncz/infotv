<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfoTV Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        .slide-item {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .drag-handle {
            cursor: grab;
            opacity: 0.5;
        }
        .drag-handle:hover {
            opacity: 1;
        }
        .preview-image {
            max-height: 100px;
            width: auto;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                bottom: -50px;
                opacity: 0;
            }
            to {
                bottom: 20px;
                opacity: 1;
            }
        }
        .notification.hide {
            animation: slideOut 0.5s ease-in;
        }
        @keyframes slideOut {
            from {
                bottom: 20px;
                opacity: 1;
            }
            to {
                bottom: -50px;
                opacity: 0;
            }
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <!-- Értesítési sáv -->
    <div id="notification" class="notification hidden"></div>

    <!-- Megerősítő popup -->
    <div id="confirm-popup" class="popup hidden">
        <p id="confirm-message"></p>
        <div class="mt-4 flex gap-4">
            <button onclick="confirmAction(true)" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Igen</button>
            <button onclick="confirmAction(false)" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Mégse</button>
        </div>
    </div>
    <div id="confirm-overlay" class="popup-overlay hidden"></div>

    <div class="max-w-4xl mx-auto">
        <!-- Bejelentkezési űrlap -->
        <div id="login-form" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">Bejelentkezés</h2>
            <input type="email" id="email" placeholder="E-mail" class="w-full p-2 border rounded mb-4">
            <input type="password" id="password" placeholder="Jelszó" class="w-full p-2 border rounded mb-4">
            <button onclick="login()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Bejelentkezés</button>
        </div>

        <!-- Admin felület (csak bejelentkezés után látható) -->
        <div id="admin-content" class="hidden">
            <!-- Fejléc -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <h1 class="text-2xl sm:text-3xl font-bold">InfoTV Admin</h1>
                <div class="flex flex-wrap gap-2 sm:gap-4">
                    <a href="https://www.canva.com/design/DAGI4OevAdo/QiptmBWJUsqrn3_MJbQLww/edit" target="_blank" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Sablonok</a>
                    <a href="https://koncz.link/havaria" target="_blank" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Havária</a>
                    <a href="https://infotv.tmskoncz.hu" target="_blank" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Élő oldal</a>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Kijelentkezés</button>
                </div>
            </div>

            <!-- Új dia hozzáadása (becsukható/kinyitható) -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleSlideForm()">
                    <h2 class="text-xl font-semibold">Új hirdetés hozzáadása</h2>
                    <span id="slide-form-toggle">▼</span>
                </div>
                <div id="slide-form" class="mt-4 hidden">
                    <select id="slide-type" class="w-full p-2 border rounded mb-4">
                        <option value="image">Kép</option>
                        <option value="embed">Beágyazott link</option>
                    </select>
                    <input type="text" id="slide-content" placeholder="Kép URL vagy beágyazott link" class="w-full p-2 border rounded mb-4">
                    <input type="file" id="slide-file" class="w-full p-2 border rounded mb-4" accept="image/*">
                    <input type="date" id="slide-start-date" class="w-full p-2 border rounded mb-4">
                    <input type="date" id="slide-end-date" class="w-full p-2 border rounded mb-4">
                    <textarea id="slide-comment" placeholder="Megjegyzés" class="w-full p-2 border rounded mb-4"></textarea>
                    <button onclick="addSlide()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Hirdetés hozzáadása</button>
                </div>
            </div>

            <!-- Diák listája -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Hirdetések listája</h2>
                <div id="slides-container" class="sortable-list"></div>
            </div>
        </div>
    </div>

    <!-- Firebase és Firestore SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

        // Firebase konfiguráció
        const firebaseConfig = {
            apiKey: "AIzaSyAmlb3HFiXq18IlV--o1GOC5yofXSZjV48",
            authDomain: "infotv-50232.firebaseapp.com",
            projectId: "infotv-50232",
            storageBucket: "infotv-50232.appspot.com",
            messagingSenderId: "890415866941",
            appId: "1:890415866941:web:10606b06957eca86d43654",
            measurementId: "G-2V1HZ0RPJK"
        };

        // Firebase inicializálása
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Bejelentkezési űrlap és admin tartalom kezelése
        const loginForm = document.getElementById('login-form');
        const adminContent = document.getElementById('admin-content');

        // Felhasználó bejelentkezési állapotának figyelése
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginForm.style.display = 'none';
                adminContent.style.display = 'block';
                renderSlides();
            } else {
                loginForm.style.display = 'block';
                adminContent.style.display = 'none';
            }
        });

        // Bejelentkezés
        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification('Sikeres bejelentkezés!');
            } catch (error) {
                showNotification('Hibás e-mail vagy jelszó!');
            }
        };

        // Kijelentkezés
        window.logout = async function() {
            try {
                await signOut(auth);
                showNotification('Sikeres kijelentkezés!');
            } catch (error) {
                showNotification('Hiba történt a kijelentkezés során!');
            }
        };

        // Új dia űrlap becsukása/kinyitása
        window.toggleSlideForm = function() {
            const slideForm = document.getElementById('slide-form');
            const toggleIcon = document.getElementById('slide-form-toggle');
            slideForm.classList.toggle('hidden');
            toggleIcon.textContent = slideForm.classList.contains('hidden') ? '▼' : '▲';
        };

        // Dia hozzáadása
        window.addSlide = async function() {
            if (!auth.currentUser) {
                showNotification('Kérlek, jelentkezz be!');
                return;
            }

            const type = document.getElementById('slide-type').value;
            const content = document.getElementById('slide-content').value;
            const file = document.getElementById('slide-file').files[0];
            const startDate = document.getElementById('slide-start-date').value;
            const endDate = document.getElementById('slide-end-date').value;
            const comment = document.getElementById('slide-comment').value;

            if (!type || !startDate || !endDate) {
                showNotification('Minden mezőt ki kell tölteni!');
                return;
            }

            try {
                let fileUrl = content;
                if (file) {
                    const storageRef = ref(storage, `slides/${file.name}`);
                    await uploadBytes(storageRef, file);
                    fileUrl = await getDownloadURL(storageRef);
                }

                await addDoc(collection(db, 'slides'), {
                    type,
                    content: fileUrl,
                    startDate,
                    endDate,
                    comment,
                    active: true,
                    order: (await getDocs(collection(db, 'slides'))).size
                });
                showNotification('Dia hozzáadva!');
                renderSlides();
            } catch (error) {
                console.error('Hiba a dia hozzáadásakor:', error);
                showNotification('Hiba történt a dia hozzáadásakor. Ellenőrizd a konzolt!');
            }
        };

        // Dia állapotának váltása (Kikapcsol/Bekapcsol)
        window.toggleSlide = async function(id) {
            if (!auth.currentUser) {
                showNotification('Kérlek, jelentkezz be!');
                return;
            }

            const slideRef = doc(db, 'slides', id);
            const slideDoc = await getDoc(slideRef);
            await updateDoc(slideRef, { active: !slideDoc.data().active });
            showNotification(`Dia ${slideDoc.data().active ? 'kikapcsolva' : 'bekapcsolva'}!`);
            renderSlides();
        };

        // Dia törlése
        window.deleteSlide = async function(id) {
            showConfirmPopup('Biztosan törlöd ezt a diát?', async () => {
                await deleteDoc(doc(db, 'slides', id));
                showNotification('Dia törölve!');
                renderSlides();
            });
        };

        // Értesítés megjelenítése
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('hidden');

            // Értesítés bezárása 10 másodperc után
            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => notification.classList.add('hidden'), 500); // Várakozás az animáció befejezésére
            }, 10000);
        }

        // Megerősítő popup megjelenítése
        function showConfirmPopup(message, callback) {
            const confirmPopup = document.getElementById('confirm-popup');
            const confirmOverlay = document.getElementById('confirm-overlay');
            document.getElementById('confirm-message').textContent = message;
            confirmPopup.classList.remove('hidden');
            confirmOverlay.classList.remove('hidden');

            window.confirmAction = function(confirmed) {
                if (confirmed) callback();
                confirmPopup.classList.add('hidden');
                confirmOverlay.classList.add('hidden');
            };
        }

        // Diák betöltése és megjelenítése
        async function renderSlides() {
            const container = document.getElementById('slides-container');
            container.innerHTML = '';

            try {
                const querySnapshot = await getDocs(collection(db, 'slides'));
                const slidesArray = [];
                querySnapshot.forEach((doc) => {
                    slidesArray.push({ id: doc.id, ...doc.data() });
                });
                slidesArray.sort((a, b) => a.order - b.order);

                slidesArray.forEach((slide) => {
                    const slideElement = document.createElement('div');
                    slideElement.className = `slide-item bg-gray-50 p-4 rounded-lg mb-4 ${slide.active ? 'border-l-4 border-blue-500' : 'border-l-4 border-gray-300'}`;
                    slideElement.setAttribute('data-id', slide.id);
                    slideElement.innerHTML = `
                        <div class="drag-handle">&#9776;</div>
                        <div class="flex-1">
                            <div class="flex flex-col sm:flex-row gap-4">
                                ${slide.type === 'image' ? `<img src="${slide.content}" alt="Slide Image" class="preview-image">` : ''}
                                <div>
                                    <strong>${slide.type === 'image' ? 'Kép' : 'Beágyazott link'}</strong>
                                    <br>
                                    <small>${slide.startDate} - ${slide.endDate}</small>
                                    <br>
                                    <small>Megjegyzés: ${slide.comment || 'Nincs megjegyzés'}</small>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleSlide('${slide.id}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">${slide.active ? 'Elrejtés' : 'Megjelenítés'}</button>
                            <button onclick="deleteSlide('${slide.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Törlés</button>
                        </div>
                    `;
                    container.appendChild(slideElement);
                });

                // SortableJS inicializálása (csak a drag-handle-el működik)
                Sortable.create(container, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: async function(evt) {
                        const slides = Array.from(container.children);
                        const updates = slides.map((slide, index) => {
                            const slideId = slide.getAttribute('data-id');
                            return updateDoc(doc(db, 'slides', slideId), { order: index });
                        });
                        await Promise.all(updates);
                    }
                });
            } catch (error) {
                console.error('Hiba a diák betöltésekor:', error);
            }
        }
    </script>
</body>
</html>