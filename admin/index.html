<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InfoTV Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        html, body { height: 100%; overflow: hidden; }
        body {
            display: flex; flex-direction: column;
            background-color: #f3f4f6; /* bg-gray-100 */
            font-family: 'Inter', sans-serif;
        }
        #main-content { flex-grow: 1; overflow-y: auto; padding-bottom: 60px; }
        footer { flex-shrink: 0; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner {
             display: inline-block;
             border: 4px solid rgba(59, 130, 246, 0.2); /* Kék áttetsző */
             width: 36px; height: 36px;
             border-radius: 50%;
             border-left-color: #3b82f6; /* Kék (InfoTV primary) */
             animation: spin 1s linear infinite;
         }
        .spinner-sm { width: 20px; height: 20px; border-width: 3px;}

        .modal-overlay {
            position: fixed; inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1040;
            padding: 1rem;
            opacity: 0; transition: opacity 300ms ease-in-out; pointer-events: none;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: white; padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            transform: scale(0.95); transition: transform 300ms ease-in-out;
            max-width: 500px; width: 100%;
        }
         .modal-overlay.active .modal-content { transform: scale(1); }
         #edit-popup .modal-content { max-width: 600px; max-height: 90vh; overflow-y: auto;}

        #admin-action-overlay {
            position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.75);
            display: none; justify-content: center; align-items: center;
            z-index: 20;
        }
        #admin-action-overlay.active { display: flex; }
        #admin-action-overlay .spinner { width: 24px; height: 24px; }

        .view-loading::after { content: 'Adatok betöltése...'; display: block; text-align: center; padding: 2rem; color: #6b7280; font-style: italic; }

        button:disabled { cursor: not-allowed; opacity: 0.5; }

        @keyframes slideInUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes slideOutDown { from { transform: translate(-50%, 0); opacity: 1; } to { transform: translate(-50%, 100%); opacity: 0; } }
        .notification-enter { animation: slideInUp 0.3s ease-out forwards; }
        .notification-leave { animation: slideOutDown 0.3s ease-in forwards; }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }

        .rich-text-content { font-family: 'Inter', sans-serif; }

        .sortable-ghost { background-color: #dbeafe; opacity: 0.7; }
        .sortable-drag { opacity: 0.9; }

        .image-preview { max-height: 60px; margin-top: 5px; border-radius: 4px; border: 1px solid #e5e7eb; }

        .upload-indicator { display: none; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.875rem; }
        .upload-indicator.uploading { display: flex; color: #3b82f6; }
        .upload-indicator.success { display: flex; color: #10b981; }
        .upload-indicator.error { display: flex; color: #ef4444; }
        .upload-indicator .spinner-icon { display: none; }
        .upload-indicator.uploading .spinner-icon { display: inline-block; }
        .upload-indicator .checkmark { display: none; }
        .upload-indicator.success .checkmark { display: inline-block; }
        .upload-indicator .crossmark { display: none; }
        .upload-indicator.error .crossmark { display: inline-block; }
        .upload-indicator .spinner-icon svg {
            width: 1rem; height: 1rem; animation: spin 1s linear infinite;
        }

        .drop-zone { border: 2px dashed #cbd5e1; padding: 1rem; border-radius: 0.5rem; transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out; text-align: center; cursor: pointer; }
        .drop-zone.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .drop-zone-emergency.dragover { border-color: #ef4444; background-color: #fee2e2; }

        .preview-image-container { width: 100%; display: flex; justify-content: center; margin-bottom: 4px; }
        .preview-image { max-width: 80%; height: auto; max-height: 100px; object-fit: contain; border-radius: 4px; border: 1px solid #e5e7eb; display: block; }
        @media (min-width: 640px) {
            .preview-image { max-width: 100px; max-height: 60px; }
            .preview-image-container { justify-content: flex-start; }
        }
        .slide-preview-container { max-width: 150px; overflow: hidden; }
        .slide-preview-text { font-size: 0.75rem; line-height: 1.2; color: #4b5563; max-height: 3.6em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }

        .log-entry { border-bottom: 1px solid #e5e7eb; }
        .log-entry:last-child { border-bottom: none; }

        .edit-btn, .slide-actions button { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.375rem; transition: background-color 0.2s; line-height: 1.2; }
        .edit-btn { background-color: #d1d5db; color: #374151; }
        .edit-btn:hover { background-color: #9ca3af; }

        #devices-list .font-semibold { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle; }

        .slide-item {
             display: flex; justify-content: space-between; align-items: center; gap: 1rem;
             padding: 1rem; margin-bottom: 0.75rem; border-radius: 0.5rem;
             border-left-width: 4px;
        }
        .loading-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1rem; color: #6b7280;
        }
        .loading-container span { margin-top: 0.5rem; }

        /* Dropdown Menu Styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #ffffff; /* white */
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10; /* Dropdown legyen felül */
            border-radius: 0.375rem; /* rounded-md */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem;
        }
        .dropdown-content a, .dropdown-content button {
            color: black;
            padding: 0.75rem 1rem; /* px-4 py-3 */
            text-decoration: none;
            display: block;
            font-size: 0.875rem; /* text-sm */
            text-align: left;
            width: 100%;
        }
        .dropdown-content a:hover, .dropdown-content button:hover { background-color: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }
        .dropdown button svg { /* Arrow icon */
            width: 1em; height: 1em; margin-left: 0.25rem; vertical-align: middle;
        }
        /* Aktív nav gomb stílus */
        .admin-nav-button.active {
            background-color: #eef2ff; /* indigo-50 */
            font-weight: 600; /* font-semibold */
            color: #4338ca; /* indigo-700 */
        }

    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header id="app-header" class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-30">
        <div class="container mx-auto flex flex-wrap justify-between items-center gap-y-2">
            <div class="flex items-center space-x-3">
                <img src="./logo.png" alt="InfoTV Logo" class="h-8 w-8 rounded-full" onerror="this.style.display='none'">
                <h1 class="text-xl font-bold">InfoTV Admin</h1>
            </div>
            <nav class="flex items-center space-x-2 sm:space-x-4">
                <div id="admin-navigation" class="hidden md:flex items-center space-x-1">
                    <div class="dropdown">
                        <button class="hover:bg-indigo-700 px-3 py-2 rounded text-sm font-medium inline-flex items-center">
                            Eszközkezelés
                            <svg class="fill-current h-4 w-4 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </button>
                        <div class="dropdown-content">
                            <button data-section="eszkozok-section" class="admin-nav-button">Eszközök Állapota</button>
                            </div>
                    </div>
                    <div class="dropdown">
                        <button class="hover:bg-indigo-700 px-3 py-2 rounded text-sm font-medium inline-flex items-center">
                            Hirdetéskezelés
                             <svg class="fill-current h-4 w-4 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </button>
                        <div class="dropdown-content">
                            <button data-section="hirdetesek-section" class="admin-nav-button">Normál Hirdetések</button>
                            <button data-section="havaria-section" class="admin-nav-button">Havária Mód</button>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="hover:bg-indigo-700 px-3 py-2 rounded text-sm font-medium inline-flex items-center">
                            Admin
                             <svg class="fill-current h-4 w-4 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </button>
                        <div class="dropdown-content">
                            <button data-section="hibaelharitas-section" class="admin-nav-button">Hibaelhárítás</button>
                            <button data-section="logok-section" class="admin-nav-button">Naplók</button>
                            </div>
                    </div>
                </div>
                <div id="user-status" class="flex items-center space-x-2">
                    <span class="text-sm text-indigo-200">Betöltés...</span>
                </div>
            </nav>
        </div>
    </header>

    <main id="main-content" class="container mx-auto mt-4 pb-16">
        <div id="loading-view" class="flex flex-col justify-center items-center h-64 text-xl text-gray-600">
            <div class="spinner mb-4"></div>
            <p>Alkalmazás betöltése...</p>
        </div>
        <div id="error-view" class="hidden p-4 text-center text-red-700 bg-red-100 rounded-lg"></div>

        <div id="admin-content-wrapper" class="hidden space-y-8">

            <section id="eszkozok-section" class="admin-section hidden">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                     <h1 class="text-2xl font-bold mb-6 text-gray-800">Eszközök állapota</h1>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 space-y-4">
                             <div>
                                 <h2 class="text-xl font-semibold mb-2 text-gray-700">Online eszközök</h2>
                                 <p class="text-4xl font-bold text-green-600" id="online-count">0</p>
                             </div>
                             <div>
                                 <h2 class="text-xl font-semibold mb-2 text-gray-700">Rendelkezésre állás</h2>
                                 <p class="text-4xl font-bold text-blue-600" id="availability-percentage">-%</p>
                             </div>
                         </div>
                         <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                             <h2 class="text-xl font-semibold mb-4 text-gray-700">Eszközök listája</h2>
                             <div id="devices-list" class="overflow-y-auto md:max-h-48">
                                 <div class="loading-container">
                                     <div class="spinner spinner-sm"></div>
                                     <span>Eszközök betöltése...</span>
                                 </div>
                             </div>
                         </div>
                     </div>
                </div>
            </section>

            <section id="hirdetesek-section" class="admin-section hidden">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                    <h1 class="text-2xl font-bold mb-6 text-gray-800">Normál Hirdetések Kezelése</h1>
                     <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8">
                         <div id="toggle-slide-form-trigger" class="flex justify-between items-center cursor-pointer">
                             <h2 class="text-xl font-semibold text-gray-700">Új hirdetés hozzáadása</h2>
                             <span id="slide-form-toggle" class="text-gray-500 text-xl transition-transform duration-300">▼</span>
                         </div>
                         <div id="slide-form" class="mt-4 hidden space-y-4">
                             <div>
                                 <label for="slide-type" class="block text-sm font-medium text-gray-700 mb-1">Típus</label>
                                 <select id="slide-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                     <option value="image">Kép</option>
                                     <option value="embed">Beágyazott link</option>
                                     <option value="aktuális">Aktuális</option>
                                 </select>
                             </div>
                             <div id="regular-slide-fields" class="space-y-4">
                                 <div id="add-image-input-group" class="drop-zone" data-target-input="slide-image-upload" data-target-preview="add-image-preview">
                                     <label for="slide-image-upload" class="block text-sm font-medium text-gray-700 mb-1 cursor-pointer">Kép feltöltése</label>
                                     <input type="file" id="slide-image-upload" accept="image/*" class="hidden">
                                     <p class="text-xs text-gray-500 mb-2">Kattints vagy húzz ide egy képet!</p>
                                     <img id="add-image-preview" src="#" alt="Kép előnézet" class="image-preview hidden mx-auto">
                                     <div id="add-upload-indicator" class="upload-indicator">
                                          <div class="spinner-icon spinner spinner-sm"></div>
                                          <svg class="checkmark h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                          <svg class="crossmark h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                          <span class="indicator-text">Feltöltés...</span>
                                      </div>
                                 </div>
                                 <div id="add-url-input-group" class="hidden">
                                     <label for="slide-content" class="block text-sm font-medium text-gray-700 mb-1">Beágyazott link</label>
                                     <input type="text" id="slide-content" placeholder="https://..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                 </div>
                                 <div class="flex flex-col sm:flex-row gap-4">
                                     <div class="flex-1">
                                         <label for="slide-start-date" class="block text-sm font-medium text-gray-700 mb-1">Kezdő dátum</label>
                                         <input type="date" id="slide-start-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                     </div>
                                     <div class="flex-1">
                                         <label for="slide-end-date" class="block text-sm font-medium text-gray-700 mb-1">Végdátum</label>
                                         <input type="date" id="slide-end-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                     </div>
                                 </div>
                                 <div>
                                     <label for="slide-comment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (admin)</label>
                                     <textarea id="slide-comment" placeholder="Adminisztratív megjegyzés..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" rows="2"></textarea>
                                 </div>
                             </div>
                             <div id="aktualis-slide-fields" class="hidden space-y-4">
                                  <input type="hidden" id="aktualis-preset-link" value="https://i.ibb.co/Hfkcjrct/aktu-lis-sablon-1.png">
                                  <div>
                                      <label class="block text-sm font-medium text-gray-700 mb-1">Első sor (max 20 karakter):</label>
                                      <div id="first-line" contenteditable="true" class="w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 min-h-[40px]"></div>
                                      <div id="first-line-counter" class="text-xs text-right text-gray-500 mt-1">0/20 karakter</div>
                                  </div>
                                  <div>
                                      <label class="block text-sm font-medium text-gray-700 mb-1">Szöveg (max 100 karakter):</label>
                                      <div class="flex flex-wrap gap-1 border-b pb-2 mb-2">
                                          <button type="button" data-format="bold" class="format-button px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><b>B</b></button>
                                          <button type="button" data-format="italic" class="format-button px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><i>I</i></button>
                                          <button type="button" data-format="underline" class="format-button px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><u>U</u></button>
                                          <button type="button" data-format="insertLineBreak" class="format-button px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">↵</button>
                                      </div>
                                      <div id="slide-text-content" contenteditable="true" class="rich-text-content bg-white w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 min-h-[100px]"></div>
                                      <div id="char-counter" class="text-xs text-right text-gray-500 mt-1">0/100 karakter</div>
                                  </div>
                                 <div class="flex flex-col sm:flex-row gap-4">
                                     <div class="flex-1">
                                         <label for="aktualis-start-date" class="block text-sm font-medium text-gray-700 mb-1">Kezdő dátum</label>
                                         <input type="date" id="aktualis-start-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                     </div>
                                     <div class="flex-1">
                                         <label for="aktualis-end-date" class="block text-sm font-medium text-gray-700 mb-1">Végdátum</label>
                                         <input type="date" id="aktualis-end-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                     </div>
                                 </div>
                                  <div>
                                      <label for="aktualis-comment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (admin)</label>
                                      <textarea id="aktualis-comment" placeholder="Adminisztratív megjegyzés..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" rows="2"></textarea>
                                  </div>
                              </div>
                             <button id="add-slide-btn" class="w-full bg-blue-600 text-white p-2.5 rounded-md hover:bg-blue-700 transition duration-200 font-medium">Hirdetés hozzáadása</button>
                         </div>
                     </div>
                     <div class="bg-white p-6 rounded-lg border border-gray-200 mt-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                             <h2 class="text-xl font-semibold text-gray-700">Hirdetések listája (sorrend húzással módosítható)</h2>
                             <button id="reorder-btn" class="w-full sm:w-auto bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition duration-200 text-sm font-medium">
                                 Átrendezés mód
                             </button>
                         </div>
                         <div id="slides-container" class="space-y-3">
                             <div class="loading-container">
                                 <div class="spinner spinner-sm"></div>
                                 <span>Diák betöltése...</span>
                             </div>
                         </div>
                         <div id="reorder-controls" class="hidden mt-4 flex flex-col sm:flex-row justify-end gap-3">
                             <button id="cancel-reorder-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition duration-200">Mégse</button>
                             <button id="save-reorder-btn" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">Sorrend mentése</button>
                         </div>
                     </div>
                </div>
            </section>

            <section id="havaria-section" class="admin-section hidden">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border-l-4 border-red-500">
                    <h1 class="text-2xl font-bold mb-6 text-red-700">Havária mód</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                             <div id="toggle-emergency-form-trigger" class="flex justify-between items-center cursor-pointer">
                                 <h2 class="text-xl font-semibold text-red-800">Új havária hozzáadása</h2>
                                 <span id="emergency-form-toggle" class="text-red-600 text-xl transition-transform duration-300">▼</span>
                             </div>
                             <div id="emergency-slide-form" class="mt-4 hidden space-y-4">
                                 <div>
                                     <label for="emergency-slide-type" class="block text-sm font-medium text-gray-700 mb-1">Típus</label>
                                     <select id="emergency-slide-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                         <option value="image">Kép</option>
                                         <option value="embed">Beágyazott link</option>
                                     </select>
                                 </div>
                                 <div id="emergency-image-input-group" class="drop-zone drop-zone-emergency" data-target-input="emergency-slide-image-upload" data-target-preview="emergency-image-preview">
                                     <label for="emergency-slide-image-upload" class="block text-sm font-medium text-gray-700 mb-1 cursor-pointer">Kép feltöltése (Havária)</label>
                                     <input type="file" id="emergency-slide-image-upload" accept="image/*" class="hidden">
                                     <p class="text-xs text-gray-500 mb-2">Kattints vagy húzz ide egy képet!</p>
                                      <img id="emergency-image-preview" src="#" alt="Havária kép előnézet" class="image-preview hidden mx-auto">
                                      <div id="emergency-upload-indicator" class="upload-indicator">
                                          <div class="spinner-icon spinner spinner-sm text-red-600"></div>
                                          <svg class="checkmark h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                          <svg class="crossmark h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                          <span class="indicator-text">Feltöltés...</span>
                                      </div>
                                  </div>
                                 <div id="emergency-url-input-group" class="hidden">
                                     <label for="emergency-slide-content" class="block text-sm font-medium text-gray-700 mb-1">Beágyazott link (Havária)</label>
                                     <input type="text" id="emergency-slide-content" placeholder="https://..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                 </div>
                                 <div>
                                     <label for="emergency-slide-comment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (admin)</label>
                                     <textarea id="emergency-slide-comment" placeholder="Adminisztratív megjegyzés..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" rows="2"></textarea>
                                 </div>
                                 <button id="add-emergency-btn" class="w-full bg-red-600 text-white p-2.5 rounded-md hover:bg-red-700 transition duration-200 font-medium">Havária hozzáadása és aktiválása</button>
                             </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg border border-gray-200">
                             <h2 class="text-xl font-semibold mb-4 text-gray-700">Haváriák listája</h2>
                             <div id="emergency-slides-container" class="space-y-3">
                                  <div class="loading-container">
                                     <div class="spinner spinner-sm"></div>
                                     <span>Haváriák betöltése...</span>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="hibaelharitas-section" class="admin-section hidden">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8">
                     <h1 class="text-2xl font-bold mb-6 text-gray-800">Hibaelhárítás</h1>
                     <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                         <h2 class="text-xl font-semibold mb-4 text-gray-700">Eszközök Frissítése</h2>
                         <div id="troubleshooting-actions" class="space-y-4">
                             <button id="refresh-all-devices-btn" class="w-full bg-blue-600 text-white p-2.5 rounded-md hover:bg-blue-700 transition duration-200 font-medium">
                                 Összes eszköz oldalának frissítése
                             </button>
                             <p id="troubleshooting-no-access" class="text-gray-500 italic hidden">Ez a funkció csak adminisztrátorok számára elérhető.</p>
                         </div>
                     </div>
                </div>
            </section>

             <section id="logok-section" class="admin-section hidden">
                 <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                         <h2 class="text-xl font-semibold text-gray-700">Naplóbejegyzések (összes)</h2>
                         <div class="flex gap-2 w-full sm:w-auto">
                             <button id="refresh-logs-btn" class="w-full sm:w-auto bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition duration-200 text-sm">
                                 Frissítés
                             </button>
                         </div>
                     </div>
                     <div id="log-entries" class="overflow-y-auto max-h-96 border rounded p-2 bg-gray-50">
                          <div class="loading-container">
                            <div class="spinner spinner-sm"></div>
                            <span>Naplóbejegyzések betöltése...</span>
                        </div>
                     </div>
                 </div>
             </section>

        </div>

    </main>

    <div id="login-popup" class="hidden fixed bottom-0 left-0 right-0 bg-gray-800 text-white p-4 shadow-lg z-40 flex flex-col sm:flex-row justify-center items-center gap-4">
         <p id="login-popup-message" class="text-center sm:text-left">Ehhez a művelethez bejelentkezés szükséges.</p>
         <button id="google-login-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded inline-flex items-center transition duration-150 ease-in-out">
             <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
             <span id="login-button-text">Bejelentkezés iskolai Google-fiókkal</span>
             <div id="login-spinner" class="hidden spinner spinner-sm ml-2"></div>
         </button>
          <button id="login-popup-close" class="absolute top-1 right-2 sm:relative sm:top-auto sm:right-auto ml-4 text-gray-400 hover:text-white text-2xl leading-none" title="Bezárás">&times;</button>
     </div>

    <div id="messageBox" class="modal-overlay">
         <div class="modal-content max-w-sm text-center">
             <p id="messageText" class="mb-4 text-gray-700"></p>
             <button id="closeMessageButton" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150">Rendben</button>
         </div>
     </div>

    <div id="notification" class="notification fixed bottom-4 left-1/2 transform -translate-x-1/2 max-w-md w-[calc(100%-2rem)] text-white px-4 py-3 rounded-md shadow-lg z-[1050] text-center hidden"></div>

    <div id="confirm-popup" class="modal-overlay">
        <div class="modal-content max-w-md">
            <h3 class="text-lg font-semibold mb-2 text-gray-800">Megerősítés</h3>
            <p id="confirm-message" class="mb-4 text-gray-600"></p>
            <div class="flex flex-col sm:flex-row justify-end gap-3">
                <button id="confirmCancelBtn" class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150">Mégse</button>
                <button id="confirmOkBtn" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150">Igen, törlés</button>
            </div>
        </div>
    </div>

    <div id="edit-popup" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Dia szerkesztése</h3>
            <input type="hidden" id="edit-current-image-url">
            <div class="space-y-4">
                <div>
                    <label for="edit-slide-type" class="block text-sm font-medium text-gray-700 mb-1">Típus</label>
                    <select id="edit-slide-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="image">Kép</option>
                        <option value="embed">Beágyazott link</option>
                        <option value="aktuális">Aktuális</option>
                    </select>
                </div>
                <div id="edit-image-input-group" class="drop-zone" data-target-input="edit-slide-image-upload" data-target-preview="edit-image-preview">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kép cseréje (opcionális)</label>
                    <input type="file" id="edit-slide-image-upload" accept="image/*" class="hidden">
                    <span class="text-xs text-gray-500 block mb-2">Kattints vagy húzz ide egy képet!</span>
                    <img id="edit-image-preview" src="#" alt="Kép előnézet" class="image-preview hidden mx-auto">
                     <div id="edit-upload-indicator" class="upload-indicator">
                          <div class="spinner-icon spinner spinner-sm"></div>
                          <svg class="checkmark h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                          <svg class="crossmark h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                          <span class="indicator-text">Feltöltés...</span>
                      </div>
                 </div>
                <div id="edit-url-input-group" class="hidden">
                    <label for="edit-slide-content" class="block text-sm font-medium text-gray-700 mb-1">Beágyazott link</label>
                    <input type="text" id="edit-slide-content" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://...">
                </div>
                 <div class="flex flex-col sm:flex-row gap-4">
                     <div class="flex-1">
                         <label for="edit-start-date" class="block text-sm font-medium text-gray-700 mb-1">Kezdő dátum</label>
                         <input type="date" id="edit-start-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                     </div>
                     <div class="flex-1">
                         <label for="edit-end-date" class="block text-sm font-medium text-gray-700 mb-1">Végdátum</label>
                         <input type="date" id="edit-end-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                     </div>
                 </div>
                <div id="edit-text-content-group" class="hidden space-y-2">
                     <div>
                         <label for="edit-first-line" class="block text-sm font-medium text-gray-700 mb-1">Első sor (max 20 karakter):</label>
                         <div id="edit-first-line" contenteditable="true" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 min-h-[40px]"></div>
                         <div id="edit-first-line-counter" class="text-xs text-right text-gray-500 mt-1">0/20 karakter</div>
                     </div>
                     <div>
                         <label class="block text-sm font-medium text-gray-700 mb-1">Szöveg (max 100 karakter):</label>
                         <div class="flex flex-wrap gap-1 border-b pb-2 mb-2">
                             <button type="button" data-format="bold" class="edit-format-button px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><b>B</b></button>
                             <button type="button" data-format="italic" class="edit-format-button px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><i>I</i></button>
                             <button type="button" data-format="underline" class="edit-format-button px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><u>U</u></button>
                             <button type="button" data-format="insertLineBreak" class="edit-format-button px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">↵</button>
                         </div>
                         <div id="edit-text-content" contenteditable="true" class="rich-text-content w-full p-2 border border-gray-300 rounded-md bg-gray-50 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 min-h-[100px]"></div>
                         <div id="edit-char-counter" class="text-xs text-right text-gray-500 mt-1">0/100 karakter</div>
                     </div>
                 </div>
                <div>
                    <label for="edit-comment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (adminisztrátor számára)</label>
                    <textarea id="edit-comment" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Pl. Mettől meddig releváns, ki kérte..." rows="3"></textarea>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-end gap-3 mt-6 border-t pt-4">
                <button id="edit-cancel-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150">Mégse</button>
                <button id="edit-save-btn" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150">Mentés</button>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-sm py-4 mt-auto flex items-center justify-center space-x-2">
        <span>Powered by</span>
        <span>InfoTV Admin &copy; <span id="current-year"></span></span>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Konfiguráció ---
        const firebaseConfig = {
            apiKey: "AIzaSyAmlb3HFiXq18IlV--o1GOC5yofXSZjV48",
            authDomain: "infotv-50232.firebaseapp.com",
            projectId: "infotv-50232",
            storageBucket: "infotv-50232.appspot.com",
            messagingSenderId: "890415866941",
            appId: "1:890415866941:web:10606b06957eca86d43654",
            measurementId: "G-2V1HZ0RPJK"
        };

        // --- Globális Változók ---
        let firebaseApp;
        let firestore;
        let auth;
        let googleProvider;
        let currentUser = undefined;
        let allowedUsers = [];
        let pendingUsers = []; // Hozzáadva a pendingUsers tárolásához
        let unsubscribeAdminListeners = [];
        const IMGBB_API_KEY = '8f8df6e25ae6f48ebc2beba95085cecd';
        let currentEditingSlideId = null;
        let currentEditingSlideType = null;
        let sortableInstance = null;
        let notificationTimeoutId = null;
        const TOTAL_DEVICES = 10;
        let isUploading = false;
        let authStatePromise = null;

        // --- DOM Elemek Referenciái ---
        const loadingView = document.getElementById('loading-view');
        const errorView = document.getElementById('error-view');
        const adminContentWrapper = document.getElementById('admin-content-wrapper');
        const adminNavigation = document.getElementById('admin-navigation');
        const loginPopup = document.getElementById('login-popup');
        const googleLoginButton = document.getElementById('google-login-button');
        const loginButtonText = document.getElementById('login-button-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginPopupCloseButton = document.getElementById('login-popup-close');
        const loginPopupMessage = document.getElementById('login-popup-message');
        const userStatusDiv = document.getElementById('user-status');
        const mainContent = document.getElementById('main-content');
        const onlineCountElement = document.getElementById('online-count');
        const availabilityElement = document.getElementById('availability-percentage');
        const devicesListElement = document.getElementById('devices-list');
        const slidesContainer = document.getElementById('slides-container');
        const reorderBtn = document.getElementById('reorder-btn');
        const reorderControls = document.getElementById('reorder-controls');
        const emergencySlidesContainer = document.getElementById('emergency-slides-container');
        const logEntriesContainer = document.getElementById('log-entries');
        const troubleshootingActionsDiv = document.getElementById('troubleshooting-actions');
        const refreshAllDevicesBtn = document.getElementById('refresh-all-devices-btn');
        // const toggleLogCardBtn = document.getElementById('toggle-log-card-btn'); // Eltávolítva
        const troubleshootingNoAccess = document.getElementById('troubleshooting-no-access');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageButton = document.getElementById('closeMessageButton');
        const confirmPopup = document.getElementById('confirm-popup');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirmOkBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const editPopup = document.getElementById('edit-popup');
        const editSaveBtn = document.getElementById('edit-save-btn');
        const editCancelBtn = document.getElementById('edit-cancel-btn');
        const notificationElement = document.getElementById('notification');
        const addSlideImageUpload = document.getElementById('slide-image-upload');
        const addImagePreview = document.getElementById('add-image-preview');
        const addUploadIndicator = document.getElementById('add-upload-indicator');
        const addImageInputGroup = document.getElementById('add-image-input-group');
        const addUrlInputGroup = document.getElementById('add-url-input-group');
        const editSlideImageUpload = document.getElementById('edit-slide-image-upload');
        const editImagePreview = document.getElementById('edit-image-preview');
        const editUploadIndicator = document.getElementById('edit-upload-indicator');
        const editImageInputGroup = document.getElementById('edit-image-input-group');
        const editUrlInputGroup = document.getElementById('edit-url-input-group');
        const editCurrentImageUrlInput = document.getElementById('edit-current-image-url');
        const emergencySlideImageUpload = document.getElementById('emergency-slide-image-upload');
        const emergencyImagePreview = document.getElementById('emergency-image-preview');
        const emergencyUploadIndicator = document.getElementById('emergency-upload-indicator');
        const emergencyImageInputGroup = document.getElementById('emergency-image-input-group');
        const emergencyUrlInputGroup = document.getElementById('emergency-url-input-group');
        const addSlideBtn = document.getElementById('add-slide-btn');
        const addEmergencyBtn = document.getElementById('add-emergency-btn');

        // --- Inicializálás ---
        function initializeApp() {
             console.log("initializeApp() called");
             try {
                 if (!firebaseConfig || !firebaseConfig.apiKey) throw new Error("Firebase konfiguráció hiányzik.");
                 firebaseApp = firebase.initializeApp(firebaseConfig);
                 firestore = firebase.firestore();
                 auth = firebase.auth();
                 googleProvider = new firebase.auth.GoogleAuthProvider();
                 console.log("Firebase (App, Firestore, Auth) sikeresen inicializálva.");
                 setupEventListeners();
                 setupAuthListener();
                 document.getElementById('current-year').textContent = new Date().getFullYear();
                 switchView('loading');
                 console.log("initializeApp() finished successfully.");
             } catch (error) {
                 console.error("Firebase inicializálási hiba:", error);
                 showError(`Firebase inicializálása sikertelen: ${error.message}. Ellenőrizd a konfigurációt és a hálózati kapcsolatot.`);
             }
         }

        // --- Nézetváltás ---
        function switchView(viewId) {
             console.log(`Switching view to: ${viewId}`);
             loadingView.classList.add('hidden');
             errorView.classList.add('hidden');
             adminContentWrapper.classList.add('hidden');

             if (viewId === 'admin') {
                 adminContentWrapper.classList.remove('hidden');
                 showAdminSection('eszkozok-section'); // Alapértelmezett admin nézet
             } else if (viewId === 'loading') {
                 loadingView.classList.remove('hidden');
             } else if (viewId === 'error') {
                 errorView.classList.remove('hidden');
             }
             // updateNavLinks(); // Ezt most az updateUIBasedOnAuthState kezeli
        }

        // --- Admin Szekció Váltás ---
        function showAdminSection(sectionId) {
            console.log(`Showing admin section: ${sectionId}`);
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.add('hidden');
            });
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                sectionToShow.classList.remove('hidden');
                // Adatok betöltése csak ha szükséges (pl. logok)
                if (sectionId === 'logok-section') {
                    fetchLogs();
                }
                // Aktív gomb jelölése
                document.querySelectorAll('#admin-navigation .admin-nav-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.section === sectionId);
                });
            } else {
                console.error(`Admin section not found: ${sectionId}`);
            }
        }


        // --- Hiba Megjelenítés ---
        function showError(message) {
             console.error("Showing error:", message);
             errorView.textContent = `Hiba: ${message}`;
             switchView('error');
        }

        // --- Segédfüggvények ---
        function escapeHtml(unsafe) { return unsafe ? unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : ''; }
        function escapeJsString(unsafe) { return unsafe ? unsafe.toString().replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n') : '';}

        function showMessage(message, isError = false) {
            messageText.textContent = message;
            const modalContent = messageBox.querySelector('.modal-content');
            modalContent.classList.toggle('border-l-4', isError);
            modalContent.classList.toggle('border-red-500', isError);
            modalContent.classList.toggle('border-blue-500', !isError);
            messageBox.classList.add('active');
        }
        function closeMessage() { messageBox.classList.remove('active'); }

        function showConfirmPopup(message, confirmCallback) {
            confirmMessage.textContent = message;
            confirmPopup.classList.add('active');
            const currentOkBtn = document.getElementById('confirmOkBtn');
            const currentCancelBtn = document.getElementById('confirmCancelBtn');
            currentOkBtn.onclick = async () => {
                confirmPopup.classList.remove('active');
                if (confirmCallback) await confirmCallback();
            };
            currentCancelBtn.onclick = () => {
                confirmPopup.classList.remove('active');
            };
        }


        function openEditPopup() { editPopup.classList.add('active'); }
        function closeEditPopup() {
             if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true);
             editPopup.classList.remove('active');
             currentEditingSlideId = null;
             currentEditingSlideType = null;
             editSlideImageUpload.value = '';
             handleImagePreview(editSlideImageUpload, editImagePreview, editUploadIndicator, editSaveBtn);
             editCurrentImageUrlInput.value = '';
             document.getElementById('edit-slide-type').value = 'image';
             document.getElementById('edit-slide-content').value = '';
             document.getElementById('edit-start-date').value = '';
             document.getElementById('edit-end-date').value = '';
             document.getElementById('edit-comment').value = '';
             document.getElementById('edit-first-line').innerHTML = '';
             document.getElementById('edit-text-content').innerHTML = '';
             editUpdateFirstLineCounter(); editUpdateCharCounter();
             setIndicatorState(editUploadIndicator, 'idle');
             toggleEditSlideTypeFields();
        }

        function showNotification(message, isError = false) {
            notificationElement.textContent = message;
            notificationElement.className = `notification fixed bottom-4 left-1/2 transform -translate-x-1/2 max-w-md w-[calc(100%-2rem)] text-white px-4 py-3 rounded-md shadow-lg z-[1050] text-center ${isError ? 'error' : 'success'}`;
            notificationElement.classList.remove('hidden');
            notificationElement.classList.remove('notification-leave');
            notificationElement.classList.add('notification-enter');
            if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
            notificationTimeoutId = setTimeout(() => {
                notificationElement.classList.remove('notification-enter');
                notificationElement.classList.add('notification-leave');
                setTimeout(() => {
                     if (notificationElement.classList.contains('notification-leave')) {
                        notificationElement.classList.add('hidden');
                        notificationElement.classList.remove('notification-leave');
                    }
                }, 300);
            }, 5000);
        }

        function handleImagePreview(fileInput, previewElement, indicatorElement, relatedButton) {
            const file = fileInput.files[0];
            setIndicatorState(indicatorElement, 'idle');
            if (relatedButton) relatedButton.disabled = false;
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewElement.src = e.target.result;
                    previewElement.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                previewElement.classList.add('hidden');
                previewElement.src = '#';
            }
         }
        function updateCounter(elementId, counterId, maxLength) {
            const element = document.getElementById(elementId);
            const counter = document.getElementById(counterId);
            if (!element || !counter) return;
            const currentLength = element.innerText.length;
            counter.textContent = `${currentLength}/${maxLength} karakter`;
            counter.classList.toggle('text-red-600', currentLength > maxLength);
        }
        function setIndicatorState(indicatorElement, state, message = '') {
            if (!indicatorElement) return;
            const textElement = indicatorElement.querySelector('.indicator-text');
            const spinnerElement = indicatorElement.querySelector('.spinner-icon');
            const checkmarkElement = indicatorElement.querySelector('.checkmark');
            const crossmarkElement = indicatorElement.querySelector('.crossmark');

            indicatorElement.classList.remove('uploading', 'success', 'error');
            if (spinnerElement) spinnerElement.style.display = 'none';
            if (checkmarkElement) checkmarkElement.style.display = 'none';
            if (crossmarkElement) crossmarkElement.style.display = 'none';
            if (textElement) textElement.textContent = message;

            indicatorElement.style.display = 'none';

            switch (state) {
                case 'uploading':
                    indicatorElement.classList.add('uploading');
                    if(spinnerElement) spinnerElement.style.display = 'inline-block';
                    if (textElement) textElement.textContent = message || 'Feltöltés...';
                    indicatorElement.style.display = 'flex';
                    break;
                case 'success':
                    indicatorElement.classList.add('success');
                    if(checkmarkElement) checkmarkElement.style.display = 'inline-block';
                    if (textElement) textElement.textContent = message || 'Sikeres feltöltés!';
                    indicatorElement.style.display = 'flex';
                    break;
                case 'error':
                    indicatorElement.classList.add('error');
                    if(crossmarkElement) crossmarkElement.style.display = 'inline-block';
                    if (textElement) textElement.textContent = message || 'Feltöltési hiba!';
                    indicatorElement.style.display = 'flex';
                    break;
                case 'idle':
                default:
                    indicatorElement.style.display = 'none';
                    break;
            }
        }
        function getLoadingIndicatorHTML(text = 'Betöltés...') {
             return `
                 <div class="loading-container flex flex-col justify-center items-center p-4 text-gray-500">
                     <div class="spinner spinner-sm mb-2"></div>
                     <span>${text}</span>
                 </div>`;
         }

        // --- Firebase Hitelesítés (pendingUsers logikával) ---
        function setupAuthListener() {
             console.log("setupAuthListener() called");
             if (!auth) return showError("Auth szolgáltatás nem inicializálódott.");
             authStatePromise = new Promise((resolve) => {
                 const unsubscribe = auth.onAuthStateChanged(async (user) => {
                     console.log(">>> onAuthStateChanged triggered. User:", user ? user.uid : 'null');
                     let resolvedUser = null;
                     if (user) {
                         console.log("User signed in, checking authorization for UID:", user.uid);
                         const userDocRef = firestore.collection('allowedUsers').doc(user.uid);
                         try {
                             console.log("Attempting to get user document from allowedUsers...");
                             const userDoc = await userDocRef.get();
                             if (userDoc.exists) {
                                 console.log("User found in allowedUsers. Data:", userDoc.data());
                                 const userData = userDoc.data();
                                 resolvedUser = { uid: user.uid, displayName: user.displayName, email: user.email, isAdmin: userData.isAdmin === true, nickname: userData.nickname || null };
                             } else {
                                 console.log("User not in allowedUsers, checking pendingUsers for email:", user.email.toLowerCase());
                                 const pendingUserDocRef = firestore.collection('pendingUsers').doc(user.email.toLowerCase());
                                 const pendingDoc = await pendingUserDocRef.get();
                                 if (pendingDoc.exists) {
                                     console.log("User found in pendingUsers. Data:", pendingDoc.data());
                                     const pendingData = pendingDoc.data();
                                     resolvedUser = { uid: user.uid, displayName: user.displayName, email: user.email, isAdmin: pendingData.isAdmin === true, nickname: pendingData.nickname || null };
                                     const batch = firestore.batch();
                                     batch.set(userDocRef, { email: user.email.toLowerCase(), isAdmin: resolvedUser.isAdmin, nickname: resolvedUser.nickname });
                                     batch.delete(pendingUserDocRef);
                                     console.log("Attempting to commit batch: add to allowedUsers, delete from pendingUsers");
                                     await batch.commit();
                                     console.log("User successfully migrated from pending to allowed.");
                                 } else {
                                     console.warn(`User ${user.email} (${user.uid}) is authenticated but not found in allowedUsers or pendingUsers. Denying access.`);
                                     showNotification("Nincs jogosultságod az admin felülethez. Kérj meghívót.", true);
                                     await auth.signOut();
                                     resolvedUser = null;
                                 }
                             }
                         } catch (error) {
                             console.error("Error checking user authorization:", error);
                             showError("Hiba történt a felhasználói jogosultság ellenőrzésekor.");
                             await auth.signOut().catch(e => console.error("Sign out failed:", e));
                             resolvedUser = null;
                         }
                     } else {
                         console.log("User signed out.");
                         resolvedUser = null;
                     }
                     currentUser = resolvedUser;
                     updateUIBasedOnAuthState(currentUser);
                     setupAdminSpecificListeners(currentUser);
                     resolve();
                 }, (error) => {
                     console.error("Error in onAuthStateChanged listener:", error);
                     showError("Hiba történt a bejelentkezési állapot figyelésekor.");
                     currentUser = null;
                     updateUIBasedOnAuthState(null);
                     setupAdminSpecificListeners(null);
                     resolve();
                 });
             });
         }

        function handleGoogleLogin() {
             if (!auth || !googleProvider) return showError("Auth szolgáltatás nem inicializálódott.");
             googleLoginButton.disabled = true;
             loginSpinner.classList.remove('hidden');
             loginButtonText.textContent = 'Bejelentkezés...';
             auth.signInWithPopup(googleProvider)
                 .catch((error) => {
                     console.error("Google Sign-In Error:", error);
                     if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                         showNotification(`Hiba a Google bejelentkezés során: ${error.message}`, true);
                     }
                 })
                 .finally(() => {
                     if (!loginPopup.classList.contains('hidden')) {
                           googleLoginButton.disabled = false;
                           loginSpinner.classList.add('hidden');
                           loginButtonText.textContent = 'Bejelentkezés iskolai Google-fiókkal';
                     }
                 });
         }

        function handleLogout() {
              if (!auth) return;
              console.log("Logging out...");
              auth.signOut().catch((error) => {
                  console.error("Logout failed:", error);
                  showNotification("Hiba történt a kijelentkezés során.", true);
              });
          }

        // --- UI Frissítés Auth Állapot Alapján ---
        function updateUIBasedOnAuthState(user) {
             console.log("updateUIBasedOnAuthState called with user:", user ? user.uid : null, "isAdmin:", user?.isAdmin);
             const isAdmin = user?.isAdmin === true;
             adminNavigation?.classList.toggle('hidden', !isAdmin);

             if (user) {
                 loginPopup.classList.add('hidden');
                 userStatusDiv.innerHTML = `
                     <span class="text-sm hidden lg:inline" title="${escapeHtml(user.email)}">${escapeHtml(user.nickname || user.displayName || user.email)} ${isAdmin ? '<span class="text-yellow-300">(Admin)</span>' : ''}</span>
                     <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm font-semibold py-1 px-2 sm:px-3 rounded transition duration-150 ease-in-out">
                         Kijelentkezés
                     </button>
                 `;
                 document.getElementById('logout-button')?.addEventListener('click', handleLogout);

                 if(isAdmin) {
                    switchView('admin');
                    loadAdminData();
                 } else {
                    switchView('error');
                    errorView.textContent = "Nincs jogosultságod az admin felület megtekintéséhez.";
                 }

             } else {
                 userStatusDiv.innerHTML = `<button id="show-login-button" class="bg-blue-500 hover:bg-blue-700 text-white text-sm font-semibold py-1 px-2 sm:px-3 rounded">Bejelentkezés</button>`;
                 document.getElementById('show-login-button')?.addEventListener('click', showLoginPopup);
                 switchView('loading');
                 loadingView.innerHTML = `<p class="text-xl text-gray-600 p-10 text-center">Az admin felület használatához kérjük, jelentkezzen be a Google fiókjával.</p>`;
                 loadingView.classList.remove('hidden');
             }
             // updateNavLinks(); // Már nem kell, az admin nav láthatósága kezeli
         }

        // --- Admin Specifikus Firestore Listenerek ---
        function setupAdminSpecificListeners(user) {
            unsubscribeAdminListeners.forEach(unsub => unsub());
            unsubscribeAdminListeners = [];
            if (user?.isAdmin && firestore) {
                console.log("Setting up ADMIN specific Firestore listeners...");
                const allowedUsersRef = firestore.collection('allowedUsers').orderBy('email');
                 const unsubAllowedUsers = allowedUsersRef.onSnapshot((snapshot) => {
                     allowedUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     console.log("Admin: Allowed users updated:", allowedUsers.length);
                 }, (error) => { console.error("Error fetching allowed users:", error); });
                unsubscribeAdminListeners.push(unsubAllowedUsers);
                // Pending users figyelése
                 const pendingUsersRef = firestore.collection('pendingUsers');
                 const unsubPendingUsers = pendingUsersRef.onSnapshot((snapshot) => {
                     pendingUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     console.log("Admin: Pending users updated:", pendingUsers.length);
                     // TODO: Frissíteni kellene az Admin->Felhasználók részt, ha az látható és tartalmazza a pending usereket
                 }, (error) => { console.error("Error fetching pending users:", error); });
                 unsubscribeAdminListeners.push(unsubPendingUsers);

            } else {
                console.log("Skipping or stopping admin listeners (not admin or no firestore).");
                allowedUsers = [];
                pendingUsers = [];
            }
        }

        // --- InfoTV Adatkezelő Függvények ---
        function loadAdminData() {
            console.log("loadAdminData called");
            if (!currentUser?.isAdmin) {
                console.log("loadAdminData skipped: not admin.");
                return;
            }
            renderSlides();
            renderEmergencySlides();
            monitorDevices();
            fetchLogs();
        }

        async function addSlide() {
             if (!currentUser?.isAdmin) return showNotification('Nincs jogosultságod ehhez a művelethez!', true);
             if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true);
             const type = document.getElementById('slide-type').value;
             let content = '', startDate, endDate, comment, firstLineText = '', textContentText = '';
             let imageUrl = null;
             const fileInput = addSlideImageUpload;
             addSlideBtn.disabled = true;
             addSlideBtn.textContent = 'Hozzáadás...';
             try {
                 if (type === 'image') {
                     if (!fileInput.files || fileInput.files.length === 0) throw new Error('Kérjük, válasszon ki egy képet!');
                     imageUrl = await uploadImageToImgBB(fileInput.files[0], addUploadIndicator, addSlideBtn);
                     content = imageUrl;
                     startDate = document.getElementById('slide-start-date').value;
                     endDate = document.getElementById('slide-end-date').value;
                     comment = document.getElementById('slide-comment').value;
                 } else if (type === 'aktuális') {
                     firstLineText = document.getElementById('first-line').innerText;
                     textContentText = document.getElementById('slide-text-content').innerText;
                     if (firstLineText.length > 20) throw new Error('Az első sor max 20 karakter!');
                     if (textContentText.length > 100) throw new Error('A szöveg max 100 karakter!');
                     content = { presetLink: document.getElementById('aktualis-preset-link').value, firstLine: document.getElementById('first-line').innerHTML, text: document.getElementById('slide-text-content').innerHTML, style: {} };
                     startDate = document.getElementById('aktualis-start-date').value;
                     endDate = document.getElementById('aktualis-end-date').value;
                     comment = document.getElementById('aktualis-comment').value;
                 } else {
                     content = document.getElementById('slide-content').value;
                     if (!content || !content.trim()) throw new Error('Beágyazott link megadása kötelező!');
                     try { new URL(content); } catch (_) { throw new Error('Érvénytelen URL formátum!'); }
                     startDate = document.getElementById('slide-start-date').value;
                     endDate = document.getElementById('slide-end-date').value;
                     comment = document.getElementById('slide-comment').value;
                 }
                 if (!startDate || !endDate) throw new Error('Kezdő és végdátum megadása kötelező!');
                 if (new Date(startDate) > new Date(endDate)) throw new Error('A kezdő dátum nem lehet későbbi a végdátumnál!');

                 await firestore.collection('logs').add({ eventType: "Dia létrehozás", details: `Új dia (típus: ${type})`, user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                 const slidesQuery = firestore.collection('slides').orderBy("order", "desc").limit(1);
                 const slidesSnapshot = await slidesQuery.get();
                 const lastOrder = slidesSnapshot.empty ? -1 : (slidesSnapshot.docs[0].data().order ?? -1);
                 const finalContent = type === 'aktuális' ? JSON.stringify(content) : content;
                 const slideData = { type, content: finalContent, startDate, endDate, comment: comment.trim(), active: true, order: lastOrder + 1, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                 await firestore.collection('slides').add(slideData);

                 showNotification('Hirdetés sikeresen hozzáadva!');
                 resetSlideForm(type);
                 toggleSlideForm();
                 renderSlides();
             } catch (error) {
                 console.error('Error adding slide:', error);
                 showNotification(`Hiba a hozzáadáskor: ${error.message}`, true);
             } finally {
                 addSlideBtn.disabled = false;
                 addSlideBtn.textContent = 'Hirdetés hozzáadása';
                 if (type !== 'image' || !fileInput.files || fileInput.files.length === 0) {
                     setIndicatorState(addUploadIndicator, 'idle');
                 }
             }
         }

         function resetSlideForm(type) {
             document.getElementById('slide-start-date').value = '';
             document.getElementById('slide-end-date').value = '';
             document.getElementById('slide-comment').value = '';
             document.getElementById('aktualis-start-date').value = '';
             document.getElementById('aktualis-end-date').value = '';
             document.getElementById('aktualis-comment').value = '';
             document.getElementById('slide-content').value = '';
             document.getElementById('first-line').innerHTML = '';
             document.getElementById('slide-text-content').innerHTML = '';
             addSlideImageUpload.value = '';
             handleImagePreview(addSlideImageUpload, addImagePreview, addUploadIndicator, addSlideBtn);
             updateFirstLineCounter();
             updateCharCounter();
         }

        async function addEmergencySlide() {
            if (!currentUser?.isAdmin) return showNotification('Nincs jogosultságod ehhez a művelethez!', true);
             if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true);
             const type = document.getElementById('emergency-slide-type').value;
             let content = '';
             const comment = document.getElementById('emergency-slide-comment').value;
             let imageUrl = null;
             const fileInput = emergencySlideImageUpload;
             addEmergencyBtn.disabled = true;
             addEmergencyBtn.textContent = 'Hozzáadás...';
             try {
                 if (type === 'image') {
                     if (!fileInput.files || fileInput.files.length === 0) throw new Error('Kérjük, válasszon ki egy képet!');
                     imageUrl = await uploadImageToImgBB(fileInput.files[0], emergencyUploadIndicator, addEmergencyBtn);
                     content = imageUrl;
                 } else {
                     content = document.getElementById('emergency-slide-content').value;
                     if (!content || !content.trim()) throw new Error('Beágyazott link megadása kötelező!');
                     try { new URL(content); } catch (_) { throw new Error('Érvénytelen URL formátum!'); }
                 }

                 await firestore.collection('logs').add({ eventType: "Havária létrehozás", details: `Új havária (típus: ${type})`, user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                 const emergenciesRef = firestore.collection('emergency_slides');
                 const emergenciesSnapshot = await emergenciesRef.get();
                 const batch = firestore.batch();
                 emergenciesSnapshot.docs.forEach(doc => batch.update(doc.ref, { active: false }));
                 const newDocRef = emergenciesRef.doc();
                 batch.set(newDocRef, { type, content, comment: comment.trim(), active: true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                 await batch.commit();

                 showNotification('Havária sikeresen hozzáadva és aktiválva!');
                 document.getElementById('emergency-slide-type').value = 'image';
                 document.getElementById('emergency-slide-content').value = '';
                 document.getElementById('emergency-slide-comment').value = '';
                 emergencySlideImageUpload.value = '';
                 handleImagePreview(emergencySlideImageUpload, emergencyImagePreview, emergencyUploadIndicator, addEmergencyBtn);
                 toggleEmergencyForm();
                 renderEmergencySlides();
             } catch (error) {
                 console.error('Error adding emergency slide:', error);
                 showNotification(`Hiba a havária hozzáadásakor: ${error.message}`, true);
             } finally {
                 addEmergencyBtn.disabled = false;
                 addEmergencyBtn.textContent = 'Havária hozzáadása és aktiválása';
                 if (type !== 'image' || !fileInput.files || fileInput.files.length === 0) {
                     setIndicatorState(emergencyUploadIndicator, 'idle');
                 }
             }
         }

        let originalSlideOrder = [];
         function toggleReorderMode() {
            if (!currentUser?.isAdmin) return;
             const reorderBtn = document.getElementById('reorder-btn');
             const reorderControls = document.getElementById('reorder-controls');
             const container = document.getElementById('slides-container');
             const isReordering = reorderBtn.textContent.includes('Kilépés');
             reorderBtn.textContent = isReordering ? 'Átrendezés mód' : 'Kilépés az átrendezésből';
             reorderBtn.classList.toggle('bg-purple-600', !isReordering);
             reorderBtn.classList.toggle('hover:bg-purple-700', !isReordering);
             reorderBtn.classList.toggle('bg-yellow-500', isReordering);
             reorderBtn.classList.toggle('hover:bg-yellow-600', isReordering);
             reorderControls.classList.toggle('hidden', isReordering);
             if (!isReordering) {
                 originalSlideOrder = Array.from(container.children).map(el => el.getAttribute('data-id')).filter(id => id);
                 if (!sortableInstance) {
                     sortableInstance = Sortable.create(container, { handle: '.drag-handle', animation: 150, ghostClass: "sortable-ghost", dragClass: "sortable-drag", onStart: () => container.querySelectorAll('button').forEach(btn => btn.disabled = true), onEnd: () => container.querySelectorAll('button').forEach(btn => btn.disabled = false) });
                 } else { sortableInstance.option("disabled", false); }
                 container.querySelectorAll('.drag-handle').forEach(h => { h.classList.remove('opacity-50', 'cursor-default'); h.classList.add('cursor-grab'); });
                 container.querySelectorAll('.slide-actions, .edit-btn').forEach(el => el.classList.add('hidden'));
             } else { cancelReorder(); }
         }

         function cancelReorder() {
            if (!currentUser?.isAdmin) return;
             const reorderBtn = document.getElementById('reorder-btn');
             const reorderControls = document.getElementById('reorder-controls');
             reorderBtn.textContent = 'Átrendezés mód';
             reorderBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
             reorderBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
             reorderControls.classList.add('hidden');
             if (sortableInstance) sortableInstance.option("disabled", true);
             renderSlides();
         }

         async function saveReorder() {
            if (!currentUser?.isAdmin) return showNotification('Nincs jogosultságod!', true);
             if (!sortableInstance) return;
             const container = document.getElementById('slides-container');
             const slides = Array.from(container.children);
             try {
                 await firestore.collection('logs').add({ eventType: "Diák átrendezése", details: "Új sorrend mentve", user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                 const batch = firestore.batch();
                 slides.forEach((slideElement, index) => {
                     const slideId = slideElement.getAttribute('data-id');
                     if (slideId) { const slideRef = firestore.collection('slides').doc(slideId); batch.update(slideRef, { order: index }); }
                     else { console.warn("Slide element found without data-id during reorder save:", slideElement); }
                 });
                 await batch.commit();
                 showNotification('Diák sorrendje sikeresen mentve!');
                 const reorderBtn = document.getElementById('reorder-btn');
                 const reorderControls = document.getElementById('reorder-controls');
                 reorderBtn.textContent = 'Átrendezés mód';
                 reorderBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                 reorderBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                 reorderControls.classList.add('hidden');
                 if (sortableInstance) sortableInstance.option("disabled", true);
                 renderSlides();
             } catch (error) {
                 console.error('Error saving slide order:', error);
                 showNotification('Hiba történt a sorrend mentésekor!', true);
                 cancelReorder();
             }
         }

         async function renderSlides() {
             const container = document.getElementById('slides-container');
             if (!container) return;
             container.innerHTML = getLoadingIndicatorHTML('Diák betöltése...');
             try {
                 const slidesQuery = firestore.collection('slides').orderBy("order");
                 const querySnapshot = await slidesQuery.get();
                 if (querySnapshot.empty) { container.innerHTML = '<div class="text-center p-4 text-gray-500">Nincsenek hirdetések.</div>'; return; }
                 container.innerHTML = '';
                 const slidesArray = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 slidesArray.forEach((slide) => container.appendChild(createSlideElement(slide)));
                 const reorderBtn = document.getElementById('reorder-btn');
                 const isReordering = reorderBtn?.textContent.includes('Kilépés') ?? false;
                 if (sortableInstance) sortableInstance.option("disabled", !isReordering);
                 container.querySelectorAll('.drag-handle').forEach(h => { h.classList.toggle('opacity-50', !isReordering); h.classList.toggle('cursor-grab', isReordering); h.classList.toggle('cursor-default', !isReordering); });
                 container.querySelectorAll('.slide-actions, .edit-btn').forEach(el => el.classList.toggle('hidden', isReordering));
             } catch (error) {
                 console.error('Error loading slides:', error);
                 container.innerHTML = '<div class="text-center p-4 text-red-500">Hiba a hirdetések betöltésekor!</div>';
                 showNotification('Hiba a hirdetések betöltésekor!', true);
             }
         }

         function createSlideElement(slide) {
            let contentPreview = '', typeLabel = '';
            const defaultImageUrl = 'https://placehold.co/100x60/fecaca/ef4444?text=Hiba';
            if (slide.type === 'image') { typeLabel = 'Kép'; contentPreview = `<div class="preview-image-container"><img src="${slide.content || defaultImageUrl}" alt="Slide Preview" class="preview-image" loading="lazy" onerror="this.src='${defaultImageUrl}'; this.alt='Kép Hiba'"></div>`; }
            else if (slide.type === 'embed') { typeLabel = 'Beágyazás'; contentPreview = `<div class="text-sm text-gray-500 p-2 bg-gray-100 rounded break-all">🔗 ${slide.content ? slide.content.substring(0, 50) + (slide.content.length > 50 ? '...' : '') : '[Hiányzó URL]' }</div>`; }
            else if (slide.type === 'aktuális') { typeLabel = 'Aktuális'; try { const c = JSON.parse(slide.content || '{}'); const tempDiv = document.createElement('div'); tempDiv.innerHTML = c.firstLine || ''; const fL = tempDiv.textContent || tempDiv.innerText || '[Nincs cím]'; tempDiv.innerHTML = c.text || ''; const mT = tempDiv.textContent || tempDiv.innerText || '[Nincs szöveg]'; contentPreview = `<div class="slide-preview-container bg-gray-100 p-2 rounded"><div class="font-semibold text-sm truncate" title="${fL}">${fL}</div><div class="slide-preview-text" title="${mT}">${mT}</div></div>`; } catch (e) { contentPreview = '<div class="text-gray-500 p-2 bg-red-100 rounded">Formátum hiba</div>'; } }
            else { typeLabel = 'Ismeretlen'; contentPreview = '<div class="text-gray-500">?</div>'; }
             const slideElement = document.createElement('div');
             const statusBorder = slide.active ? 'border-blue-500' : 'border-gray-300';
             const statusBg = slide.active ? 'bg-white' : 'bg-gray-100 opacity-70';
             slideElement.className = `slide-item p-4 rounded-lg border ${statusBorder} ${statusBg} flex flex-col sm:flex-row items-start sm:items-center gap-4`;
             slideElement.setAttribute('data-id', slide.id);
             const statusText = slide.active ? 'Aktív' : 'Inaktív';
             const statusTextColor = slide.active ? 'text-green-600' : 'text-gray-500';
             slideElement.innerHTML = `
                 <div class="drag-handle opacity-50 cursor-default self-center sm:self-auto text-gray-400 hover:text-gray-600 transition-colors" title="Átrendezéshez kattints az 'Átrendezés mód' gombra"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg></div>
                 <div class="w-full sm:w-1/4 flex-shrink-0">${contentPreview}</div>
                 <div class="flex-grow min-w-0 w-full sm:w-auto"><strong>${typeLabel}</strong> <span class="text-xs ${statusTextColor}">(${statusText})</span><br><small class="text-gray-600">${slide.startDate || '?'} → ${slide.endDate || '?'}</small><br><small class="text-gray-600 block truncate" title="${slide.comment || ''}">Megjegyzés: ${slide.comment || 'Nincs'}</small></div>
                 <div class="slide-actions flex flex-row flex-wrap gap-2 self-end sm:self-center flex-shrink-0 mt-2 sm:mt-0 w-full sm:w-auto justify-end">
                     <button data-action="edit-slide" class="edit-btn">Szerk.</button>
                     <button data-action="toggle-slide" class="text-white px-2 py-1 rounded text-xs ${slide.active ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-500 hover:bg-green-600'}">${slide.active ? 'Elrejt' : 'Aktív'}</button>
                     <button data-action="delete-slide" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 text-xs">Töröl</button>
                 </div>`;
             return slideElement;
         }

        async function renderEmergencySlides() {
             const container = document.getElementById('emergency-slides-container');
             if (!container) return;
             container.innerHTML = getLoadingIndicatorHTML('Haváriák betöltése...');
             try {
                 const querySnapshot = await firestore.collection('emergency_slides').get();
                 if (querySnapshot.empty) { container.innerHTML = '<div class="text-center p-4 text-gray-500">Nincsenek havária diák.</div>'; return; }
                 container.innerHTML = '';
                 const slidesArray = [];
                  querySnapshot.forEach((doc) => slidesArray.push({ id: doc.id, ...doc.data() }));
                  slidesArray.forEach((slide) => container.appendChild(createEmergencySlideElement(slide)));
             } catch (error) {
                 console.error('Error loading emergency slides:', error);
                 container.innerHTML = '<div class="text-center p-4 text-red-500">Hiba a haváriák betöltésekor!</div>';
                 showNotification('Hiba a haváriák betöltésekor!', true);
             }
         }

         function createEmergencySlideElement(slide) {
             const slideElement = document.createElement('div');
             slideElement.className = `slide-item ${slide.active ? 'border-l-4 border-red-500 bg-white' : 'border-l-4 border-gray-300 bg-gray-50 opacity-80'} p-4 mb-3 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4`;
             slideElement.setAttribute('data-id', slide.id);
             let previewHTML = '';
             if (slide.type === 'image') { previewHTML = `<div class="preview-image-container w-full sm:w-auto"><img src="${slide.content}" alt="Havária kép" class="preview-image max-w-[80%] sm:max-w-[100px] max-h-[100px] sm:max-h-[60px] object-contain border rounded"></div>`; }
             else if (slide.type === 'embed') { previewHTML = `<div class="text-sm text-gray-500 break-all w-full sm:w-auto">🔗 ${slide.content.substring(0,30)}...</div>`; }
             slideElement.innerHTML = `
                 <div class="flex-1 flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full">
                     ${previewHTML}
                     <div class="w-full sm:w-auto">
                         <strong>HAVÁRIA - ${slide.type === 'image' ? 'Kép' : 'Beágyazott link'}</strong>${slide.active ? '<span class="text-red-600 font-bold ml-2">(Aktív)</span>' : ''}<br>
                         <small class="text-gray-600">Megjegyzés: ${escapeHtml(slide.comment || 'Nincs megjegyzés')}</small>
                     </div>
                 </div>
                 <div class="slide-actions flex flex-row flex-wrap gap-2 self-end sm:self-center flex-shrink-0 mt-2 sm:mt-0 w-full sm:w-auto justify-end">
                     <button data-action="toggle-emergency" class="text-white px-2 py-1 rounded text-xs ${slide.active ? 'bg-gray-500 hover:bg-gray-600' : 'bg-red-600 hover:bg-red-700'}">${slide.active ? 'Deaktivál' : 'Aktivál'}</button>
                     <button data-action="delete-emergency" class="bg-black text-white px-2 py-1 rounded hover:bg-gray-700 text-xs">Töröl</button>
                 </div>`;
             return slideElement;
         }

        async function editSlide(id) {
            if (!currentUser?.isAdmin) return showNotification('Nincs jogosultságod ehhez!', true);
             if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true);
             try {
                 const slideRef = firestore.collection('slides').doc(id);
                 const slideDoc = await slideRef.get();
                 if (!slideDoc.exists) return showNotification("A dia nem található.", true);
                 const slideData = slideDoc.data();
                 currentEditingSlideId = id;
                 currentEditingSlideType = slideData.type;
                 setIndicatorState(editUploadIndicator, 'idle');
                 editSaveBtn.disabled = false;
                 editSlideImageUpload.value = '';
                 handleImagePreview(editSlideImageUpload, editImagePreview, editUploadIndicator, editSaveBtn);
                 editCurrentImageUrlInput.value = '';
                 document.getElementById('edit-slide-type').value = slideData.type;
                 if (slideData.type === 'image') {
                     editCurrentImageUrlInput.value = slideData.content || '';
                     editImagePreview.src = slideData.content || '#';
                     editImagePreview.classList.toggle('hidden', !slideData.content);
                     document.getElementById('edit-slide-content').value = '';
                 } else if (slideData.type === 'aktuális') {
                     document.getElementById('edit-slide-content').value = '';
                     try { const c = JSON.parse(slideData.content || '{}'); document.getElementById('edit-first-line').innerHTML = c.firstLine || ''; document.getElementById('edit-text-content').innerHTML = c.text || ''; } catch (e) { /* Hiba */ }
                     editUpdateFirstLineCounter(); editUpdateCharCounter();
                 } else { document.getElementById('edit-slide-content').value = slideData.content || ''; editImagePreview.classList.add('hidden'); }
                 document.getElementById('edit-start-date').value = slideData.startDate || '';
                 document.getElementById('edit-end-date').value = slideData.endDate || '';
                 document.getElementById('edit-comment').value = slideData.comment || '';
                 toggleEditSlideTypeFields();
                 openEditPopup();
             } catch (error) {
                 console.error('Error preparing slide edit:', error);
                 showNotification('Hiba a szerkesztés előkészítésekor!', true);
             }
         }

        async function saveEditedSlide() {
             if (!currentEditingSlideId || !currentUser?.isAdmin) return showNotification('Nincs jogosultságod!', true);
             if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true);
             const type = document.getElementById('edit-slide-type').value;
             const startDate = document.getElementById('edit-start-date').value;
             const endDate = document.getElementById('edit-end-date').value;
             const comment = document.getElementById('edit-comment').value;
             const fileInput = editSlideImageUpload;
             editSaveBtn.disabled = true;
             editSaveBtn.textContent = 'Mentés...';
             let updateData = { type, startDate, endDate, comment: comment.trim() };
             let logDetails = `Dia frissítve (ID: ${currentEditingSlideId}, Típus: ${type})`;
             let newImageUrl = null;
             try {
                 if (!startDate || !endDate) throw new Error('Kezdő és végdátum kötelező!');
                 if (new Date(startDate) > new Date(endDate)) throw new Error('A kezdő dátum nem lehet későbbi a végdátumnál!');
                 if (type === 'image') {
                     if (fileInput.files && fileInput.files.length > 0) { newImageUrl = await uploadImageToImgBB(fileInput.files[0], editUploadIndicator, editSaveBtn); updateData.content = newImageUrl; logDetails += `, Tartalom: Új kép feltöltve`; }
                     else { updateData.content = editCurrentImageUrlInput.value || ''; if (!updateData.content) throw new Error('Kép típus választva, de nincs kép kiválasztva vagy mentve.'); logDetails += `, Tartalom: Meglévő kép`; }
                 } else if (type === 'aktuális') {
                     const firstLineText = document.getElementById('edit-first-line').innerText;
                     const textContentText = document.getElementById('edit-text-content').innerText;
                     if (firstLineText.length > 20) throw new Error('Az első sor max 20 karakter!');
                     if (textContentText.length > 100) throw new Error('A szöveg max 100 karakter!');
                     updateData.content = JSON.stringify({ presetLink: "https://i.ibb.co/Hfkcjrct/aktu-lis-sablon-1.png", firstLine: document.getElementById('edit-first-line').innerHTML, text: document.getElementById('edit-text-content').innerHTML, style: {} });
                     logDetails += `, Tartalom: Aktuális`;
                 } else {
                     const content = document.getElementById('edit-slide-content').value;
                     if (!content || !content.trim()) throw new Error('Beágyazott link megadása kötelező!');
                     try { new URL(content); } catch (_) { throw new Error('Érvénytelen URL formátum!'); }
                     updateData.content = content;
                     logDetails += `, Tartalom: Beágyazás`;
                 }
                 await firestore.collection('logs').add({ eventType: "Dia szerkesztés", details: logDetails, user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                 await firestore.collection('slides').doc(currentEditingSlideId).update(updateData);
                 showNotification('Dia sikeresen frissítve!');
                 closeEditPopup();
                 renderSlides();
             } catch (error) {
                 console.error('Error saving edited slide:', error);
                 showNotification(`Hiba a mentéskor: ${error.message}`, true);
             } finally {
                 editSaveBtn.disabled = false;
                 editSaveBtn.textContent = 'Mentés';
                 if (type !== 'image' || !fileInput.files || fileInput.files.length === 0) { setIndicatorState(editUploadIndicator, 'idle'); }
             }
         }

        async function toggleSlide(id) {
            if (!currentUser?.isAdmin) return showNotification('Nincs jogosultságod!', true);
             try {
                 const slideRef = firestore.collection('slides').doc(id);
                 const slideDoc = await slideRef.get();
                 if (!slideDoc.exists) return showNotification('A dia nem található.', true);
                 const newStatus = !slideDoc.data().active;
                 await firestore.collection('logs').add({ eventType: "Dia állapot", details: `Dia ${newStatus ? 'aktíválva' : 'elrejtve'} (ID: ${id})`, user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                 await slideRef.update({ active: newStatus });
                 showNotification(`Hirdetés ${newStatus ? 'aktíválva' : 'elrejtve'}!`);
                 renderSlides();
             } catch (error) {
                 console.error('Error toggling slide status:', error);
                 showNotification('Hiba az állapot váltásakor!', true);
             }
         }

        function deleteSlide(id) {
             if (!currentUser?.isAdmin) return showNotification('Nincs jogosultságod!', true);
             showConfirmPopup('Biztosan törlöd ezt a hirdetést? Ez a művelet nem vonható vissza.', async () => {
                 try {
                     await firestore.collection('logs').add({ eventType: "Dia törlés", details: `Normál dia törölve (ID: ${id})`, user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                     await firestore.collection('slides').doc(id).delete();
                     showNotification('Hirdetés törölve!');
                     renderSlides();
                 } catch (error) { console.error('Error deleting slide:', error); showNotification('Hiba a dia törlésekor!', true); }
             });
         }

         async function toggleEmergency(id) {
              if (!currentUser?.isAdmin) return showNotification('Nincs jogosultságod!', true);
             try {
                 const slideRef = firestore.collection('emergency_slides').doc(id);
                 const slideDoc = await slideRef.get();
                 if (!slideDoc.exists) return showNotification('A havária dia nem található.', true);
                 const newStatus = !slideDoc.data().active;
                 await firestore.collection('logs').add({ eventType: "Havária állapot", details: `Havária ${newStatus ? 'aktiválva' : 'deaktiválva'} (ID: ${id})`, user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                 const batch = firestore.batch();
                 if (newStatus) {
                     const emergenciesSnapshot = await firestore.collection('emergency_slides').get();
                     emergenciesSnapshot.docs.forEach(d => batch.update(d.ref, { active: d.id === id }));
                     await batch.commit();
                     showNotification('Havária aktiválva! A többi automatikusan deaktiválva lett.');
                 } else { await slideRef.update({ active: false }); showNotification('Havária deaktiválva.'); }
                 renderEmergencySlides();
             } catch (error) { console.error('Error toggling emergency status:', error); showNotification('Hiba a havária állapotának váltásakor!', true); }
         }

        function deleteEmergency(id) {
             if (!currentUser?.isAdmin) return showNotification('Nincs jogosultságod!', true);
             showConfirmPopup('Biztosan törlöd ezt a haváriát? Ez a művelet nem vonható vissza.', async () => {
                 try {
                     await firestore.collection('logs').add({ eventType: "Havária törlés", details: `Havária törölve (ID: ${id})`, user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                     await firestore.collection('emergency_slides').doc(id).delete();
                     showNotification('Havária törölve!');
                     renderEmergencySlides();
                 } catch (error) { console.error('Error deleting emergency slide:', error); showNotification('Hiba a havária törlésekor!', true); }
             });
         }

         function monitorDevices() {
             const devicesRef = firestore.collection('devices');
             const devicesList = document.getElementById('devices-list');
             if (!devicesList) return;
             devicesRef.onSnapshot((snapshot) => {
                 const onlineCountEl = document.getElementById('online-count');
                 const availabilityEl = document.getElementById('availability-percentage');
                 let onlineCount = 0;
                 devicesList.innerHTML = '';
                 if (snapshot.empty) {
                     devicesList.innerHTML = '<div class="p-3 text-gray-500">Nincsenek regisztrált eszközök.</div>';
                     if(onlineCountEl) onlineCountEl.textContent = 0;
                     if(availabilityEl) availabilityEl.textContent = '0%';
                     return;
                 }
                 snapshot.forEach((doc) => {
                     const device = doc.data();
                     const deviceId = doc.id;
                     const lastHeartbeat = device.lastHeartbeat?.toDate ? device.lastHeartbeat.toDate() : null;
                     const isOnline = lastHeartbeat && (Date.now() - lastHeartbeat.getTime()) < 2 * 60 * 1000;
                     if (isOnline) onlineCount++;
                     devicesList.appendChild(createDeviceElement(deviceId, device, isOnline, lastHeartbeat));
                 });
                 if(onlineCountEl) onlineCountEl.textContent = onlineCount;
                 const availabilityPercent = TOTAL_DEVICES > 0 ? Math.round((onlineCount / TOTAL_DEVICES) * 100) : 0;
                 if(availabilityEl) availabilityEl.textContent = `${availabilityPercent}%`;
             }, (error) => {
                 console.error("Error monitoring devices:", error);
                 devicesList.innerHTML = '<div class="p-3 text-red-500">Hiba az eszközök figyelésekor.</div>';
                 document.getElementById('online-count').textContent = '?';
                 document.getElementById('availability-percentage').textContent = '?%';
                 showNotification("Hiba az eszközök figyelésekor!", true);
             });
         }

        function createDeviceElement(deviceId, device, isOnline, lastHeartbeat) {
             const deviceElement = document.createElement('div');
             deviceElement.className = `p-3 mb-2 rounded border-l-4 ${isOnline ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;
             deviceElement.setAttribute('data-device-id', deviceId);
             const formattedHeartbeat = lastHeartbeat ? lastHeartbeat.toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'medium'}) : 'Soha';
             const canRefresh = currentUser?.isAdmin === true;
             deviceElement.innerHTML = `
                 <div class="flex flex-wrap justify-between items-center gap-2">
                     <span class="font-semibold break-all" title="${escapeHtml(device.name || deviceId)}">${escapeHtml(device.name || deviceId)}</span>
                     <span class="text-xs font-medium px-2 py-0.5 rounded-full ${isOnline ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">${isOnline ? 'Online' : 'Offline'}</span>
                     <button data-action="toggle-details" class="text-blue-600 hover:text-blue-800 text-sm underline focus:outline-none">Részletek</button>
                 </div>
                 <div id="details-${deviceId}" class="hidden mt-2 text-sm text-gray-700 space-y-1 border-t pt-2">
                     <p><strong>ID:</strong> <span class="break-all">${escapeHtml(deviceId)}</span></p>
                     <p><strong>OS:</strong> ${escapeHtml(device.os || 'N/A')}</p>
                     <p><strong>Böngésző:</strong> ${escapeHtml(device.browser || 'N/A')}</p>
                     <p><strong>Felbontás:</strong> ${escapeHtml(device.resolution || 'N/A')}</p>
                     <p><strong>Utolsó ping:</strong> ${formattedHeartbeat}</p>
                     ${canRefresh ? `<button data-action="refresh-device" class="mt-2 w-full sm:w-auto bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-300">Oldal frissítése</button>` : ''}
                 </div>`;
             return deviceElement;
         }

        async function fetchLogs() {
            if (!currentUser?.isAdmin) {
                logEntriesContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Nincs jogosultságod a naplók megtekintéséhez.</p>';
                return;
            }
            const logEntriesContainer = document.getElementById('log-entries');
            if (!logEntriesContainer) return;
            logEntriesContainer.innerHTML = getLoadingIndicatorHTML('Naplóbejegyzések betöltése...');
            try {
                const q = firestore.collection('logs').orderBy("timestamp", "desc");
                const querySnapshot = await q.get();
                if (querySnapshot.empty) { logEntriesContainer.innerHTML = '<div class="p-3 text-center text-gray-500">Nincsenek naplóbejegyzések.</div>'; return; }
                const logEntriesHTML = querySnapshot.docs.map(doc => createLogEntryElement(doc.data())).join('');
                logEntriesContainer.innerHTML = logEntriesHTML;
            } catch (error) {
                console.error('Error loading logs:', error);
                logEntriesContainer.innerHTML = `<div class="p-3 text-red-600 bg-red-50 rounded">Hiba a naplók betöltésekor.</div>`;
                showNotification('Hiba a naplók betöltésekor!', true);
            }
        }
        function createLogEntryElement(logData) {
             const timestamp = logData.timestamp?.toDate ? logData.timestamp.toDate() : null;
             const formattedTime = timestamp ? timestamp.toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'medium'}) : '-';
             return `
                 <div class="log-entry px-3 py-2 hover:bg-gray-100 transition duration-150">
                     <div class="flex flex-col sm:flex-row justify-between items-start gap-1">
                         <div class="flex-1 min-w-0">
                             <p class="font-semibold text-sm text-gray-800">${escapeHtml(logData.eventType || 'Esemény')}</p>
                             <p class="text-xs text-gray-600 break-words">${escapeHtml(logData.details || '-')}</p>
                         </div>
                         <div class="text-right flex-shrink-0 mt-1 sm:mt-0">
                             <p class="text-xs text-gray-500 whitespace-nowrap">${formattedTime}</p>
                             <p class="text-xs text-gray-500 truncate" title="${escapeHtml(logData.user || '')}">${escapeHtml(logData.user || '-')}</p>
                         </div>
                     </div>
                 </div>`;
         }
         // toggleLogCard már nem szükséges, a showAdminSection kezeli a logok szekció megjelenítését
         function refreshLogs() {
             if (!currentUser?.isAdmin) return;
             fetchLogs();
         }

        async function refreshAllDevices() {
             if (!currentUser?.isAdmin) { showNotification('Nincs jogosultságod ehhez a művelethez!', true); return; }
             console.log("Refreshing all devices...");
             try {
                await firestore.collection('logs').add({ eventType: "Eszközök frissítése (mind)", details: "Admin kezdeményezte", user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                const devicesSnapshot = await firestore.collection('devices').get();
                const batch = firestore.batch();
                devicesSnapshot.docs.forEach(doc => { const deviceRef = doc.ref; batch.update(deviceRef, { refresh: Date.now() }); });
                await batch.commit();
                showNotification('Frissítési parancs elküldve az összes eszköznek!');
            } catch (error) { console.error('Error refreshing all devices:', error); showNotification('Hiba az eszközök frissítésekor!', true); }
         }

         async function refreshDevice(deviceId) {
             if (!currentUser?.isAdmin) { showNotification('Nincs jogosultságod ehhez a művelethez!', true); return; }
             if (!deviceId) return showNotification('Érvénytelen eszköz ID.', true);
              console.log("Refreshing device:", deviceId);
             try {
                await firestore.collection('logs').add({ eventType: "Eszköz frissítése (egyedi)", details: `Eszköz: ${deviceId}`, user: currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                const deviceRef = firestore.collection('devices').doc(deviceId);
                await deviceRef.update({ refresh: Date.now() });
                showNotification(`Frissítési parancs elküldve: ${deviceId}`);
            } catch (error) { console.error('Error refreshing device:', error); showNotification('Hiba az eszköz frissítésekor!', true); }
         }

        async function uploadImageToImgBB(file, indicatorElement, relatedButton) {
             if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_API_KEY_HERE') { throw new Error("Hiányzó ImgBB API kulcs!"); }
             if (!file) { throw new Error("Nincs fájl kiválasztva."); }
             isUploading = true;
             if (relatedButton) relatedButton.disabled = true;
             setIndicatorState(indicatorElement, 'uploading');
             const formData = new FormData();
             formData.append('image', file);
             try {
                 const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                 if (!response.ok) { const errorData = await response.json(); throw new Error(`ImgBB hiba: ${errorData?.error?.message || response.statusText}`); }
                 const result = await response.json();
                 if (result.success && result.data && result.data.url) {
                     setIndicatorState(indicatorElement, 'success');
                     setTimeout(() => { setIndicatorState(indicatorElement, 'idle'); }, 1500);
                     isUploading = false;
                     if (relatedButton) relatedButton.disabled = false;
                     return result.data.url;
                 } else { throw new Error("ImgBB feltöltés sikertelen."); }
             } catch (error) {
                 console.error("Error uploading to ImgBB:", error);
                 setIndicatorState(indicatorElement, 'error', error.message);
                 setTimeout(() => { setIndicatorState(indicatorElement, 'idle'); }, 3000);
                 isUploading = false;
                 if (relatedButton) relatedButton.disabled = false;
                 throw error;
             }
         }

        // --- Eseményfigyelők ---
        function setupEventListeners() {
             console.log("Setting up event listeners...");
             googleLoginButton?.addEventListener('click', handleGoogleLogin);
             loginPopupCloseButton?.addEventListener('click', () => loginPopup.classList.add('hidden'));
             closeMessageButton?.addEventListener('click', closeMessage);
             messageBox?.addEventListener('click', (event) => { if (event.target === messageBox) closeMessage(); });
             confirmCancelBtn?.addEventListener('click', () => confirmPopup.classList.remove('active'));
             editCancelBtn?.addEventListener('click', closeEditPopup);
             editSaveBtn?.addEventListener('click', saveEditedSlide);
             addSlideBtn?.addEventListener('click', addSlide);
             addEmergencyBtn?.addEventListener('click', addEmergencySlide);
             reorderBtn?.addEventListener('click', toggleReorderMode);
             document.getElementById('cancel-reorder-btn')?.addEventListener('click', cancelReorder);
             document.getElementById('save-reorder-btn')?.addEventListener('click', saveReorder);
             document.getElementById('refresh-all-devices-btn')?.addEventListener('click', refreshAllDevices);
             // document.getElementById('toggle-log-card-btn')?.addEventListener('click', toggleLogCard); // Eltávolítva
             document.getElementById('refresh-logs-btn')?.addEventListener('click', refreshLogs);
             // document.getElementById('close-log-card-btn')?.addEventListener('click', toggleLogCard); // Eltávolítva

             const slideFormTrigger = document.getElementById('toggle-slide-form-trigger');
             slideFormTrigger?.addEventListener('click', toggleSlideForm);
             const emergencyFormTrigger = document.getElementById('toggle-emergency-form-trigger');
             emergencyFormTrigger?.addEventListener('click', toggleEmergencyForm);

             document.getElementById('slide-type')?.addEventListener('change', toggleSlideTypeFields);
             document.getElementById('edit-slide-type')?.addEventListener('change', toggleEditSlideTypeFields);
             document.getElementById('emergency-slide-type')?.addEventListener('change', toggleEmergencyInputFields);

             document.getElementById('first-line')?.addEventListener('input', updateFirstLineCounter);
             document.getElementById('slide-text-content')?.addEventListener('input', updateCharCounter);
             document.getElementById('edit-first-line')?.addEventListener('input', editUpdateFirstLineCounter);
             document.getElementById('edit-text-content')?.addEventListener('input', editUpdateCharCounter);

             document.getElementById('slide-form')?.addEventListener('click', handleFormatButtonClick);
             document.getElementById('edit-popup')?.addEventListener('click', handleFormatButtonClick);

             const adminView = document.getElementById('admin-content-wrapper'); // Figyeljük a wrapper-t
             if(adminView) { adminView.addEventListener('click', handleAdminViewClicks); }

             const devicesList = document.getElementById('devices-list');
             if(devicesList) { devicesList.addEventListener('click', handleDeviceListClicks); }

             const adminNav = document.getElementById('admin-navigation');
             if (adminNav) {
                 adminNav.addEventListener('click', (event) => {
                     const button = event.target.closest('.admin-nav-button');
                     if (button && button.dataset.section) {
                         showAdminSection(button.dataset.section);
                     }
                 });
             }

             console.log("Base event listeners attached.");
         }

         // --- Eseménykezelő Delegálás (Admin Nézet) ---
        function handleAdminViewClicks(event) {
            const target = event.target;
            const button = target.closest('button');
            if (!button) return;

            const slideItem = button.closest('.slide-item[data-id]');
             if (slideItem) {
                const slideId = slideItem.dataset.id;
                const action = button.dataset.action;
                if (action === 'edit-slide') { editSlide(slideId); return; }
                if (action === 'toggle-slide') { toggleSlide(slideId); return; }
                if (action === 'delete-slide') { deleteSlide(slideId); return; }
             }
             const emergencySlideItem = button.closest('.slide-item[data-id]');
             if (emergencySlideItem && emergencySlideItem.closest('#emergency-slides-container')) {
                const slideId = emergencySlideItem.dataset.id;
                const action = button.dataset.action;
                if (action === 'toggle-emergency') { toggleEmergency(slideId); return; }
                if (action === 'delete-emergency') { deleteEmergency(slideId); return; }
             }
             // Más gombok (pl. rich text) már máshol kezelve
        }

        // --- Eseménykezelő Delegálás (Device Lista) ---
        function handleDeviceListClicks(event) {
            const target = event.target;
            const button = target.closest('button');
            if (!button) return;

            const deviceItem = button.closest('[data-device-id]');
            if (!deviceItem) return;
            const deviceId = deviceItem.dataset.deviceId;

            const action = button.dataset.action;
            if (action === 'toggle-details') {
                toggleDetails(deviceId);
                return;
            }
            if (action === 'refresh-device') {
                refreshDevice(deviceId);
                return;
            }
        }


         // --- Format Gombok Kezelése ---
         function handleFormatButtonClick(event) {
            const button = event.target.closest('.format-button, .edit-format-button');
            if (!button) return;
            const command = button.dataset.format;
            const editorId = button.closest('#slide-form') ? 'slide-text-content' : 'edit-text-content';
            const editorElement = document.getElementById(editorId);

            if (command && editorElement) {
                document.execCommand(command, false, null);
                editorElement.focus();
                if (editorId === 'slide-text-content') updateCharCounter();
                else if (editorId === 'edit-text-content') editUpdateCharCounter();
            }
        }


        // --- Drag & Drop Listener Beállítása ---
        function setupDragDropListeners() {
            document.querySelectorAll('.drop-zone').forEach(setupDragDrop);
        }
        function setupDragDrop(dropZoneElement) {
             const fileInput = document.getElementById(dropZoneElement.dataset.targetInput);
             const previewElement = document.getElementById(dropZoneElement.dataset.targetPreview);
             let indicatorElement, relatedButton;
             if (dropZoneElement.id === 'add-image-input-group') { indicatorElement = addUploadIndicator; relatedButton = addSlideBtn; }
             else if (dropZoneElement.id === 'edit-image-input-group') { indicatorElement = editUploadIndicator; relatedButton = editSaveBtn; }
             else if (dropZoneElement.id === 'emergency-image-input-group') { indicatorElement = emergencyUploadIndicator; relatedButton = addEmergencyBtn; }
             if (!fileInput || !previewElement) { console.error("Drag & Drop setup failed for", dropZoneElement); return; }
             ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { dropZoneElement.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false); });
             ['dragenter', 'dragover'].forEach(eventName => { dropZoneElement.addEventListener(eventName, () => dropZoneElement.classList.add('dragover'), false); });
             ['dragleave', 'drop'].forEach(eventName => { dropZoneElement.addEventListener(eventName, () => dropZoneElement.classList.remove('dragover'), false); });
             dropZoneElement.addEventListener('drop', (e) => {
                 const files = e.dataTransfer.files;
                 setIndicatorState(indicatorElement, 'idle');
                 if (relatedButton) relatedButton.disabled = false;
                 if (files.length > 0 && files[0].type.startsWith('image/')) { fileInput.files = files; handleImagePreview(fileInput, previewElement, indicatorElement, relatedButton); }
                 else if (files.length > 0) { showNotification('Csak képfájlokat lehet behúzni!', true); }
             }, false);
             dropZoneElement.addEventListener('click', (e) => { if (e.target !== fileInput) { fileInput.click(); } });
        }

        // --- Függvények definíciói ---
        function toggleSlideForm() {
            const form = document.getElementById('slide-form');
            const toggleIcon = document.getElementById('slide-form-toggle');
            form?.classList.toggle('hidden');
            toggleIcon?.classList.toggle('rotate-180', !form?.classList.contains('hidden'));
         };
         function toggleEmergencyForm() {
            const form = document.getElementById('emergency-slide-form');
            const toggleIcon = document.getElementById('emergency-form-toggle');
            form?.classList.toggle('hidden');
            toggleIcon?.classList.toggle('rotate-180', !form?.classList.contains('hidden'));
         };
         function toggleSlideTypeFields() {
             const slideType = document.getElementById('slide-type')?.value;
             const regularFields = document.getElementById('regular-slide-fields');
             const aktualisFields = document.getElementById('aktualis-slide-fields');
             const imageInputGroup = document.getElementById('add-image-input-group');
             const urlInputGroup = document.getElementById('add-url-input-group');
             if(regularFields) regularFields.classList.toggle('hidden', slideType === 'aktuális');
             if(aktualisFields) aktualisFields.classList.toggle('hidden', slideType !== 'aktuális');
             if(imageInputGroup) imageInputGroup.classList.toggle('hidden', slideType !== 'image');
             if(urlInputGroup) urlInputGroup.classList.toggle('hidden', slideType !== 'embed');
             if (slideType !== 'image') { const input = document.getElementById('slide-image-upload'); if(input) input.value = ''; handleImagePreview(addSlideImageUpload, addImagePreview, addUploadIndicator, addSlideBtn); }
             if (slideType !== 'embed') { const input = document.getElementById('slide-content'); if(input) input.value = '';}
             if (slideType !== 'aktuális') {
                 const firstLine = document.getElementById('first-line'); if(firstLine) firstLine.innerHTML = '';
                 const textContent = document.getElementById('slide-text-content'); if(textContent) textContent.innerHTML = '';
                 updateFirstLineCounter(); updateCharCounter();
             }
         };
         function toggleEditSlideTypeFields() {
             const slideType = document.getElementById('edit-slide-type')?.value;
             const textContentGroup = document.getElementById('edit-text-content-group');
             const imageInputGroup = document.getElementById('edit-image-input-group');
             const urlInputGroup = document.getElementById('edit-url-input-group');
             if(imageInputGroup) imageInputGroup.classList.toggle('hidden', slideType !== 'image');
             if(urlInputGroup) urlInputGroup.classList.toggle('hidden', slideType !== 'embed');
             if(textContentGroup) textContentGroup.classList.toggle('hidden', slideType !== 'aktuális');
             if (slideType !== 'image') { const input = document.getElementById('edit-slide-image-upload'); if(input) input.value = ''; handleImagePreview(editSlideImageUpload, editImagePreview, editUploadIndicator, editSaveBtn); }
             if (slideType !== 'embed') { const input = document.getElementById('edit-slide-content'); if(input) input.value = '';}
             if (slideType !== 'aktuális') {
                 const firstLine = document.getElementById('edit-first-line'); if(firstLine) firstLine.innerHTML = '';
                 const textContent = document.getElementById('edit-text-content'); if(textContent) textContent.innerHTML = '';
                 editUpdateFirstLineCounter(); editUpdateCharCounter();
             }
         };
        function toggleEmergencyInputFields() {
            const slideType = document.getElementById('emergency-slide-type')?.value;
            const imageGroup = document.getElementById('emergency-image-input-group');
            const urlGroup = document.getElementById('emergency-url-input-group');
            if(imageGroup) imageGroup.classList.toggle('hidden', slideType !== 'image');
            if(urlGroup) urlGroup.classList.toggle('hidden', slideType === 'image');
            if (slideType !== 'image') { const input = document.getElementById('emergency-slide-image-upload'); if(input) input.value = ''; handleImagePreview(emergencySlideImageUpload, emergencyImagePreview, emergencyUploadIndicator, addEmergencyBtn); }
            if (slideType !== 'embed') { const input = document.getElementById('emergency-slide-content'); if(input) input.value = '';}
        };
         function formatText(command) { document.execCommand(command, false, null); document.getElementById('slide-text-content')?.focus(); updateCharCounter(); };
         function editFormatText(command) { document.execCommand(command, false, null); document.getElementById('edit-text-content')?.focus(); editUpdateCharCounter(); };
         function updateFirstLineCounter() { updateCounter('first-line', 'first-line-counter', 20); };
         function editUpdateFirstLineCounter() { updateCounter('edit-first-line', 'edit-first-line-counter', 20); };
         function updateCharCounter() { updateCounter('slide-text-content', 'char-counter', 100); };
         function editUpdateCharCounter() { updateCounter('edit-text-content', 'edit-char-counter', 100); };
         function toggleDetails(deviceId) {
             const detailsElement = document.getElementById(`details-${deviceId}`);
             detailsElement?.classList.toggle('hidden');
         };

        function showLoginPopup(message = "Ehhez a művelethez bejelentkezés szükséges.") {
             loginPopupMessage.textContent = message;
             loginPopup.classList.remove('hidden');
         }

        // --- Alkalmazás Indítása ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupDragDropListeners();
        });

    </script>

</body>
</html>