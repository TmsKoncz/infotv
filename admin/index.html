<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfoTV Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Jost:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Alap body stílusok */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background: linear-gradient(to bottom right, #E0F2FE, #EDE9FE, #FCE7F3); /* Tailwind: from-blue-100 via-purple-100 to-pink-100 */
        }

        /* Login form step animációk */
        .form-step { transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; width: 100%; }
        .form-step.hidden-step { opacity: 0; transform: translateX(20px); pointer-events: none; position: absolute; top: 0; left: 0; }

        /* Notification animációk */
        @keyframes slideInUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes slideOutDown { from { transform: translate(-50%, 0); opacity: 1; } to { transform: translate(-50%, 100%); opacity: 0; } }
        .notification-enter { animation: slideInUp 0.3s ease-out forwards; }
        .notification-leave { animation: slideOutDown 0.3s ease-in forwards; }

        /* Rich text editor - Jost font */
        .rich-text-content { font-family: 'Jost', sans-serif; }

        /* Scrollbar styling */
        .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #a0aec0 #edf2f7; }
        .scrollbar-thin::-webkit-scrollbar { width: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #edf2f7; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 10px; border: 2px solid #edf2f7; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background-color: #718096; }

        /* SortableJS ghost class */
        .sortable-ghost { background-color: #dbeafe; opacity: 0.7; }
        .sortable-drag { opacity: 0.9; }

        /* Képfeltöltés előnézet */
        .image-preview { max-height: 60px; margin-top: 5px; border-radius: 4px; border: 1px solid #e5e7eb; }

        /* Upload Indicator Styling */
        .upload-indicator {
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* space-x-2 */
            margin-top: 0.5rem; /* mt-2 */
            font-size: 0.875rem; /* text-sm */
        }
        .upload-indicator.uploading { display: flex; color: #3b82f6; /* text-blue-600 */ }
        .upload-indicator.success { display: flex; color: #10b981; /* text-green-500 */ }
        .upload-indicator.error { display: flex; color: #ef4444; /* text-red-500 */ }

        .upload-indicator .spinner { display: none; }
        .upload-indicator.uploading .spinner { display: inline-block; }
        .upload-indicator .checkmark { display: none; }
        .upload-indicator.success .checkmark { display: inline-block; }
        .upload-indicator .crossmark { display: none; }
        .upload-indicator.error .crossmark { display: inline-block; }

        /* Drag & Drop Styling */
        .drop-zone {
            border: 2px dashed #cbd5e1; /* Tailwind gray-300 */
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
            text-align: center;
            cursor: pointer;
        }
        .drop-zone.dragover {
            border-color: #3b82f6; /* Tailwind blue-500 */
            background-color: #eff6ff; /* Tailwind blue-50 */
        }
        .drop-zone-emergency.dragover {
             border-color: #ef4444; /* Tailwind red-500 */
             background-color: #fee2e2; /* Tailwind red-50 */
        }

        /* Slide Preview Styling */
        .preview-image {
            max-width: 100px; max-height: 60px; object-fit: contain;
            border-radius: 4px; border: 1px solid #e5e7eb; display: block; margin-bottom: 4px;
        }
        .slide-preview-container { max-width: 150px; overflow: hidden; }
        .slide-preview-text {
            font-size: 0.75rem; line-height: 1.2; color: #4b5563; max-height: 3.6em;
            overflow: hidden; text-overflow: ellipsis; display: -webkit-box;
            -webkit-line-clamp: 3; -webkit-box-orient: vertical;
        }

        /* Log Entry Styling */
        .log-entry { border-bottom: 1px solid #e5e7eb; }
        .log-entry:last-child { border-bottom: none; }

        /* Notification Styling */
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }

        /* Button Styling */
        .edit-btn, .slide-actions button {
            padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.375rem;
            transition: background-color 0.2s; line-height: 1.2;
        }
        .edit-btn { background-color: #d1d5db; color: #374151; }
        .edit-btn:hover { background-color: #9ca3af; }
        /* Disabled button style */
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Device Details Styling */
        #devices-list .font-semibold {
             max-width: 150px; white-space: nowrap; overflow: hidden;
             text-overflow: ellipsis; display: inline-block; vertical-align: middle;
        }

        /* Emergency Slide Item Styling (Reverted) */
        .slide-item.border-l-4.border-red-500 {
             padding: 1rem; margin-bottom: 0.75rem; border-radius: 0.5rem; background-color: #fff;
             display: flex; justify-content: space-between; align-items: center; gap: 1rem;
        }
        .slide-item.border-l-4.border-gray-300 {
             padding: 1rem; margin-bottom: 0.75rem; border-radius: 0.5rem; background-color: #f9fafb;
             opacity: 0.8; display: flex; justify-content: space-between; align-items: center; gap: 1rem;
        }

        /* General Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            border: 3px solid rgba(59, 130, 246, 0.3); /* border-blue-500 opacity 30% */
            border-radius: 50%;
            border-top-color: #3b82f6; /* border-blue-500 */
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* p-4 */
            color: #6b7280; /* text-gray-500 */
        }
        .loading-container span { margin-top: 0.5rem; /* mt-2 */ }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="loginContainer" class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-md relative overflow-hidden">
        <div id="emailStep" class="form-step">
            <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">InfoTV Admin Bejelentkezés</h2>
            <form id="emailForm">
                <div class="mb-6">
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">E-mail cím</label>
                    <input type="email" id="loginEmail" name="email" required autocomplete="email"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           placeholder="nev@example.com">
                     <p id="emailError" class="text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Tovább
                </button>
            </form>
            <div class="mt-6 text-center text-sm">
                <a href="#" id="forgotPasswordLink" class="text-blue-600 hover:underline">Elfelejtett jelszó?</a>
                <span class="text-gray-400 mx-2">|</span>
                <a href="mailto:fejleszto@example.com" class="text-gray-600 hover:underline">Kapcsolat a fejlesztővel</a>
            </div>
        </div>
        <div id="passwordStep" class="form-step hidden-step">
             <button id="backButton" class="absolute top-4 left-4 text-gray-500 hover:text-gray-700 transition" aria-label="Vissza">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <div class="flex flex-col items-center mb-6">
                <img id="gravatarImage" src="https://placehold.co/150x150/e2e8f0/cbd5e1?text=Profilk%C3%A9p" alt="Profilkép"
                     class="w-24 h-24 md:w-32 md:h-32 rounded-full mb-4 border-4 border-gray-200 shadow-md"
                     onerror="this.onerror=null; this.src='https://placehold.co/150x150/e2e8f0/cbd5e1?text=Profilk%C3%A9p';">
                 <p id="welcomeMessage" class="text-lg font-medium text-gray-700 text-center"></p>
            </div>
            <form id="actualLoginForm">
                 <input type="hidden" id="hiddenEmail" name="email">
                 <div class="mb-6">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Jelszó</label>
                    <input type="password" id="loginPassword" name="password" required autocomplete="current-password"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           placeholder="••••••••">
                     <p id="passwordError" class="text-red-600 text-sm mt-1 hidden"></p>
                 </div>
                <button type="submit"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Bejelentkezés
                </button>
            </form>
             <div class="mt-6 text-center text-sm">
                <a href="#" id="forgotPasswordLink2" class="text-blue-600 hover:underline">Elfelejtett jelszó?</a>
            </div>
        </div>
    </div>

    <div id="messageBox" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[1060]">
         <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border-l-4 border-blue-500">
             <p id="messageText" class="mb-4 text-gray-700"></p>
             <button id="closeMessageButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Rendben</button>
         </div>
    </div>

    <div id="notification" class="notification fixed bottom-4 left-1/2 transform -translate-x-1/2 max-w-md w-[calc(100%-2rem)] text-white px-4 py-3 rounded-md shadow-lg z-[1050] text-center hidden"></div>

    <div id="confirm-popup" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-xl shadow-lg z-[1040] w-[90%] max-w-md hidden">
        <h3 class="text-lg font-semibold mb-2 text-gray-800">Megerősítés</h3>
        <p id="confirm-message" class="mb-4 text-gray-600"></p>
        <div class="flex flex-col sm:flex-row justify-end gap-3">
            <button id="confirmCancelBtn" class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-200">Mégse</button>
            <button id="confirmOkBtn" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">Igen, törlés</button>
        </div>
    </div>
    <div id="confirm-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm z-[1030] hidden"></div>

    <div id="edit-popup" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-xl shadow-lg z-[1040] w-[90%] max-w-lg max-h-[90vh] overflow-y-auto hidden scrollbar-thin">
        <h3 class="text-xl font-bold mb-4 text-gray-800">Dia szerkesztése</h3>
        <input type="hidden" id="edit-current-image-url">
        <div class="space-y-4">
            <div>
                <label for="edit-slide-type" class="block text-sm font-medium text-gray-700 mb-1">Típus</label>
                <select id="edit-slide-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="toggleEditSlideTypeFields()">
                    <option value="image">Kép</option>
                    <option value="embed">Beágyazott link</option>
                    <option value="aktuális">Aktuális</option>
                </select>
            </div>
            <div id="edit-image-input-group" class="drop-zone" data-target-input="edit-slide-image-upload" data-target-preview="edit-image-preview">
                 <label class="block text-sm font-medium text-gray-700 mb-1">Kép cseréje (opcionális)</label>
                 <input type="file" id="edit-slide-image-upload" accept="image/*" class="hidden">
                 <span class="text-xs text-gray-500 block mb-2">Kattints vagy húzz ide egy képet!</span>
                 <img id="edit-image-preview" src="#" alt="Kép előnézet" class="image-preview hidden mx-auto">
                 <div id="edit-upload-indicator" class="upload-indicator">
                     <svg class="spinner animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                     <svg class="checkmark h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                     <svg class="crossmark h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                     <span class="indicator-text">Feltöltés...</span>
                 </div>
            </div>
            <div id="edit-url-input-group" class="hidden">
                <label for="edit-slide-content" class="block text-sm font-medium text-gray-700 mb-1">Beágyazott link</label>
                <input type="text" id="edit-slide-content" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="https://...">
            </div>
            <div>
                <label for="edit-start-date" class="block text-sm font-medium text-gray-700 mb-1">Kezdő dátum</label>
                <input type="date" id="edit-start-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="edit-end-date" class="block text-sm font-medium text-gray-700 mb-1">Végdátum</label>
                <input type="date" id="edit-end-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div id="edit-text-content-group" class="hidden space-y-2">
                <div>
                    <label for="edit-first-line" class="block text-sm font-medium text-gray-700 mb-1">Első sor (max 20 karakter):</label>
                    <div id="edit-first-line" contenteditable="true" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 shadow-sm focus:ring-blue-500 focus:border-blue-500 min-h-[40px]" oninput="editUpdateFirstLineCounter()"></div>
                    <div id="edit-first-line-counter" class="text-xs text-right text-gray-500 mt-1">0/20 karakter</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Szöveg (max 100 karakter):</label>
                    <div class="flex flex-wrap gap-1 border-b pb-2 mb-2">
                        <button type="button" onclick="editFormatText('bold')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><b>B</b></button>
                        <button type="button" onclick="editFormatText('italic')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><i>I</i></button>
                        <button type="button" onclick="editFormatText('underline')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><u>U</u></button>
                        <button type="button" onclick="editFormatText('insertLineBreak')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">↵</button>
                    </div>
                    <div id="edit-text-content" contenteditable="true" class="rich-text-content w-full p-2 border border-gray-300 rounded-md bg-gray-50 shadow-sm focus:ring-blue-500 focus:border-blue-500 min-h-[100px]" oninput="editUpdateCharCounter()"></div>
                    <div id="edit-char-counter" class="text-xs text-right text-gray-500 mt-1">0/100 karakter</div>
                </div>
            </div>
            <div>
                <label for="edit-comment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (adminisztrátor számára)</label>
                <textarea id="edit-comment" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Pl. Mettől meddig releváns, ki kérte..." rows="3"></textarea>
            </div>
        </div>
        <div class="flex flex-col sm:flex-row justify-end gap-3 mt-6 border-t pt-4">
            <button id="edit-cancel-btn" onclick="closeEditPopup()" class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-200">Mégse</button>
            <button id="edit-save-btn" onclick="saveEditedSlide()" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">Mentés</button>
        </div>
    </div>
    <div id="edit-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm z-[1030] hidden"></div>


    <div id="mainAppContent" class="w-full px-4 py-8 hidden">
        <div id="admin-content" class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 px-4 py-5 bg-white rounded-xl shadow-lg">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">InfoTV Admin</h1>
                <div class="flex flex-wrap gap-2 sm:gap-4">
                    <a href="https://www.canva.com/design/DAGI4OevAdo/QiptmBWJUsqrn3_MJbQLww/edit" target="_blank" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 text-sm font-medium text-center">Sablonok (Canva)</a>
                    <a href="https://infotv.tmskoncz.hu" target="_blank" class="w-full sm:w-auto px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition duration-200 text-sm font-medium text-center">Élő oldal</a>
                    <button id="logoutButton" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200 text-sm font-medium">Kijelentkezés</button>
                </div>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8">
                <h1 class="text-2xl font-bold mb-6 text-gray-800">Eszközök állapota</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 space-y-4">
                        <div>
                            <h2 class="text-xl font-semibold mb-2 text-gray-700">Online eszközök</h2>
                            <p class="text-4xl font-bold text-green-600" id="online-count">0</p>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold mb-2 text-gray-700">Rendelkezésre állás (8 eszközből)</h2>
                            <p class="text-4xl font-bold text-blue-600" id="availability-percentage">-%</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Eszközök listája</h2>
                        <div id="devices-list" class="overflow-y-auto max-h-48 scrollbar-thin">
                             <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <span>Eszközök betöltése...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8">
                <h1 class="text-2xl font-bold mb-6 text-gray-800">Hirdetéskezelés</h1>
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleSlideForm()">
                        <h2 class="text-xl font-semibold text-gray-700">Új hirdetés hozzáadása</h2>
                        <span id="slide-form-toggle" class="text-gray-500 text-xl transition-transform duration-300">▼</span>
                    </div>
                    <div id="slide-form" class="mt-4 hidden space-y-4">
                        <div>
                             <label for="slide-type" class="block text-sm font-medium text-gray-700 mb-1">Típus</label>
                             <select id="slide-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="toggleSlideTypeFields()">
                                <option value="image">Kép</option>
                                <option value="embed">Beágyazott link</option>
                                <option value="aktuális">Aktuális</option>
                            </select>
                        </div>
                        <div id="regular-slide-fields" class="space-y-4">
                             <div id="add-image-input-group" class="drop-zone" data-target-input="slide-image-upload" data-target-preview="add-image-preview">
                                 <label for="slide-image-upload" class="block text-sm font-medium text-gray-700 mb-1 cursor-pointer">Kép feltöltése</label>
                                 <input type="file" id="slide-image-upload" accept="image/*" class="hidden">
                                 <p class="text-xs text-gray-500 mb-2">Kattints vagy húzz ide egy képet!</p>
                                 <img id="add-image-preview" src="#" alt="Kép előnézet" class="image-preview hidden mx-auto">
                                 <div id="add-upload-indicator" class="upload-indicator">
                                     <svg class="spinner animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                     <svg class="checkmark h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                     <svg class="crossmark h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                     <span class="indicator-text">Feltöltés...</span>
                                 </div>
                             </div>
                             <div id="add-url-input-group" class="hidden">
                                 <label for="slide-content" class="block text-sm font-medium text-gray-700 mb-1">Beágyazott link</label>
                                 <input type="text" id="slide-content" placeholder="https://..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                             </div>
                             <div class="flex flex-col sm:flex-row gap-4">
                                 <div class="flex-1">
                                     <label for="slide-start-date" class="block text-sm font-medium text-gray-700 mb-1">Kezdő dátum</label>
                                     <input type="date" id="slide-start-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                 </div>
                                 <div class="flex-1">
                                     <label for="slide-end-date" class="block text-sm font-medium text-gray-700 mb-1">Végdátum</label>
                                     <input type="date" id="slide-end-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                 </div>
                             </div>
                             <div>
                                 <label for="slide-comment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (admin)</label>
                                 <textarea id="slide-comment" placeholder="Adminisztratív megjegyzés..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
                             </div>
                        </div>
                        <div id="aktualis-slide-fields" class="hidden space-y-4">
                            <input type="hidden" id="aktualis-preset-link" value="https://i.ibb.co/Hfkcjrct/aktu-lis-sablon-1.png">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Első sor (max 20 karakter):</label>
                                <div id="first-line" contenteditable="true" class="w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500 min-h-[40px]" oninput="updateFirstLineCounter()"></div>
                                <div id="first-line-counter" class="text-xs text-right text-gray-500 mt-1">0/20 karakter</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Szöveg (max 100 karakter):</label>
                                <div class="flex flex-wrap gap-1 border-b pb-2 mb-2">
                                    <button type="button" onclick="formatText('bold')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><b>B</b></button>
                                    <button type="button" onclick="formatText('italic')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><i>I</i></button>
                                    <button type="button" onclick="formatText('underline')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm"><u>U</u></button>
                                    <button type="button" onclick="formatText('insertLineBreak')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">↵</button>
                                </div>
                                <div id="slide-text-content" contenteditable="true" class="rich-text-content bg-white w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 min-h-[100px]" oninput="updateCharCounter()"></div>
                                <div id="char-counter" class="text-xs text-right text-gray-500 mt-1">0/100 karakter</div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4">
                                 <div class="flex-1">
                                     <label for="aktualis-start-date" class="block text-sm font-medium text-gray-700 mb-1">Kezdő dátum</label>
                                     <input type="date" id="aktualis-start-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                 </div>
                                 <div class="flex-1">
                                     <label for="aktualis-end-date" class="block text-sm font-medium text-gray-700 mb-1">Végdátum</label>
                                     <input type="date" id="aktualis-end-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                 </div>
                            </div>
                             <div>
                                 <label for="aktualis-comment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (admin)</label>
                                 <textarea id="aktualis-comment" placeholder="Adminisztratív megjegyzés..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
                             </div>
                        </div>
                        <button id="add-slide-btn" onclick="addSlide()" class="w-full bg-blue-600 text-white p-2.5 rounded-md hover:bg-blue-700 transition duration-200 font-medium">Hirdetés hozzáadása</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                        <h2 class="text-xl font-semibold text-gray-700">Hirdetések listája (sorrend húzással módosítható)</h2>
                        <button id="reorder-btn" onclick="toggleReorderMode()" class="w-full sm:w-auto bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition duration-200 text-sm font-medium">
                            Átrendezés mód
                        </button>
                    </div>
                    <div id="slides-container" class="space-y-3">
                         <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <span>Diák betöltése...</span>
                        </div>
                    </div>
                    <div id="reorder-controls" class="hidden mt-4 flex flex-col sm:flex-row justify-end gap-3">
                        <button onclick="cancelReorder()" class="w-full sm:w-auto px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition duration-200">Mégse</button>
                        <button onclick="saveReorder()" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">Sorrend mentése</button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 border-l-4 border-red-500">
                <h1 class="text-2xl font-bold mb-6 text-red-700">Havária mód</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                        <div class="flex justify-between items-center cursor-pointer" onclick="toggleEmergencyForm()">
                            <h2 class="text-xl font-semibold text-red-800">Új havária hozzáadása</h2>
                            <span id="emergency-form-toggle" class="text-red-600 text-xl transition-transform duration-300">▼</span>
                        </div>
                        <div id="emergency-slide-form" class="mt-4 hidden space-y-4">
                             <div>
                                <label for="emergency-slide-type" class="block text-sm font-medium text-gray-700 mb-1">Típus</label>
                                <select id="emergency-slide-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" onchange="toggleEmergencyInputFields()">
                                    <option value="image">Kép</option>
                                    <option value="embed">Beágyazott link</option>
                                </select>
                             </div>
                             <div id="emergency-image-input-group" class="drop-zone drop-zone-emergency" data-target-input="emergency-slide-image-upload" data-target-preview="emergency-image-preview">
                                 <label for="emergency-slide-image-upload" class="block text-sm font-medium text-gray-700 mb-1 cursor-pointer">Kép feltöltése (Havária)</label>
                                 <input type="file" id="emergency-slide-image-upload" accept="image/*" class="hidden">
                                 <p class="text-xs text-gray-500 mb-2">Kattints vagy húzz ide egy képet!</p>
                                  <img id="emergency-image-preview" src="#" alt="Havária kép előnézet" class="image-preview hidden mx-auto">
                                  <div id="emergency-upload-indicator" class="upload-indicator">
                                     <svg class="spinner animate-spin h-4 w-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                     <svg class="checkmark h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                     <svg class="crossmark h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                     <span class="indicator-text">Feltöltés...</span>
                                  </div>
                             </div>
                             <div id="emergency-url-input-group" class="hidden">
                                <label for="emergency-slide-content" class="block text-sm font-medium text-gray-700 mb-1">Beágyazott link (Havária)</label>
                                <input type="text" id="emergency-slide-content" placeholder="https://..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                             </div>
                             <div>
                                <label for="emergency-slide-comment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (admin)</label>
                                <textarea id="emergency-slide-comment" placeholder="Adminisztratív megjegyzés..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" rows="2"></textarea>
                             </div>
                            <button id="add-emergency-btn" onclick="addEmergencySlide()" class="w-full bg-red-600 text-white p-2.5 rounded-md hover:bg-red-700 transition duration-200 font-medium">Havária hozzáadása és aktiválása</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Haváriák listája</h2>
                            <div id="emergency-slides-container" class="space-y-3">
                                <div class="loading-container">
                                    <div class="loading-spinner"></div>
                                    <span>Haváriák betöltése...</span>
                                </div>
                            </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8">
                <h1 class="text-2xl font-bold mb-6 text-gray-800">Hibaelhárítás</h1>
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Eszközök és Naplók</h2>
                    <div class="space-y-4">
                        <button onclick="refreshAllDevices()" class="w-full bg-blue-600 text-white p-2.5 rounded-md hover:bg-blue-700 transition duration-200 font-medium">
                            Összes eszköz oldalának frissítése
                        </button>
                        <button onclick="toggleLogCard()" class="w-full bg-gray-600 text-white p-2.5 rounded-md hover:bg-gray-700 transition duration-200 font-medium">
                            Naplók megtekintése / elrejtése
                        </button>
                    </div>
                </div>
            </div>

            <div id="log-card" class="bg-white p-6 md:p-8 rounded-xl shadow-lg hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                    <h2 class="text-xl font-semibold text-gray-700">Naplóbejegyzések (összes)</h2>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="refreshLogs()" class="w-full sm:w-auto bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition duration-200 text-sm">
                            Frissítés
                        </button>
                        <button onclick="toggleLogCard()" class="w-full sm:w-auto bg-gray-500 text-white px-3 py-1.5 rounded-md hover:bg-gray-600 transition duration-200 text-sm">
                            Bezárás
                        </button>
                    </div>
                </div>
                <div id="log-entries" class="overflow-y-auto max-h-96 border rounded p-2 bg-gray-50 scrollbar-thin">
                     <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <span>Naplóbejegyzések betöltése...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase importok
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, getDoc, setDoc, serverTimestamp, query, orderBy, where, documentId, limit, writeBatch } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAmlb3HFiXq18IlV--o1GOC5yofXSZjV48",
            authDomain: "infotv-50232.firebaseapp.com",
            projectId: "infotv-50232",
            storageBucket: "infotv-50232.appspot.com",
            messagingSenderId: "890415866941",
            appId: "1:890415866941:web:10606b06957eca86d43654",
            measurementId: "G-2V1HZ0RPJK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ImgBB API Key ---
        const IMGBB_API_KEY = '8f8df6e25ae6f48ebc2beba95085cecd';

        // --- UI Elements ---
        const loginContainer = document.getElementById('loginContainer');
        const mainAppContent = document.getElementById('mainAppContent');
        const emailForm = document.getElementById('emailForm');
        const actualLoginForm = document.getElementById('actualLoginForm');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const emailStep = document.getElementById('emailStep');
        const passwordStep = document.getElementById('passwordStep');
        const gravatarImage = document.getElementById('gravatarImage');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const hiddenEmailInput = document.getElementById('hiddenEmail');
        const backButton = document.getElementById('backButton');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const forgotPasswordLink2 = document.getElementById('forgotPasswordLink2');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageButton = document.getElementById('closeMessageButton');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const logoutButton = document.getElementById('logoutButton');
        const adminContent = document.getElementById('admin-content');
        const editPopup = document.getElementById('edit-popup');
        const editOverlay = document.getElementById('edit-overlay');
        const confirmPopup = document.getElementById('confirm-popup');
        const confirmOverlay = document.getElementById('confirm-overlay');
        const notificationElement = document.getElementById('notification');
        // Image Upload Elements
        const addSlideImageUpload = document.getElementById('slide-image-upload');
        const addImagePreview = document.getElementById('add-image-preview');
        const addUploadIndicator = document.getElementById('add-upload-indicator');
        const addImageInputGroup = document.getElementById('add-image-input-group');
        const addUrlInputGroup = document.getElementById('add-url-input-group');
        const editSlideImageUpload = document.getElementById('edit-slide-image-upload');
        const editImagePreview = document.getElementById('edit-image-preview');
        const editUploadIndicator = document.getElementById('edit-upload-indicator');
        const editImageInputGroup = document.getElementById('edit-image-input-group');
        const editUrlInputGroup = document.getElementById('edit-url-input-group');
        const editCurrentImageUrlInput = document.getElementById('edit-current-image-url');
        const emergencySlideImageUpload = document.getElementById('emergency-slide-image-upload');
        const emergencyImagePreview = document.getElementById('emergency-image-preview');
        const emergencyUploadIndicator = document.getElementById('emergency-upload-indicator');
        const emergencyImageInputGroup = document.getElementById('emergency-image-input-group');
        const emergencyUrlInputGroup = document.getElementById('emergency-url-input-group');
        // Buttons related to upload
        const addSlideBtn = document.getElementById('add-slide-btn');
        const addEmergencyBtn = document.getElementById('add-emergency-btn');
        const editSaveBtn = document.getElementById('edit-save-btn');

        // --- State Variables ---
        let currentEditingSlideId = null;
        let currentEditingSlideType = null;
        let sortableInstance = null;
        let notificationTimeoutId = null;
        const TOTAL_DEVICES = 8;
        let isUploading = false; // Track upload state

        // --- Helper Functions ---

        /** Shows a message in the popup box. */
        function showMessage(message, isError = false) {
            messageText.textContent = message;
            const boxContent = messageBox.querySelector('div');
            boxContent.classList.toggle('border-blue-500', !isError);
            boxContent.classList.toggle('border-red-500', isError);
            messageText.classList.toggle('text-gray-700', !isError);
            messageText.classList.toggle('text-red-700', isError);
            messageBox.classList.remove('hidden');
        }

        /** Closes the message box. */
        function closeMessage() {
            messageBox.classList.add('hidden');
            messageText.textContent = '';
        }

        /** Shows a field error message. */
        function showFieldError(errorElement, message) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        /** Hides a field error message. */
        function hideFieldError(errorElement) {
            errorElement.textContent = '';
            errorElement.classList.add('hidden');
        }

        /** Validates an email address. */
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(String(email).toLowerCase());
        }

        /** Generates a Gravatar URL. */
        function getGravatarUrl(email) {
            if (!email || typeof email !== 'string') return 'https://placehold.co/150x150/e2e8f0/cbd5e1?text=Hiba';
            const cleanedEmail = email.trim().toLowerCase();
            const hash = md5(cleanedEmail);
            return `https://www.gravatar.com/avatar/${hash}?d=mp&s=150`;
        }

        /** Shows a notification message. */
        function showNotification(message, isError = false) {
            notificationElement.textContent = message;
            notificationElement.className = `notification fixed bottom-4 left-1/2 transform -translate-x-1/2 max-w-md w-[calc(100%-2rem)] text-white px-4 py-3 rounded-md shadow-lg z-[1050] text-center ${isError ? 'error' : 'success'}`;
            notificationElement.classList.add('notification-enter');

            if (notificationTimeoutId) clearTimeout(notificationTimeoutId);

            notificationTimeoutId = setTimeout(() => {
                notificationElement.classList.remove('notification-enter');
                notificationElement.classList.add('notification-leave');
                setTimeout(() => {
                    if (notificationElement.textContent === message) {
                        notificationElement.classList.add('hidden');
                    }
                }, 300);
            }, 5000);
        }

         /** Shows a confirmation popup. */
         function showConfirmPopup(message, confirmCallback) {
            document.getElementById('confirm-message').textContent = message;
            confirmPopup.classList.remove('hidden');
            confirmOverlay.classList.remove('hidden');

            const confirmBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            newConfirmBtn.onclick = async () => {
                confirmPopup.classList.add('hidden');
                confirmOverlay.classList.add('hidden');
                if (confirmCallback) await confirmCallback();
            };
            newCancelBtn.onclick = () => {
                confirmPopup.classList.add('hidden');
                confirmOverlay.classList.add('hidden');
            };
        }

        /** Handles image preview and triggers upload indicator logic. */
        function handleImagePreview(fileInput, previewElement, indicatorElement, relatedButton) {
            const file = fileInput.files[0];
            // Reset indicator immediately when file changes
            setIndicatorState(indicatorElement, 'idle');
            if (relatedButton) relatedButton.disabled = false; // Re-enable button if file is changed/removed

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewElement.src = e.target.result;
                    previewElement.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                previewElement.classList.add('hidden');
                previewElement.src = '#';
            }
        }

        /** Updates character counters for contenteditable divs. */
        function updateCounter(elementId, counterId, maxLength) {
            const element = document.getElementById(elementId);
            const counter = document.getElementById(counterId);
            if (!element || !counter) return;
            const currentLength = element.innerText.length;
            counter.textContent = `${currentLength}/${maxLength} karakter`;
            counter.classList.toggle('text-red-600', currentLength > maxLength);
        }

        /** Sets the state of an upload indicator. */
        function setIndicatorState(indicatorElement, state, message = '') {
            if (!indicatorElement) return;
            const textElement = indicatorElement.querySelector('.indicator-text');
            indicatorElement.classList.remove('uploading', 'success', 'error');
            if (textElement) textElement.textContent = message;

            switch (state) {
                case 'uploading':
                    indicatorElement.classList.add('uploading');
                    if (textElement) textElement.textContent = message || 'Feltöltés...';
                    break;
                case 'success':
                    indicatorElement.classList.add('success');
                     if (textElement) textElement.textContent = message || 'Sikeres feltöltés!';
                    break;
                case 'error':
                    indicatorElement.classList.add('error');
                    if (textElement) textElement.textContent = message || 'Feltöltési hiba!';
                    break;
                case 'idle':
                default:
                    // Hide the indicator completely when idle
                    indicatorElement.style.display = 'none';
                    break;
            }
             // Make sure the indicator container is visible when not idle
             if (state !== 'idle') {
                 indicatorElement.style.display = 'flex';
             }
        }

        /** Generates HTML for a loading spinner container. */
        function getLoadingIndicatorHTML(text = 'Betöltés...') {
            return `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <span>${text}</span>
                </div>`;
        }

        // --- Application State Management ---

        /** Shows the login form. */
        function showLogin() {
            loginContainer.style.display = 'block';
            mainAppContent.style.display = 'none';
            passwordStep.classList.add('hidden-step');
            emailStep.classList.remove('hidden-step');
            loginEmailInput.value = '';
            loginPasswordInput.value = '';
            hideFieldError(emailError);
            hideFieldError(passwordError);
            document.body.className = 'bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100 flex items-center justify-center min-h-screen';
            loginEmailInput.focus();
        }

        /** Shows the main application content. */
        function showAppContent() {
            loginContainer.style.display = 'none';
            mainAppContent.style.display = 'block';
            document.body.className = 'bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100';
            loadAdminData();
        }

        /** Loads data required for the admin interface. */
        function loadAdminData() {
             renderSlides();
             renderEmergencySlides();
             monitorDevices();
             fetchLogs();
        }


        // --- Authentication Handling ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is logged in:", user.email);
                showAppContent();
            } else {
                console.log("User is logged out.");
                showLogin();
            }
        });

        // --- Event Handlers ---

        // Email form submission
        emailForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = loginEmailInput.value;
            hideFieldError(emailError);
            if (!validateEmail(email)) {
                showFieldError(emailError, 'Kérjük, adjon meg egy érvényes e-mail címet.');
                loginEmailInput.focus(); return;
            }
            gravatarImage.src = getGravatarUrl(email);
            welcomeMessage.textContent = `Üdv, ${email.split('@')[0]}!`;
            hiddenEmailInput.value = email;
            emailStep.classList.add('hidden-step');
            passwordStep.classList.remove('hidden-step');
            loginPasswordInput.focus();
        });

        // Back button on password step
        backButton.addEventListener('click', () => {
            passwordStep.classList.add('hidden-step');
            emailStep.classList.remove('hidden-step');
            hideFieldError(passwordError);
            loginPasswordInput.value = '';
            loginEmailInput.focus();
        });

        // Actual login form submission
        actualLoginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = hiddenEmailInput.value;
            const password = loginPasswordInput.value;
            hideFieldError(passwordError);
            if (!password) {
                showFieldError(passwordError, 'Kérjük, adja meg a jelszavát.');
                loginPasswordInput.focus(); return;
            }
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await addDoc(collection(db, 'logs'), { eventType: "Bejelentkezés", details: "Sikeres bejelentkezés", user: userCredential.user.email, timestamp: serverTimestamp() });
            } catch (error) {
                console.error('Login error:', error.code, error.message);
                let errorMessage = 'Hibás e-mail cím vagy jelszó.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') { errorMessage = 'Nincs ilyen e-mail címmel regisztrált felhasználó.'; }
                else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { errorMessage = 'Hibás jelszó.'; }
                else if (error.code === 'auth/too-many-requests') { errorMessage = 'Túl sok sikertelen próbálkozás. Próbálja újra később.';}
                showFieldError(passwordError, errorMessage);
                loginPasswordInput.focus();
            }
        });

        // Forgot password handler
        async function handleForgotPassword(event) {
             event.preventDefault();
             const currentEmail = passwordStep.classList.contains('hidden-step') ? loginEmailInput.value : hiddenEmailInput.value;
             if (currentEmail && validateEmail(currentEmail)) {
                 try {
                     await sendPasswordResetEmail(auth, currentEmail);
                     showMessage(`Elküldtünk egy jelszó-visszaállító linket a(z) ${currentEmail} címre. Ellenőrizze a postafiókját (a spam mappát is!).`);
                 } catch (error) {
                     console.error("Password reset error:", error);
                     let userMessage = "Hiba történt a jelszó-visszaállítás során.";
                     if (error.code === 'auth/user-not-found') { userMessage = `Nincs ilyen e-mail címmel (${currentEmail}) regisztrált felhasználó.`; }
                     showMessage(userMessage, true);
                 }
             } else {
                 showMessage('Kérjük, először adjon meg egy érvényes e-mail címet!', true);
                 if (!emailStep.classList.contains('hidden-step')) loginEmailInput.focus();
             }
        }
        forgotPasswordLink.addEventListener('click', handleForgotPassword);
        forgotPasswordLink2.addEventListener('click', handleForgotPassword);

        // Close message box
        closeMessageButton.addEventListener('click', closeMessage);
        messageBox.addEventListener('click', (event) => { if (event.target === messageBox) closeMessage(); });

        // Logout button
        logoutButton.addEventListener('click', async () => {
            try {
                if (auth.currentUser) {
                    await addDoc(collection(db, 'logs'), { eventType: "Kijelentkezés", details: "Felhasználó kijelentkezett", user: auth.currentUser.email, timestamp: serverTimestamp() });
                }
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Hiba történt a kijelentkezés során!', true);
            }
        });

        // Image Preview Listeners (linking indicator and button)
        addSlideImageUpload.addEventListener('change', () => handleImagePreview(addSlideImageUpload, addImagePreview, addUploadIndicator, addSlideBtn));
        editSlideImageUpload.addEventListener('change', () => handleImagePreview(editSlideImageUpload, editImagePreview, editUploadIndicator, editSaveBtn));
        emergencySlideImageUpload.addEventListener('change', () => handleImagePreview(emergencySlideImageUpload, emergencyImagePreview, emergencyUploadIndicator, addEmergencyBtn));

        // --- Drag & Drop Event Listeners ---
        function setupDragDrop(dropZoneElement) {
            const fileInput = document.getElementById(dropZoneElement.dataset.targetInput);
            const previewElement = document.getElementById(dropZoneElement.dataset.targetPreview);
            // Find the corresponding indicator and button based on the drop zone context
            let indicatorElement, relatedButton;
            if (dropZoneElement.id === 'add-image-input-group') {
                indicatorElement = addUploadIndicator; relatedButton = addSlideBtn;
            } else if (dropZoneElement.id === 'edit-image-input-group') {
                indicatorElement = editUploadIndicator; relatedButton = editSaveBtn;
            } else if (dropZoneElement.id === 'emergency-image-input-group') {
                indicatorElement = emergencyUploadIndicator; relatedButton = addEmergencyBtn;
            }

            if (!fileInput || !previewElement) {
                console.error("Drag & Drop setup failed: Target input or preview not found for", dropZoneElement);
                return;
            }

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZoneElement.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZoneElement.addEventListener(eventName, () => dropZoneElement.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZoneElement.addEventListener(eventName, () => dropZoneElement.classList.remove('dragover'), false);
            });

            // Handle dropped files
            dropZoneElement.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                setIndicatorState(indicatorElement, 'idle'); // Reset indicator on drop
                if (relatedButton) relatedButton.disabled = false; // Ensure button is enabled

                if (files.length > 0) {
                    if (files[0].type.startsWith('image/')) {
                        fileInput.files = files; // Assign the dropped file(s) to the input
                        handleImagePreview(fileInput, previewElement, indicatorElement, relatedButton); // Update preview
                    } else {
                        showNotification('Csak képfájlokat lehet behúzni!', true);
                    }
                }
            }, false);

             // Allow clicking the zone to trigger file input
             dropZoneElement.addEventListener('click', (e) => {
                 if (e.target !== fileInput) { fileInput.click(); }
             });
        }

        // Setup drag and drop for all zones
        document.querySelectorAll('.drop-zone').forEach(setupDragDrop);

        // --- Globally Accessible Functions (for onclick) ---
        window.toggleLogCard = function() {
            const logCard = document.getElementById('log-card');
            logCard.classList.toggle('hidden');
            if (!logCard.classList.contains('hidden')) fetchLogs();
        };
        window.refreshLogs = fetchLogs;
        window.toggleSlideForm = function() {
            const form = document.getElementById('slide-form');
            const toggleIcon = document.getElementById('slide-form-toggle');
            form.classList.toggle('hidden');
            toggleIcon.classList.toggle('rotate-180', !form.classList.contains('hidden'));
        };
        window.toggleEmergencyForm = function() {
            const form = document.getElementById('emergency-slide-form');
            const toggleIcon = document.getElementById('emergency-form-toggle');
            form.classList.toggle('hidden');
            toggleIcon.classList.toggle('rotate-180', !form.classList.contains('hidden'));
        };
        window.toggleSlideTypeFields = function() {
            const slideType = document.getElementById('slide-type').value;
            const regularFields = document.getElementById('regular-slide-fields');
            const aktualisFields = document.getElementById('aktualis-slide-fields');
            regularFields.classList.toggle('hidden', slideType === 'aktuális');
            aktualisFields.classList.toggle('hidden', slideType !== 'aktuális');
            addImageInputGroup.classList.toggle('hidden', slideType !== 'image');
            addUrlInputGroup.classList.toggle('hidden', slideType !== 'embed');
            if (slideType !== 'image') { addSlideImageUpload.value = ''; handleImagePreview(addSlideImageUpload, addImagePreview, addUploadIndicator, addSlideBtn); }
            if (slideType !== 'embed') document.getElementById('slide-content').value = '';
            if (slideType !== 'aktuális') { document.getElementById('first-line').innerHTML = ''; document.getElementById('slide-text-content').innerHTML = ''; updateFirstLineCounter(); updateCharCounter(); }
        };
        window.toggleEditSlideTypeFields = function() {
            const slideType = document.getElementById('edit-slide-type').value;
            const textContentGroup = document.getElementById('edit-text-content-group');
            editImageInputGroup.classList.toggle('hidden', slideType !== 'image');
            editUrlInputGroup.classList.toggle('hidden', slideType !== 'embed');
            textContentGroup.classList.toggle('hidden', slideType !== 'aktuális');
            if (slideType !== 'image') { editSlideImageUpload.value = ''; handleImagePreview(editSlideImageUpload, editImagePreview, editUploadIndicator, editSaveBtn); }
            if (slideType !== 'embed') document.getElementById('edit-slide-content').value = '';
            if (slideType !== 'aktuális') { document.getElementById('edit-first-line').innerHTML = ''; document.getElementById('edit-text-content').innerHTML = ''; editUpdateFirstLineCounter(); editUpdateCharCounter(); }
        };
        window.toggleEmergencyInputFields = function() {
             const slideType = document.getElementById('emergency-slide-type').value;
             emergencyImageInputGroup.classList.toggle('hidden', slideType !== 'image');
             emergencyUrlInputGroup.classList.toggle('hidden', slideType === 'image');
             if (slideType !== 'image') { emergencySlideImageUpload.value = ''; handleImagePreview(emergencySlideImageUpload, emergencyImagePreview, emergencyUploadIndicator, addEmergencyBtn); }
             if (slideType !== 'embed') document.getElementById('emergency-slide-content').value = '';
        };
        window.formatText = function(command) { document.execCommand(command, false, null); document.getElementById('slide-text-content').focus(); updateCharCounter(); };
        window.editFormatText = function(command) { document.execCommand(command, false, null); document.getElementById('edit-text-content').focus(); editUpdateCharCounter(); };
        window.updateFirstLineCounter = function() { updateCounter('first-line', 'first-line-counter', 20); };
        window.editUpdateFirstLineCounter = function() { updateCounter('edit-first-line', 'edit-first-line-counter', 20); };
        window.updateCharCounter = function() { updateCounter('slide-text-content', 'char-counter', 100); };
        window.editUpdateCharCounter = function() { updateCounter('edit-text-content', 'edit-char-counter', 100); };
        window.addSlide = addSlide;
        window.addEmergencySlide = addEmergencySlide;
        window.toggleReorderMode = toggleReorderMode;
        window.cancelReorder = cancelReorder;
        window.saveReorder = saveReorder;
        window.editSlide = editSlide;
        window.closeEditPopup = closeEditPopup;
        window.saveEditedSlide = saveEditedSlide;
        window.toggleSlide = toggleSlide;
        window.deleteSlide = deleteSlide;
        window.toggleEmergency = toggleEmergency;
        window.deleteEmergency = deleteEmergency;
        window.toggleDetails = function(deviceId) {
            const detailsElement = document.getElementById(`details-${deviceId}`);
            if (detailsElement) detailsElement.classList.toggle('hidden');
        };
        window.refreshAllDevices = refreshAllDevices;
        window.refreshDevice = refreshDevice;
        window.confirmAction = function(confirmed) { console.warn("confirmAction called directly"); };

        // --- Image Upload (ImgBB) ---

        /** Uploads an image file to ImgBB with state handling. */
        async function uploadImageToImgBB(file, indicatorElement, relatedButton) {
            if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_API_KEY_HERE') {
                throw new Error("Hiányzó ImgBB API kulcs!");
            }
            if (!file) {
                throw new Error("Nincs fájl kiválasztva.");
            }

            isUploading = true;
            if (relatedButton) relatedButton.disabled = true; // Disable button during upload
            setIndicatorState(indicatorElement, 'uploading');

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`ImgBB hiba: ${errorData?.error?.message || response.statusText}`);
                }

                const result = await response.json();

                if (result.success && result.data && result.data.url) {
                    setIndicatorState(indicatorElement, 'success'); // Show success checkmark
                    // Keep indicator visible for a short time
                    setTimeout(() => {
                         setIndicatorState(indicatorElement, 'idle'); // Hide indicator after delay
                    }, 1500); // 1.5 seconds delay
                    isUploading = false;
                    if (relatedButton) relatedButton.disabled = false; // Re-enable button on success
                    return result.data.url;
                } else {
                    throw new Error("ImgBB feltöltés sikertelen.");
                }
            } catch (error) {
                console.error("Error uploading to ImgBB:", error);
                setIndicatorState(indicatorElement, 'error', error.message); // Show error state
                 // Keep error visible longer? Or hide after delay? Hide for now.
                 setTimeout(() => {
                     setIndicatorState(indicatorElement, 'idle');
                 }, 3000);
                isUploading = false;
                if (relatedButton) relatedButton.disabled = false; // Re-enable button on error
                throw error; // Re-throw the error
            }
        }


        // --- Data Handling Functions ---

        /** Adds a new slide with upload handling. */
        async function addSlide() {
            if (!auth.currentUser) return showNotification('Kérlek, jelentkezz be!', true);
            if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true); // Prevent adding while uploading

            const type = document.getElementById('slide-type').value;
            let content = '', startDate, endDate, comment, firstLineText = '', textContentText = '';
            let imageUrl = null;
            const fileInput = addSlideImageUpload;

            addSlideBtn.disabled = true; // Disable button at the start
            addSlideBtn.textContent = 'Hozzáadás...'; // Indicate processing

            try {
                if (type === 'image') {
                    if (!fileInput.files || fileInput.files.length === 0) {
                        throw new Error('Kérjük, válasszon ki egy képet!');
                    }
                    // Upload image, indicator/button state handled within uploadImageToImgBB
                    imageUrl = await uploadImageToImgBB(fileInput.files[0], addUploadIndicator, addSlideBtn);
                    content = imageUrl;
                    startDate = document.getElementById('slide-start-date').value;
                    endDate = document.getElementById('slide-end-date').value;
                    comment = document.getElementById('slide-comment').value;
                } else if (type === 'aktuális') {
                     firstLineText = document.getElementById('first-line').innerText;
                     textContentText = document.getElementById('slide-text-content').innerText;
                     if (firstLineText.length > 20) throw new Error('Az első sor max 20 karakter!');
                     if (textContentText.length > 100) throw new Error('A szöveg max 100 karakter!');
                     content = {
                        presetLink: document.getElementById('aktualis-preset-link').value,
                        firstLine: document.getElementById('first-line').innerHTML,
                        text: document.getElementById('slide-text-content').innerHTML,
                        style: {}
                     };
                     startDate = document.getElementById('aktualis-start-date').value;
                     endDate = document.getElementById('aktualis-end-date').value;
                     comment = document.getElementById('aktualis-comment').value;
                } else { // embed
                    content = document.getElementById('slide-content').value;
                    if (!content || !content.trim()) throw new Error('Beágyazott link megadása kötelező!');
                    try { new URL(content); } catch (_) { throw new Error('Érvénytelen URL formátum!'); }
                    startDate = document.getElementById('slide-start-date').value;
                    endDate = document.getElementById('slide-end-date').value;
                    comment = document.getElementById('slide-comment').value;
                }

                if (!startDate || !endDate) throw new Error('Kezdő és végdátum megadása kötelező!');
                if (new Date(startDate) > new Date(endDate)) throw new Error('A kezdő dátum nem lehet későbbi a végdátumnál!');

                // --- Firestore Save ---
                await addDoc(collection(db, 'logs'), { eventType: "Dia létrehozás", details: `Új dia (típus: ${type})`, user: auth.currentUser.email, timestamp: serverTimestamp() });
                const slidesQuery = query(collection(db, 'slides'), orderBy("order", "desc"), limit(1));
                const slidesSnapshot = await getDocs(slidesQuery);
                const lastOrder = slidesSnapshot.empty ? -1 : (slidesSnapshot.docs[0].data().order ?? -1);
                const finalContent = type === 'aktuális' ? JSON.stringify(content) : content;
                const slideData = { type, content: finalContent, startDate, endDate, comment: comment.trim(), active: true, order: lastOrder + 1, createdAt: serverTimestamp() };

                await addDoc(collection(db, 'slides'), slideData);
                // --- End Firestore Save ---

                showNotification('Hirdetés sikeresen hozzáadva!');
                resetSlideForm(type);
                toggleSlideForm();
                renderSlides();

            } catch (error) {
                console.error('Error adding slide:', error);
                showNotification(`Hiba a hozzáadáskor: ${error.message}`, true);
            } finally {
                 addSlideBtn.disabled = false; // Re-enable button
                 addSlideBtn.textContent = 'Hirdetés hozzáadása'; // Restore button text
                 // Ensure indicator is hidden if addSlide fails before/without upload
                 if (type !== 'image' || !fileInput.files || fileInput.files.length === 0) {
                     setIndicatorState(addUploadIndicator, 'idle');
                 }
            }
        }

        /** Resets the slide form fields. */
        function resetSlideForm(type) {
             document.getElementById('slide-start-date').value = '';
             document.getElementById('slide-end-date').value = '';
             document.getElementById('slide-comment').value = '';
             document.getElementById('aktualis-start-date').value = '';
             document.getElementById('aktualis-end-date').value = '';
             document.getElementById('aktualis-comment').value = '';
             document.getElementById('slide-content').value = '';
             document.getElementById('first-line').innerHTML = '';
             document.getElementById('slide-text-content').innerHTML = '';
             addSlideImageUpload.value = '';
             handleImagePreview(addSlideImageUpload, addImagePreview, addUploadIndicator, addSlideBtn); // Reset preview and indicator
             updateFirstLineCounter();
             updateCharCounter();
        }


        /** Adds a new emergency slide with upload handling. */
        async function addEmergencySlide() {
             if (!auth.currentUser) return showNotification('Kérlek, jelentkezz be!', true);
             if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true);

             const type = document.getElementById('emergency-slide-type').value;
             let content = '';
             const comment = document.getElementById('emergency-slide-comment').value;
             let imageUrl = null;
             const fileInput = emergencySlideImageUpload;

             addEmergencyBtn.disabled = true;
             addEmergencyBtn.textContent = 'Hozzáadás...';

             try {
                 if (type === 'image') {
                     if (!fileInput.files || fileInput.files.length === 0) {
                         throw new Error('Kérjük, válasszon ki egy képet!');
                     }
                     imageUrl = await uploadImageToImgBB(fileInput.files[0], emergencyUploadIndicator, addEmergencyBtn);
                     content = imageUrl;
                 } else { // embed
                     content = document.getElementById('emergency-slide-content').value;
                     if (!content || !content.trim()) throw new Error('Beágyazott link megadása kötelező!');
                     try { new URL(content); } catch (_) { throw new Error('Érvénytelen URL formátum!'); }
                 }

                 // --- Firestore Save ---
                 await addDoc(collection(db, 'logs'), { eventType: "Havária létrehozás", details: `Új havária (típus: ${type})`, user: auth.currentUser.email, timestamp: serverTimestamp() });
                 const emergenciesRef = collection(db, 'emergency_slides');
                 const emergenciesSnapshot = await getDocs(emergenciesRef);
                 // Original logic: Deactivate all existing
                 const updates = emergenciesSnapshot.docs.map(doc => updateDoc(doc.ref, { active: false }));
                 await Promise.all(updates);
                 // Add the new one as active
                 await addDoc(emergenciesRef, { type, content, comment: comment.trim(), active: true, createdAt: serverTimestamp() });
                 // --- End Firestore Save ---

                 showNotification('Havária sikeresen hozzáadva és aktiválva!');
                 // Form reset
                 document.getElementById('emergency-slide-type').value = 'image';
                 document.getElementById('emergency-slide-content').value = '';
                 document.getElementById('emergency-slide-comment').value = '';
                 emergencySlideImageUpload.value = '';
                 handleImagePreview(emergencySlideImageUpload, emergencyImagePreview, emergencyUploadIndicator, addEmergencyBtn); // Reset preview and indicator
                 toggleEmergencyForm();
                 renderEmergencySlides();

             } catch (error) {
                 console.error('Error adding emergency slide:', error);
                 showNotification(`Hiba a havária hozzáadásakor: ${error.message}`, true);
             } finally {
                 addEmergencyBtn.disabled = false;
                 addEmergencyBtn.textContent = 'Havária hozzáadása és aktiválása';
                 if (type !== 'image' || !fileInput.files || fileInput.files.length === 0) {
                     setIndicatorState(emergencyUploadIndicator, 'idle');
                 }
             }
        }

        // --- Reorder Slides Logic ---
        let originalSlideOrder = []; // Store original order for cancellation

        /** Toggle slide reorder mode */
        function toggleReorderMode() {
            const reorderBtn = document.getElementById('reorder-btn');
            const reorderControls = document.getElementById('reorder-controls');
            const container = document.getElementById('slides-container');
            const isReordering = reorderBtn.textContent.includes('Kilépés');

            reorderBtn.textContent = isReordering ? 'Átrendezés mód' : 'Kilépés az átrendezésből';
            reorderBtn.classList.toggle('bg-purple-600', !isReordering);
            reorderBtn.classList.toggle('hover:bg-purple-700', !isReordering);
            reorderBtn.classList.toggle('bg-yellow-500', isReordering);
            reorderBtn.classList.toggle('hover:bg-yellow-600', isReordering);
            reorderControls.classList.toggle('hidden', isReordering);

            if (!isReordering) { // Entering reorder mode
                originalSlideOrder = Array.from(container.children).map(el => el.getAttribute('data-id'));
                if (!sortableInstance) {
                    sortableInstance = Sortable.create(container, {
                        handle: '.drag-handle', // Class for the drag handle element
                        animation: 150,
                        ghostClass: "sortable-ghost", // Class for the placeholder
                        dragClass: "sortable-drag",   // Class for the item being dragged
                        onStart: () => container.querySelectorAll('button').forEach(btn => btn.disabled = true), // Disable buttons while dragging
                        onEnd: () => container.querySelectorAll('button').forEach(btn => btn.disabled = false) // Re-enable buttons
                    });
                } else {
                    sortableInstance.option("disabled", false); // Enable sorting
                }
                // Make handles visible and hide action buttons
                container.querySelectorAll('.drag-handle').forEach(h => {
                    h.classList.remove('opacity-50', 'cursor-default');
                    h.classList.add('cursor-grab');
                });
                container.querySelectorAll('.slide-actions, .edit-btn').forEach(el => el.classList.add('hidden'));
            } else { // Exiting reorder mode (cancel implicitly)
                cancelReorder();
            }
        }

        /** Cancel reorder operation */
        function cancelReorder() {
            const reorderBtn = document.getElementById('reorder-btn');
            const reorderControls = document.getElementById('reorder-controls');
            reorderBtn.textContent = 'Átrendezés mód';
            reorderBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            reorderBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            reorderControls.classList.add('hidden');
            if (sortableInstance) sortableInstance.option("disabled", true); // Disable sorting
            renderSlides(); // Re-render to restore original DB order and show buttons/hide handles correctly
        }

        /** Save the new slide order */
        async function saveReorder() {
            if (!sortableInstance || !auth.currentUser) return;
            const container = document.getElementById('slides-container');
            const slides = Array.from(container.children); // Get current order from DOM
            try {
                await addDoc(collection(db, 'logs'), { eventType: "Diák átrendezése", details: "Új sorrend mentve", user: auth.currentUser.email, timestamp: serverTimestamp() });
                // Create Firestore batch write for efficiency
                const batch = writeBatch(db);
                slides.forEach((slideElement, index) => {
                    const slideId = slideElement.getAttribute('data-id');
                    if (slideId) { // Make sure the element has a data-id
                        const slideRef = doc(db, 'slides', slideId);
                        batch.update(slideRef, { order: index });
                    } else {
                        console.warn("Slide element found without data-id during reorder save:", slideElement);
                    }
                });
                await batch.commit(); // Execute all updates at once

                showNotification('Diák sorrendje sikeresen mentve!');
                // Exit reorder mode visually
                const reorderBtn = document.getElementById('reorder-btn');
                const reorderControls = document.getElementById('reorder-controls');
                reorderBtn.textContent = 'Átrendezés mód';
                reorderBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                reorderBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                reorderControls.classList.add('hidden');
                if (sortableInstance) sortableInstance.option("disabled", true); // Disable sorting
                renderSlides(); // Re-render to reflect saved order and correct UI state

            } catch (error) {
                console.error('Error saving slide order:', error);
                showNotification('Hiba történt a sorrend mentésekor!', true);
                cancelReorder(); // Cancel on error to revert UI
            }
        }
        // --- End Reorder Logic ---

        /** Renders the list of slides with loading state. */
        async function renderSlides() {
            const container = document.getElementById('slides-container');
            container.innerHTML = getLoadingIndicatorHTML('Diák betöltése...'); // Show loading spinner
            try {
                const slidesQuery = query(collection(db, 'slides'), orderBy("order"));
                const querySnapshot = await getDocs(slidesQuery);
                if (querySnapshot.empty) {
                    container.innerHTML = '<div class="text-center p-4 text-gray-500">Nincsenek hirdetések.</div>';
                    return;
                }
                container.innerHTML = ''; // Clear loading

                const slidesArray = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                slidesArray.forEach((slide) => container.appendChild(createSlideElement(slide)));

                // Ensure SortableJS state matches UI state after render
                 const reorderBtn = document.getElementById('reorder-btn');
                 const isReordering = reorderBtn.textContent.includes('Kilépés');
                 if (sortableInstance) sortableInstance.option("disabled", !isReordering);
                 container.querySelectorAll('.drag-handle').forEach(h => {
                     h.classList.toggle('opacity-50', !isReordering);
                     h.classList.toggle('cursor-grab', isReordering);
                     h.classList.toggle('cursor-default', !isReordering);
                 });
                 container.querySelectorAll('.slide-actions, .edit-btn').forEach(el => el.classList.toggle('hidden', isReordering));

            } catch (error) {
                console.error('Error loading slides:', error);
                container.innerHTML = '<div class="text-center p-4 text-red-500">Hiba a hirdetések betöltésekor!</div>';
                showNotification('Hiba a hirdetések betöltésekor!', true);
            }
        }

        /** Creates HTML element for a single slide. */
        function createSlideElement(slide) {
             let contentPreview = '', typeLabel = '';
             const defaultImageUrl = 'https://placehold.co/100x60/fecaca/ef4444?text=Hiba';
             if (slide.type === 'image') {
                 typeLabel = 'Kép';
                 contentPreview = `<img src="${slide.content || defaultImageUrl}" alt="Slide Preview" class="preview-image" loading="lazy" onerror="this.src='${defaultImageUrl}'; this.alt='Kép Hiba'">`;
             } else if (slide.type === 'embed') {
                 typeLabel = 'Beágyazás';
                 contentPreview = `<div class="text-sm text-gray-500 p-2 bg-gray-100 rounded break-all">🔗 ${slide.content ? slide.content.substring(0, 50) + (slide.content.length > 50 ? '...' : '') : '[Hiányzó URL]' }</div>`;
             } else if (slide.type === 'aktuális') {
                 typeLabel = 'Aktuális';
                 try {
                     const c = JSON.parse(slide.content || '{}');
                     const tempDiv = document.createElement('div');
                     tempDiv.innerHTML = c.firstLine || '';
                     const fL = tempDiv.textContent || tempDiv.innerText || '[Nincs cím]';
                     tempDiv.innerHTML = c.text || '';
                     const mT = tempDiv.textContent || tempDiv.innerText || '[Nincs szöveg]';
                     contentPreview = `<div class="slide-preview-container bg-gray-100 p-2 rounded"><div class="font-semibold text-sm truncate" title="${fL}">${fL}</div><div class="slide-preview-text" title="${mT}">${mT}</div></div>`;
                 } catch (e) { contentPreview = '<div class="text-gray-500 p-2 bg-red-100 rounded">Formátum hiba</div>'; }
             } else { typeLabel = 'Ismeretlen'; contentPreview = '<div class="text-gray-500">?</div>'; }

             const slideElement = document.createElement('div');
             const statusBorder = slide.active ? 'border-blue-500' : 'border-gray-300';
             const statusBg = slide.active ? 'bg-white' : 'bg-gray-100 opacity-70';
             slideElement.className = `p-4 rounded-lg border ${statusBorder} ${statusBg} flex flex-col sm:flex-row items-start sm:items-center gap-4`;
             slideElement.setAttribute('data-id', slide.id);
             const statusText = slide.active ? 'Aktív' : 'Inaktív';
             const statusTextColor = slide.active ? 'text-green-600' : 'text-gray-500';

             slideElement.innerHTML = `
                <div class="drag-handle opacity-50 cursor-default self-center sm:self-auto text-gray-400 hover:text-gray-600 transition-colors" title="Átrendezéshez kattints az 'Átrendezés mód' gombra"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg></div>
                <div class="w-full sm:w-1/4 flex-shrink-0">${contentPreview}</div>
                <div class="flex-grow min-w-0"><strong>${typeLabel}</strong> <span class="text-xs ${statusTextColor}">(${statusText})</span><br><small class="text-gray-600">${slide.startDate || '?'} → ${slide.endDate || '?'}</small><br><small class="text-gray-600 block truncate" title="${slide.comment || ''}">Megjegyzés: ${slide.comment || 'Nincs'}</small></div>
                <div class="slide-actions flex flex-col md:flex-row gap-2 self-end sm:self-center flex-shrink-0 mt-2 sm:mt-0"><button onclick="editSlide('${slide.id}')" class="edit-btn">Szerk.</button><button onclick="toggleSlide('${slide.id}')" class="text-white px-2 py-1 rounded text-xs ${slide.active ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-500 hover:bg-green-600'}">${slide.active ? 'Elrejt' : 'Aktív'}</button><button onclick="deleteSlide('${slide.id}')" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 text-xs">Töröl</button></div>`;
             return slideElement;
        }


        /** Renders the list of emergency slides with loading state. */
        async function renderEmergencySlides() {
            const container = document.getElementById('emergency-slides-container');
            container.innerHTML = getLoadingIndicatorHTML('Haváriák betöltése...'); // Show loading spinner
            try {
                const querySnapshot = await getDocs(collection(db, 'emergency_slides'));
                if (querySnapshot.empty) {
                     container.innerHTML = '<div class="text-center p-4 text-gray-500">Nincsenek havária diák.</div>';
                     return;
                }
                container.innerHTML = ''; // Clear loading
                const slidesArray = [];
                 querySnapshot.forEach((doc) => slidesArray.push({ id: doc.id, ...doc.data() }));
                 slidesArray.forEach((slide) => container.appendChild(createEmergencySlideElement(slide)));
            } catch (error) {
                console.error('Error loading emergency slides:', error);
                container.innerHTML = '<div class="text-center p-4 text-red-500">Hiba a haváriák betöltésekor!</div>';
                showNotification('Hiba a haváriák betöltésekor!', true);
            }
        }


        /** Creates HTML element for a single emergency slide. */
        function createEmergencySlideElement(slide) {
            const slideElement = document.createElement('div');
            slideElement.className = `slide-item ${slide.active ? 'border-l-4 border-red-500 bg-white' : 'border-l-4 border-gray-300 bg-gray-50 opacity-80'} p-4 mb-3 rounded-lg flex justify-between items-center gap-4`;
            slideElement.setAttribute('data-id', slide.id);
            let previewHTML = '';
            if (slide.type === 'image') {
                previewHTML = `<img src="${slide.content}" alt="Havária kép" class="preview-image max-w-[100px] max-h-[60px] object-contain border rounded">`;
            } else if (slide.type === 'embed') {
                previewHTML = `<div class="text-sm text-gray-500 break-all">🔗 ${slide.content.substring(0,30)}...</div>`;
            }
            slideElement.innerHTML = `
                <div class="flex-1 flex items-center gap-4">${previewHTML}<div><strong>HAVÁRIA - ${slide.type === 'image' ? 'Kép' : 'Beágyazott link'}</strong>${slide.active ? '<span class="text-red-600 font-bold ml-2">(Aktív)</span>' : ''}<br><small class="text-gray-600">Megjegyzés: ${slide.comment || 'Nincs megjegyzés'}</small></div></div>
                <div class="slide-actions flex flex-col sm:flex-row gap-2"><button onclick="toggleEmergency('${slide.id}')" class="text-white px-2 py-1 rounded text-xs ${slide.active ? 'bg-gray-500 hover:bg-gray-600' : 'bg-red-600 hover:bg-red-700'}">${slide.active ? 'Deaktivál' : 'Aktivál'}</button><button onclick="deleteEmergency('${slide.id}')" class="bg-black text-white px-2 py-1 rounded hover:bg-gray-700 text-xs">Töröl</button></div>`;
            return slideElement;
        }

        /** Opens the edit popup for a slide. */
        async function editSlide(id) {
            if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true);
            try {
                const slideRef = doc(db, 'slides', id);
                const slideDoc = await getDoc(slideRef);
                if (!slideDoc.exists()) return showNotification("A dia nem található.", true);

                const slideData = slideDoc.data();
                currentEditingSlideId = id;
                currentEditingSlideType = slideData.type;
                setIndicatorState(editUploadIndicator, 'idle'); // Reset indicator on open
                editSaveBtn.disabled = false; // Ensure save button is enabled

                editSlideImageUpload.value = '';
                handleImagePreview(editSlideImageUpload, editImagePreview, editUploadIndicator, editSaveBtn);
                editCurrentImageUrlInput.value = '';

                document.getElementById('edit-slide-type').value = slideData.type;

                if (slideData.type === 'image') {
                    editCurrentImageUrlInput.value = slideData.content || '';
                    editImagePreview.src = slideData.content || '#';
                    editImagePreview.classList.toggle('hidden', !slideData.content);
                    document.getElementById('edit-slide-content').value = '';
                } else if (slideData.type === 'aktuális') {
                    document.getElementById('edit-slide-content').value = '';
                    try {
                        const c = JSON.parse(slideData.content || '{}');
                        document.getElementById('edit-first-line').innerHTML = c.firstLine || '';
                        document.getElementById('edit-text-content').innerHTML = c.text || '';
                    } catch (e) { /* Handle parsing error silently or show notification */ }
                    editUpdateFirstLineCounter(); editUpdateCharCounter();
                } else { // embed
                    document.getElementById('edit-slide-content').value = slideData.content || '';
                    editImagePreview.classList.add('hidden');
                }

                document.getElementById('edit-start-date').value = slideData.startDate || '';
                document.getElementById('edit-end-date').value = slideData.endDate || '';
                document.getElementById('edit-comment').value = slideData.comment || '';

                toggleEditSlideTypeFields();
                editPopup.classList.remove('hidden');
                editOverlay.classList.remove('hidden');
            } catch (error) {
                console.error('Error preparing slide edit:', error);
                showNotification('Hiba a szerkesztés előkészítésekor!', true);
            }
        }

        /** Closes the edit popup. */
        function closeEditPopup() {
            if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true); // Prevent closing during upload
            editPopup.classList.add('hidden');
            editOverlay.classList.add('hidden');
            currentEditingSlideId = null;
            currentEditingSlideType = null;
            // Reset form fields
            editSlideImageUpload.value = '';
            handleImagePreview(editSlideImageUpload, editImagePreview, editUploadIndicator, editSaveBtn);
            editCurrentImageUrlInput.value = '';
            document.getElementById('edit-slide-type').value = 'image';
            document.getElementById('edit-slide-content').value = '';
            document.getElementById('edit-start-date').value = '';
            document.getElementById('edit-end-date').value = '';
            document.getElementById('edit-comment').value = '';
            document.getElementById('edit-first-line').innerHTML = '';
            document.getElementById('edit-text-content').innerHTML = '';
            editUpdateFirstLineCounter(); editUpdateCharCounter();
            setIndicatorState(editUploadIndicator, 'idle'); // Explicitly hide indicator
            toggleEditSlideTypeFields();
        }

        /** Saves the edited slide with upload handling. */
        async function saveEditedSlide() {
            if (!currentEditingSlideId || !auth.currentUser) return;
            if (isUploading) return showNotification('Képfeltöltés folyamatban, várj!', true);

            const type = document.getElementById('edit-slide-type').value;
            const startDate = document.getElementById('edit-start-date').value;
            const endDate = document.getElementById('edit-end-date').value;
            const comment = document.getElementById('edit-comment').value;
            const fileInput = editSlideImageUpload;

            editSaveBtn.disabled = true;
            editSaveBtn.textContent = 'Mentés...';

            let updateData = { type, startDate, endDate, comment: comment.trim() };
            let logDetails = `Dia frissítve (ID: ${currentEditingSlideId}, Típus: ${type})`;
            let newImageUrl = null;

            try {
                if (!startDate || !endDate) throw new Error('Kezdő és végdátum kötelező!');
                if (new Date(startDate) > new Date(endDate)) throw new Error('A kezdő dátum nem lehet későbbi a végdátumnál!');

                if (type === 'image') {
                    if (fileInput.files && fileInput.files.length > 0) {
                        newImageUrl = await uploadImageToImgBB(fileInput.files[0], editUploadIndicator, editSaveBtn);
                        updateData.content = newImageUrl;
                        logDetails += `, Tartalom: Új kép feltöltve`;
                    } else {
                        updateData.content = editCurrentImageUrlInput.value || '';
                        if (!updateData.content) {
                            if (currentEditingSlideType === 'image') throw new Error('Nem található kép a dia mentéséhez.');
                            else throw new Error('Kép típus választva, de nincs kép feltöltve.');
                        }
                        logDetails += `, Tartalom: Meglévő kép`;
                    }
                } else if (type === 'aktuális') {
                    const firstLineText = document.getElementById('edit-first-line').innerText;
                    const textContentText = document.getElementById('edit-text-content').innerText;
                    if (firstLineText.length > 20) throw new Error('Az első sor max 20 karakter!');
                    if (textContentText.length > 100) throw new Error('A szöveg max 100 karakter!');
                    updateData.content = JSON.stringify({ presetLink: "https://i.ibb.co/Hfkcjrct/aktu-lis-sablon-1.png", firstLine: document.getElementById('edit-first-line').innerHTML, text: document.getElementById('edit-text-content').innerHTML, style: {} });
                    logDetails += `, Tartalom: Aktuális`;
                } else { // embed
                    const content = document.getElementById('edit-slide-content').value;
                    if (!content || !content.trim()) throw new Error('Beágyazott link megadása kötelező!');
                    try { new URL(content); } catch (_) { throw new Error('Érvénytelen URL formátum!'); }
                    updateData.content = content;
                    logDetails += `, Tartalom: Beágyazás`;
                }

                // --- Firestore Save ---
                await addDoc(collection(db, 'logs'), { eventType: "Dia szerkesztés", details: logDetails, user: auth.currentUser.email, timestamp: serverTimestamp() });
                await updateDoc(doc(db, 'slides', currentEditingSlideId), updateData);
                // --- End Firestore Save ---

                showNotification('Dia sikeresen frissítve!');
                closeEditPopup();
                renderSlides();

            } catch (error) {
                console.error('Error saving edited slide:', error);
                showNotification(`Hiba a mentéskor: ${error.message}`, true);
            } finally {
                 editSaveBtn.disabled = false;
                 editSaveBtn.textContent = 'Mentés';
                 if (type !== 'image' || !fileInput.files || fileInput.files.length === 0) {
                     setIndicatorState(editUploadIndicator, 'idle');
                 }
            }
        }


        /** Toggles the active status of a slide. */
        async function toggleSlide(id) {
            if (!auth.currentUser) return showNotification('Kérlek, jelentkezz be!', true);
            try {
                const slideRef = doc(db, 'slides', id);
                const slideDoc = await getDoc(slideRef);
                if (!slideDoc.exists()) return showNotification('A dia nem található.', true);

                const currentStatus = slideDoc.data().active;
                const newStatus = !currentStatus;

                await addDoc(collection(db, 'logs'), { eventType: "Dia állapot", details: `Dia ${newStatus ? 'aktíválva' : 'elrejtve'} (ID: ${id})`, user: auth.currentUser.email, timestamp: serverTimestamp() });
                await updateDoc(slideRef, { active: newStatus });
                showNotification(`Hirdetés ${newStatus ? 'aktíválva' : 'elrejtve'}!`);
                renderSlides(); // Refresh the list to show the change
            } catch (error) {
                console.error('Error toggling slide status:', error);
                showNotification('Hiba az állapot váltásakor!', true);
            }
        }

        /** Deletes a slide after confirmation. */
        function deleteSlide(id) {
            if (!auth.currentUser) return showNotification('Kérlek, jelentkezz be!', true);
            showConfirmPopup('Biztosan törlöd ezt a hirdetést? Ez a művelet nem vonható vissza.', async () => {
                try {
                    // Log before deleting
                    await addDoc(collection(db, 'logs'), { eventType: "Dia törlés", details: `Normál dia törölve (ID: ${id})`, user: auth.currentUser.email, timestamp: serverTimestamp() });
                    await deleteDoc(doc(db, 'slides', id));
                    showNotification('Hirdetés törölve!');
                    renderSlides(); // Refresh the list
                } catch (error) {
                    console.error('Error deleting slide:', error);
                    showNotification('Hiba a dia törlésekor!', true);
                }
            });
        }

        /** Toggles the active status of an emergency slide. */
        async function toggleEmergency(id) {
             if (!auth.currentUser) return showNotification('Kérlek, jelentkezz be!', true);
             try {
                const slideRef = doc(db, 'emergency_slides', id);
                const slideDoc = await getDoc(slideRef);
                if (!slideDoc.exists()) return showNotification('A havária dia nem található.', true);
                const newStatus = !slideDoc.data().active;
                await addDoc(collection(db, 'logs'), { eventType: "Havária állapot", details: `Havária ${newStatus ? 'aktiválva' : 'deaktiválva'} (ID: ${id})`, user: auth.currentUser.email, timestamp: serverTimestamp() });

                if (newStatus) { // Activate this one, deactivate others
                     const emergenciesRef = collection(db, 'emergency_slides');
                     const emergenciesSnapshot = await getDocs(emergenciesRef);
                     // Original logic: Set active based on ID match
                     const updates = emergenciesSnapshot.docs.map(d => updateDoc(d.ref, { active: d.id === id }));
                     await Promise.all(updates);
                     showNotification('Havária aktiválva! A többi automatikusan deaktiválva lett.');
                } else { // Deactivate this one
                     await updateDoc(slideRef, { active: false });
                     showNotification('Havária deaktiválva.');
                }
                renderEmergencySlides();
             } catch (error) {
                console.error('Error toggling emergency status:', error);
                showNotification('Hiba a havária állapotának váltásakor!', true);
             }
        }

        /** Deletes an emergency slide after confirmation. */
        function deleteEmergency(id) {
            if (!auth.currentUser) return showNotification('Kérlek, jelentkezz be!', true);
            showConfirmPopup('Biztosan törlöd ezt a haváriát? Ez a művelet nem vonható vissza.', async () => {
                try {
                    // Log before deleting
                    await addDoc(collection(db, 'logs'), { eventType: "Havária törlés", details: `Havária törölve (ID: ${id})`, user: auth.currentUser.email, timestamp: serverTimestamp() });
                    await deleteDoc(doc(db, 'emergency_slides', id));
                    showNotification('Havária törölve!');
                    renderEmergencySlides(); // Refresh the list
                } catch (error) {
                    console.error('Error deleting emergency slide:', error);
                    showNotification('Hiba a havária törlésekor!', true);
                }
            });
        }

        /** Monitors device status and updates the list and availability percentage. */
        function monitorDevices() {
            const devicesRef = collection(db, 'devices');
            const devicesListElement = document.getElementById('devices-list');
            // Initial loading state set in HTML

            onSnapshot(devicesRef, (snapshot) => {
                const onlineCountElement = document.getElementById('online-count');
                const availabilityElement = document.getElementById('availability-percentage');
                let onlineCount = 0;
                devicesListElement.innerHTML = ''; // Clear previous list or loading indicator

                if (snapshot.empty) {
                    devicesListElement.innerHTML = '<div class="p-3 text-gray-500">Nincsenek regisztrált eszközök.</div>';
                    onlineCountElement.textContent = 0;
                    availabilityElement.textContent = '0%';
                    return;
                }

                snapshot.forEach((doc) => {
                    const device = doc.data();
                    const deviceId = doc.id;
                    const lastHeartbeat = device.lastHeartbeat?.toDate();
                    const isOnline = lastHeartbeat && (Date.now() - lastHeartbeat.getTime()) < 2 * 60 * 1000;
                    if (isOnline) onlineCount++;
                    devicesListElement.appendChild(createDeviceElement(deviceId, device, isOnline, lastHeartbeat));
                });

                onlineCountElement.textContent = onlineCount;
                const availabilityPercent = TOTAL_DEVICES > 0 ? Math.round((onlineCount / TOTAL_DEVICES) * 100) : 0;
                availabilityElement.textContent = `${availabilityPercent}%`;

            }, (error) => {
                 console.error("Error monitoring devices:", error);
                 devicesListElement.innerHTML = '<div class="p-3 text-red-500">Hiba az eszközök figyelésekor.</div>';
                 document.getElementById('online-count').textContent = '?';
                 document.getElementById('availability-percentage').textContent = '?%';
                 showNotification("Hiba az eszközök figyelésekor!", true);
            });
        }

         /** Creates HTML element for a single device. */
         function createDeviceElement(deviceId, device, isOnline, lastHeartbeat) {
             const deviceElement = document.createElement('div');
             // Use Tailwind classes for device item styling
             deviceElement.className = `p-3 mb-2 rounded border-l-4 ${isOnline ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;

             // Format last heartbeat time
             const formattedHeartbeat = lastHeartbeat ? lastHeartbeat.toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'medium'}) : 'Soha';

             deviceElement.innerHTML = `
                <div class="flex flex-wrap justify-between items-center gap-2">
                    <span class="font-semibold break-all" title="${device.name || deviceId}">${device.name || deviceId}</span>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${isOnline ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">${isOnline ? 'Online' : 'Offline'}</span>
                    <button onclick="toggleDetails('${deviceId}')" class="text-blue-600 hover:text-blue-800 text-sm underline focus:outline-none">Részletek</button>
                </div>
                <div id="details-${deviceId}" class="hidden mt-2 text-sm text-gray-700 space-y-1 border-t pt-2">
                    <p><strong>ID:</strong> <span class="break-all">${deviceId}</span></p>
                    <p><strong>OS:</strong> ${device.os || 'N/A'}</p>
                    <p><strong>Böngésző:</strong> ${device.browser || 'N/A'}</p>
                    <p><strong>Felbontás:</strong> ${device.resolution || 'N/A'}</p>
                    <p><strong>Utolsó ping:</strong> ${formattedHeartbeat}</p>
                    <button onclick="refreshDevice('${deviceId}')" class="mt-2 w-full sm:w-auto bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-300">Oldal frissítése</button>
                </div>`;
             return deviceElement;
         }


        /** Refreshes all devices via Firestore command. */
        async function refreshAllDevices() {
             if (!auth.currentUser) return showNotification('Kérlek, jelentkezz be!', true);
             try {
                 // Log the action
                 await addDoc(collection(db, 'logs'), { eventType: "Eszközök frissítése (mind)", details: "Admin kezdeményezte", user: auth.currentUser.email, timestamp: serverTimestamp() });

                 // Get all device documents
                 const devicesSnapshot = await getDocs(collection(db, 'devices'));

                 // Use a batch write to update all devices efficiently
                 const batch = writeBatch(db);
                 devicesSnapshot.docs.forEach(doc => {
                     const deviceRef = doc.ref;
                     batch.update(deviceRef, { refresh: Date.now() }); // Update 'refresh' field with current timestamp
                 });
                 await batch.commit(); // Execute the batch update

                 showNotification('Frissítési parancs elküldve az összes eszköznek!');
             } catch (error) {
                 console.error('Error refreshing all devices:', error);
                 showNotification('Hiba az eszközök frissítésekor!', true);
             }
        }

        /** Refreshes a single device via Firestore command. */
        async function refreshDevice(deviceId) {
             if (!auth.currentUser) return showNotification('Kérlek, jelentkezz be!', true);
             if (!deviceId) return showNotification('Érvénytelen eszköz ID.', true);
             try {
                 // Log the action
                 await addDoc(collection(db, 'logs'), { eventType: "Eszköz frissítése (egyedi)", details: `Eszköz: ${deviceId}`, user: auth.currentUser.email, timestamp: serverTimestamp() });

                 // Update the specific device document
                 const deviceRef = doc(db, 'devices', deviceId);
                 await updateDoc(deviceRef, { refresh: Date.now() }); // Update 'refresh' field

                 showNotification(`Frissítési parancs elküldve: ${deviceId}`);
             } catch (error) {
                 console.error('Error refreshing device:', error);
                 showNotification('Hiba az eszköz frissítésekor!', true);
             }
        }

        /** Fetches and displays logs with loading state. */
        async function fetchLogs() {
            const logEntriesContainer = document.getElementById('log-entries');
            logEntriesContainer.innerHTML = getLoadingIndicatorHTML('Naplóbejegyzések betöltése...'); // Show loading spinner
            try {
                const q = query(collection(db, 'logs'), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    logEntriesContainer.innerHTML = '<div class="p-3 text-center text-gray-500">Nincsenek naplóbejegyzések.</div>';
                    return;
                }
                const logEntriesHTML = querySnapshot.docs.map(doc => createLogEntryElement(doc.data())).join('');
                logEntriesContainer.innerHTML = logEntriesHTML;
            } catch (error) {
                console.error('Error loading logs:', error);
                logEntriesContainer.innerHTML = `<div class="p-3 text-red-600 bg-red-50 rounded">Hiba a naplók betöltésekor.</div>`;
                showNotification('Hiba a naplók betöltésekor!', true);
            }
        }


        /** Creates HTML element for a single log entry. */
        function createLogEntryElement(logData) {
            const timestamp = logData.timestamp?.toDate();
            // Format timestamp for Hungarian locale
            const formattedTime = timestamp ? timestamp.toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'medium'}) : '-';
            // Use Tailwind classes for styling log entries
            return `
                <div class="log-entry px-3 py-2 hover:bg-gray-100 transition duration-150">
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-1">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-sm text-gray-800">${logData.eventType || 'Esemény'}</p>
                            <p class="text-xs text-gray-600 break-words">${logData.details || '-'}</p>
                        </div>
                        <div class="text-right flex-shrink-0 mt-1 sm:mt-0">
                             <p class="text-xs text-gray-500 whitespace-nowrap">${formattedTime}</p>
                             <p class="text-xs text-gray-500 truncate" title="${logData.user || ''}">${logData.user || '-'}</p>
                        </div>
                    </div>
                </div>`;
        }

        // --- Initialization ---
        toggleSlideTypeFields();
        toggleEditSlideTypeFields();
        toggleEmergencyInputFields();

    </script>

</body>
</html>
